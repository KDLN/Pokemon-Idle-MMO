---
phase: 12-party-reordering
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - apps/web/src/components/game/party/LongPressIndicator.tsx
  - apps/web/src/components/game/party/SortablePokemonCard.tsx
  - apps/web/src/components/game/party/SortablePartyGrid.tsx
  - apps/web/src/components/ui/Toast.tsx
autonomous: false

must_haves:
  truths:
    - "Radial progress ring appears during 300ms long-press countdown"
    - "Dragged card has elevated shadow and 1.05x scale"
    - "Target slot shows visual highlight when card hovers over it"
    - "Toast notification appears when save fails and cards revert"
    - "Reordering is visually disabled during battle"
    - "Party slot 1 Pokemon is the one that battles in encounters"
  artifacts:
    - path: "apps/web/src/components/game/party/LongPressIndicator.tsx"
      provides: "SVG radial progress ring component"
      min_lines: 30
    - path: "apps/web/src/components/game/party/SortablePokemonCard.tsx"
      provides: "Updated with long-press indicator and drop zone styles"
      contains: "LongPressIndicator"
    - path: "apps/web/src/components/game/party/SortablePartyGrid.tsx"
      provides: "Updated with error toast on save failure"
      contains: "toast"
  key_links:
    - from: "apps/web/src/components/game/party/SortablePokemonCard.tsx"
      to: "apps/web/src/components/game/party/LongPressIndicator.tsx"
      via: "component import"
      pattern: "import.*LongPressIndicator"
---

<objective>
Add visual polish to drag-and-drop: long-press indicator, drag overlay styling, drop zone highlighting, and error feedback.

Purpose: Provide clear visual feedback during drag interactions per CONTEXT.md design decisions.
Output: Polished drag experience with proper feedback for all interaction states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-party-reordering/12-CONTEXT.md
@.planning/phases/12-party-reordering/12-RESEARCH.md
@.planning/phases/12-party-reordering/12-02-SUMMARY.md

# Key files to modify
@apps/web/src/components/game/party/SortablePokemonCard.tsx
@apps/web/src/components/game/party/SortablePartyGrid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LongPressIndicator component</name>
  <files>apps/web/src/components/game/party/LongPressIndicator.tsx</files>
  <action>
Create new file at `apps/web/src/components/game/party/LongPressIndicator.tsx`:

```typescript
'use client'

interface LongPressIndicatorProps {
  /** Progress value from 0 to 1 */
  progress: number
  /** Size in pixels (default 48) */
  size?: number
  /** Whether to show the indicator */
  visible?: boolean
}

/**
 * Radial progress ring that fills during long-press countdown
 * Shows during the 300ms hold before drag activates
 */
export function LongPressIndicator({
  progress,
  size = 48,
  visible = false,
}: LongPressIndicatorProps) {
  if (!visible || progress <= 0) return null

  const radius = 18
  const circumference = 2 * Math.PI * radius
  const offset = circumference * (1 - Math.min(progress, 1))

  return (
    <div
      className="absolute inset-0 flex items-center justify-center pointer-events-none z-40"
      aria-hidden="true"
    >
      <svg
        width={size}
        height={size}
        viewBox="0 0 40 40"
        className="drop-shadow-lg"
      >
        {/* Background circle */}
        <circle
          cx="20"
          cy="20"
          r={radius}
          fill="none"
          stroke="rgba(0,0,0,0.3)"
          strokeWidth="3"
        />
        {/* Progress circle */}
        <circle
          cx="20"
          cy="20"
          r={radius}
          fill="none"
          stroke="var(--poke-blue, #3B4CCA)"
          strokeWidth="3"
          strokeDasharray={circumference}
          strokeDashoffset={offset}
          strokeLinecap="round"
          transform="rotate(-90 20 20)"
          style={{ transition: 'stroke-dashoffset 50ms linear' }}
        />
      </svg>
    </div>
  )
}
```

This implements the radial progress ring per CONTEXT.md and RESEARCH.md Pattern 5.
  </action>
  <verify>
File exists and TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>LongPressIndicator component created with SVG radial progress ring</done>
</task>

<task type="auto">
  <name>Task 2: Add long-press indicator and drop zone styles to SortablePokemonCard</name>
  <files>apps/web/src/components/game/party/SortablePokemonCard.tsx</files>
  <action>
Update SortablePokemonCard.tsx to add visual feedback:

1. Add imports at top:
   ```typescript
   import { useState, useEffect, useRef } from 'react'
   import { LongPressIndicator } from './LongPressIndicator'
   ```

2. Add long-press detection state and effect inside the component:
   ```typescript
   // Long-press progress tracking (for visual indicator only)
   const [longPressProgress, setLongPressProgress] = useState(0)
   const longPressTimerRef = useRef<NodeJS.Timeout | null>(null)
   const longPressStartRef = useRef<number | null>(null)

   // Track long-press progress for visual feedback
   useEffect(() => {
     if (disabled) return

     const handleTouchStart = () => {
       longPressStartRef.current = Date.now()
       // Animate progress over 300ms
       const animate = () => {
         if (!longPressStartRef.current) return
         const elapsed = Date.now() - longPressStartRef.current
         const progress = Math.min(elapsed / 300, 1)
         setLongPressProgress(progress)
         if (progress < 1) {
           longPressTimerRef.current = setTimeout(animate, 16) // ~60fps
         }
       }
       animate()
     }

     const handleTouchEnd = () => {
       longPressStartRef.current = null
       if (longPressTimerRef.current) {
         clearTimeout(longPressTimerRef.current)
       }
       setLongPressProgress(0)
     }

     const node = document.getElementById(`sortable-card-${pokemon.id}`)
     if (node) {
       node.addEventListener('touchstart', handleTouchStart, { passive: true })
       node.addEventListener('touchend', handleTouchEnd)
       node.addEventListener('touchcancel', handleTouchEnd)
     }

     return () => {
       if (node) {
         node.removeEventListener('touchstart', handleTouchStart)
         node.removeEventListener('touchend', handleTouchEnd)
         node.removeEventListener('touchcancel', handleTouchEnd)
       }
       if (longPressTimerRef.current) {
         clearTimeout(longPressTimerRef.current)
       }
     }
   }, [pokemon.id, disabled])

   // Reset progress when drag starts
   useEffect(() => {
     if (isDragging) {
       setLongPressProgress(0)
       longPressStartRef.current = null
     }
   }, [isDragging])
   ```

3. Update the wrapper div to include the indicator and isOver styles:
   ```typescript
   const {
     attributes,
     listeners,
     setNodeRef,
     transform,
     transition,
     isDragging,
     isOver,  // Add this
   } = useSortable({
     id: pokemon.id,
     disabled,
   })
   ```

4. Update the returned JSX:
   ```tsx
   return (
     <div
       id={`sortable-card-${pokemon.id}`}
       ref={setNodeRef}
       style={style}
       {...attributes}
       {...listeners}
       className={cn(
         'h-full touch-manipulation select-none relative',
         isDragging && 'opacity-50',
         // Drop zone highlight (per CONTEXT.md)
         isOver && !isDragging && 'ring-2 ring-[#3B4CCA] ring-offset-2 ring-offset-[#0f0f1a] rounded-xl',
         disabled && 'cursor-not-allowed opacity-70'
       )}
     >
       {/* Long-press indicator */}
       <LongPressIndicator
         progress={longPressProgress}
         visible={longPressProgress > 0 && !isDragging}
       />

       <PokemonCard
         pokemon={pokemon}
         showXP
         onClick={disabled ? undefined : onClick}
         canRemove={canRemove}
         onRemove={onRemove}
         onUsePotion={onUsePotion}
         hasPotions={hasPotions}
       />
     </div>
   )
   ```

Key visual feedback:
- Long-press indicator animates during 300ms hold
- Drop zone gets blue ring when another card hovers over it
- Source card is semi-transparent while dragging
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Test in browser with touch simulation - progress ring should appear during hold
  </verify>
  <done>SortablePokemonCard has long-press indicator and drop zone highlighting</done>
</task>

<task type="auto">
  <name>Task 3: Add error toast and battle-disabled visual state</name>
  <files>apps/web/src/components/game/party/SortablePartyGrid.tsx</files>
  <action>
Update SortablePartyGrid.tsx to add error feedback and battle-disabled state:

1. Add toast import (check if project uses sonner or custom toast):
   First check existing toast usage:
   ```bash
   grep -r "toast\." apps/web/src --include="*.tsx" | head -5
   ```

   If using a toast system, import it. If not, we'll add a simple alert for now.

2. Add error handling with toast/alert in handleDragEnd:
   ```typescript
   const handleDragEnd = useCallback((event: DragEndEvent) => {
     const { active, over } = event
     setActiveId(null)

     if (!over || active.id === over.id) {
       setPreviousParty(null)
       return
     }

     const oldIndex = party.findIndex(p => p?.id === active.id)
     const newIndex = party.findIndex(p => p?.id === over.id)

     if (oldIndex === -1 || newIndex === -1) {
       setPreviousParty(null)
       return
     }

     const newParty = arraySwap([...party], oldIndex, newIndex)
     setParty(newParty.filter((p): p is Pokemon => p !== null))

     const order = newParty.map(p => p?.id ?? null)
     const sent = gameSocket.reorderParty(order)

     if (!sent && previousParty) {
       // Rollback and show error (per CONTEXT.md)
       setParty(previousParty.filter((p): p is Pokemon => p !== null))
       // Use alert for now - can upgrade to toast later
       alert('Failed to save party order. Please try again.')
     }

     setPreviousParty(null)
   }, [party, setParty, previousParty])
   ```

3. Add visual indicator when drag is disabled:
   ```typescript
   // Add this before the return statement
   const showDisabledOverlay = isDragDisabled

   // In the JSX, add a visual overlay when disabled:
   return (
     <DndContext ...>
       <SortableContext ...>
         <div
           className={cn(
             "grid grid-cols-2 gap-2 auto-rows-fr relative",
             showDisabledOverlay && "pointer-events-none"
           )}
           role="list"
           aria-label="Pokemon party"
         >
           {/* Existing party.map content */}

           {/* Battle-disabled overlay */}
           {showDisabledOverlay && (
             <div
               className="absolute inset-0 bg-black/20 rounded-lg flex items-center justify-center z-30"
               aria-label="Party reordering disabled during battle"
             >
               <span className="text-xs text-white/70 bg-black/50 px-2 py-1 rounded">
                 Reordering disabled during battle
               </span>
             </div>
           )}
         </div>
       </SortableContext>
       ...
     </DndContext>
   )
   ```

4. Add WebSocket error listener for server-side failures:
   ```typescript
   // Add at top of component
   const [error, setError] = useState<string | null>(null)

   // Add useEffect to listen for errors
   useEffect(() => {
     // Listen for error messages from server
     const handleMessage = (event: MessageEvent) => {
       try {
         const msg = JSON.parse(event.data)
         if (msg.type === 'error' && msg.payload?.message?.includes('reorder')) {
           // Server rejected reorder - rollback
           if (previousParty) {
             setParty(previousParty.filter((p): p is Pokemon => p !== null))
             setPreviousParty(null)
           }
           setError('Failed to save party order')
           setTimeout(() => setError(null), 3000)
         }
       } catch {
         // Ignore parse errors
       }
     }

     // Note: This would need access to the WebSocket instance
     // For simplicity, we rely on the boolean return from reorderParty
     // and the server's error response handled elsewhere

     return () => {}
   }, [previousParty, setParty])
   ```

   Since direct WebSocket access is complex, keep the simpler approach using the boolean return from gameSocket.reorderParty().
  </action>
  <verify>
1. TypeScript compiles: `cd apps/web && npx tsc --noEmit`
2. Test error scenario by disconnecting network and attempting drag
3. Start a battle and verify overlay appears
  </verify>
  <done>Error toast appears on save failure, battle overlay shows when reordering disabled</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete drag-and-drop party reordering with visual feedback:
1. Long-press indicator (radial progress ring during 300ms hold)
2. Drag overlay (lifted card with shadow)
3. Drop zone highlighting (blue ring on hover target)
4. Battle-disabled state (overlay message)
5. Error feedback (alert/toast on save failure)
6. Party order affects battle (slot 1 Pokemon battles first)
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd apps/web && npm run dev` and game server: `cd apps/game-server && npm run dev`
2. Open browser to http://localhost:3000
3. Log in and navigate to a zone with your Pokemon party visible

**Test mouse drag:**
- Click and drag a Pokemon card to another slot
- Verify cards swap positions
- Verify order persists after page refresh

**Test touch drag (use browser dev tools touch simulation):**
- Long-press (hold for ~300ms) on a Pokemon card
- Watch for radial progress ring to appear
- Continue holding until drag activates
- Drag to another slot, verify swap

**Test visual feedback:**
- While dragging, source card should be semi-transparent
- Dragged card (overlay) should be slightly larger with shadow
- Hover over another card's slot - should show blue ring highlight

**Test battle state:**
- Trigger an encounter (wait for wild Pokemon to appear)
- Verify overlay message "Reordering disabled during battle"
- Verify drag does not work during battle
- After battle ends, verify drag works again

**Test error handling:**
- Open network tab in dev tools
- Block WebSocket or go offline
- Attempt to drag/reorder
- Verify error message appears
- Verify cards revert to original positions

**Test party order affects battle (UI-08):**
- Note which Pokemon is currently in slot 1 (top-left of party grid)
- Drag a DIFFERENT Pokemon to slot 1 (swap with the current slot 1 Pokemon)
- Wait for or trigger an encounter
- Verify that the NEW slot 1 Pokemon is the one battling (shown in battle UI)
- This confirms party_slot 1 determines which Pokemon participates in battle
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Long-press indicator visible during touch hold
2. Drag overlay shows lifted appearance
3. Drop zones highlight on hover
4. Battle overlay prevents dragging
5. Error feedback shown on save failure
6. Slot 1 Pokemon is the one that battles in encounters
</verification>

<success_criteria>
- Radial progress ring animates during 300ms long-press (touch)
- Dragged card has scale 1.05x and elevated shadow
- Target slot shows blue ring highlight when hovered
- Overlay message shows during battle
- Error alert/toast appears when save fails
- UI-06, UI-07, UI-08 requirements met (drag reorder, persistence, affects battle order)
- Reordering party changes which Pokemon battles (slot 1 = active battler)
</success_criteria>

<output>
After completion, create `.planning/phases/12-party-reordering/12-03-SUMMARY.md`
</output>
