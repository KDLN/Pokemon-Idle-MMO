---
phase: 08-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/030_fix_quest_details.sql
  - apps/game-server/src/db.ts
autonomous: true

must_haves:
  truths:
    - "User clicks 'Show contributors' on any guild quest and sees contributor list without error"
    - "Contributor list displays usernames and contribution amounts sorted by rank"
    - "Contributor list loads within 2 seconds of button click"
  artifacts:
    - path: "supabase/migrations/030_fix_quest_details.sql"
      provides: "get_quest_details RPC function"
      contains: "CREATE.*FUNCTION.*get_quest_details"
  key_links:
    - from: "apps/game-server/src/db.ts"
      to: "supabase.rpc('get_quest_details')"
      via: "RPC call in getQuestDetails function"
      pattern: "supabase\\.rpc\\('get_quest_details'"
---

<objective>
Fix the "Show contributors" button error on guild quests by creating the missing `get_quest_details` database function.

Purpose: The QuestCard component calls `gameSocket.getQuestDetails(quest.id)` when user clicks "Show contributors", which triggers `supabase.rpc('get_quest_details', ...)` on the server. This RPC function was never created in the database migrations, causing the query to fail.

Output: Working contributor display for all guild quests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant existing code
@apps/game-server/src/db.ts (lines 3459-3474 - getQuestDetails function)
@apps/game-server/src/hub.ts (lines 4319-4346 - handleGetQuestDetails handler)
@apps/web/src/components/game/guild/QuestCard.tsx (lines 49-55 - handleToggleLeaderboard)
@supabase/migrations/027_guild_quests.sql (guild_quests and guild_quest_contributions tables)
@packages/shared/src/types/guild.ts (GuildQuestDetailed, QuestContribution interfaces)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create get_quest_details SQL function</name>
  <files>supabase/migrations/030_fix_quest_details.sql</files>
  <action>
Create a new migration file `supabase/migrations/030_fix_quest_details.sql` with:

```sql
-- ============================================
-- FIX: Add missing get_quest_details function
-- BUG-01: "Show contributors" button error
-- ============================================

CREATE OR REPLACE FUNCTION get_quest_details(p_quest_id UUID, p_player_id UUID)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_quest RECORD;
  v_guild_id UUID;
  v_contributions JSON;
  v_my_contribution INT;
BEGIN
  -- Get quest and verify player is in the same guild
  SELECT gq.*, gm.guild_id INTO v_quest, v_guild_id
  FROM guild_quests gq
  JOIN guild_members gm ON gm.guild_id = gq.guild_id AND gm.player_id = p_player_id
  WHERE gq.id = p_quest_id;

  IF v_quest IS NULL THEN
    RETURN NULL;
  END IF;

  -- Get my contribution
  SELECT COALESCE(contribution, 0) INTO v_my_contribution
  FROM guild_quest_contributions
  WHERE quest_id = p_quest_id AND player_id = p_player_id;

  -- Get all contributions with rank
  SELECT json_agg(contrib ORDER BY contrib.contribution DESC)
  INTO v_contributions
  FROM (
    SELECT
      c.player_id,
      p.username,
      c.contribution,
      ROW_NUMBER() OVER (ORDER BY c.contribution DESC) as rank
    FROM guild_quest_contributions c
    JOIN players p ON p.id = c.player_id
    WHERE c.quest_id = p_quest_id AND c.contribution > 0
    ORDER BY c.contribution DESC
  ) contrib;

  -- Return quest details with contributions array
  RETURN json_build_object(
    'id', v_quest.id,
    'quest_type', v_quest.quest_type::TEXT,
    'period', v_quest.period::TEXT,
    'target_count', v_quest.target_count,
    'current_progress', v_quest.current_progress,
    'reward_currency', v_quest.reward_currency,
    'reward_guild_points', v_quest.reward_guild_points,
    'reward_item_id', v_quest.reward_item_id,
    'reward_item_quantity', v_quest.reward_item_quantity,
    'type_filter', v_quest.type_filter,
    'description', v_quest.description,
    'is_completed', v_quest.is_completed,
    'completed_at', v_quest.completed_at,
    'my_contribution', COALESCE(v_my_contribution, 0),
    'contributions', COALESCE(v_contributions, '[]'::JSON)
  );
END;
$$;
```

The function:
1. Verifies player is a member of the guild that owns the quest
2. Gets the quest details from guild_quests table
3. Gets player's own contribution
4. Gets all contributions with usernames and ranks
5. Returns GuildQuestDetailed structure matching the TypeScript interface
  </action>
  <verify>
1. File exists: `ls supabase/migrations/030_fix_quest_details.sql`
2. File contains the function: `grep -c "CREATE.*FUNCTION.*get_quest_details" supabase/migrations/030_fix_quest_details.sql` returns 1
3. File syntax valid (no obvious SQL errors)
  </verify>
  <done>Migration file 030_fix_quest_details.sql exists with get_quest_details function that returns quest with contributions array matching GuildQuestDetailed interface</done>
</task>

<task type="auto">
  <name>Task 2: Verify db.ts getQuestDetails matches expected signature</name>
  <files>apps/game-server/src/db.ts</files>
  <action>
Review the existing getQuestDetails function in db.ts (lines 3459-3474):

```typescript
export async function getQuestDetails(
  questId: string,
  playerId: string
): Promise<GuildQuestDetailed | null> {
  const { data, error } = await supabase.rpc('get_quest_details', {
    p_quest_id: questId,
    p_player_id: playerId
  })

  if (error) {
    console.error('Error getting quest details:', error)
    return null
  }

  return data
}
```

This function is already correct - it:
1. Accepts questId and playerId
2. Calls the RPC with p_quest_id and p_player_id parameters
3. Returns GuildQuestDetailed | null

No changes needed to db.ts. The bug was solely the missing SQL function.
  </action>
  <verify>
Confirm db.ts already has correct implementation:
`grep -A 15 "export async function getQuestDetails" apps/game-server/src/db.ts`
Should show the function calling `supabase.rpc('get_quest_details', { p_quest_id: questId, p_player_id: playerId })`
  </verify>
  <done>db.ts getQuestDetails function verified to correctly call the RPC with expected parameters</done>
</task>

</tasks>

<verification>
After applying migration to database:
1. Open game with a character in a guild
2. Navigate to Guild Quests modal
3. Click "Show contributors" on any quest
4. Contributor list should display without error
5. Contributors should show username and contribution amount
6. If no contributors, should show "No contributions yet" message
</verification>

<success_criteria>
1. Migration file 030_fix_quest_details.sql exists with valid SQL
2. get_quest_details function returns proper JSON structure
3. No runtime errors when clicking "Show contributors" (after migration applied)
4. Contributors display with username and contribution values
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fixes/08-01-SUMMARY.md`
</output>
