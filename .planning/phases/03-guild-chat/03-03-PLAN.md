---
phase: 03-guild-chat
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/src/types/chat.ts
  - apps/web/src/lib/ws/gameSocket.ts
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/game/social/ChatSidebar.tsx
  - apps/web/src/components/game/social/ChatMessage.tsx
autonomous: true

must_haves:
  truths:
    - "Guild channel shows messages only when player is in a guild"
    - "Guild messages display role badges (Leader/Officer)"
    - "Guild messages load history on channel switch"
    - "New messages appear in real-time"
    - "Input is enabled for guild channel when in a guild"
  artifacts:
    - path: "apps/web/src/types/chat.ts"
      provides: "GuildChatMessageData type extension"
      contains: "role.*GuildRole"
    - path: "apps/web/src/lib/ws/gameSocket.ts"
      provides: "guild_chat_message and guild_chat_history handlers"
      contains: "guild_chat_message"
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "Guild chat state management"
      contains: "guildChatMessages"
    - path: "apps/web/src/components/game/social/ChatSidebar.tsx"
      provides: "Guild channel integration with history loading"
      contains: "get_guild_chat_history"
    - path: "apps/web/src/components/game/social/ChatMessage.tsx"
      provides: "Role badge display for guild messages"
      contains: "RoleBadge"
  key_links:
    - from: "gameSocket.ts guild_chat_message handler"
      to: "gameStore addGuildChatMessage"
      via: "store action call"
      pattern: "addGuildChatMessage"
    - from: "ChatSidebar guild channel"
      to: "gameSocket get_guild_chat_history"
      via: "channel switch effect"
      pattern: "sendMessage.*get_guild_chat_history"
---

<objective>
Integrate guild chat into the frontend with role badges and real-time updates.

Purpose: Enable the existing guild chat tab in the UI to actually send/receive messages. The tab already exists in ChatTabs.tsx - this plan wires it to the backend and adds role badge display.

Output: Working guild chat in the frontend with role badges for Leader/Officer
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-guild-chat/03-RESEARCH.md
@.planning/phases/03-guild-chat/03-01-SUMMARY.md
@.planning/phases/03-guild-chat/03-02-SUMMARY.md

# Existing patterns:
@apps/web/src/components/game/social/ChatSidebar.tsx
@apps/web/src/components/game/social/ChatMessage.tsx
@apps/web/src/lib/ws/gameSocket.ts
@apps/web/src/stores/gameStore.ts
@apps/web/src/types/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild chat types and state management</name>
  <files>apps/web/src/types/chat.ts, apps/web/src/stores/gameStore.ts</files>
  <action>
**1. Update apps/web/src/types/chat.ts:**

Add GuildRole import and extend ChatMessageData:

```typescript
import type { GuildRole } from '@pokemon-idle/shared'

// Add to existing ChatMessageData or create new interface
export interface GuildChatMessageData extends ChatMessageData {
  role?: GuildRole
}
```

**2. Update apps/web/src/stores/gameStore.ts:**

Add guild chat state and actions to the store:

a) Add to state type:
```typescript
// In GameState interface, add:
guildChatMessages: GuildChatMessageData[]
guildChatLoaded: boolean
```

b) Add initial state:
```typescript
guildChatMessages: [],
guildChatLoaded: false,
```

c) Add actions:
```typescript
// Add to store actions
addGuildChatMessage: (message: GuildChatMessageData) => void
setGuildChatHistory: (messages: GuildChatMessageData[]) => void
clearGuildChat: () => void
```

d) Implement actions:
```typescript
addGuildChatMessage: (message) =>
  set((state) => ({
    guildChatMessages: [...state.guildChatMessages, message].slice(-100),
  })),

setGuildChatHistory: (messages) =>
  set({
    guildChatMessages: messages,
    guildChatLoaded: true,
  }),

clearGuildChat: () =>
  set({
    guildChatMessages: [],
    guildChatLoaded: false,
  }),
```

e) Clear guild chat when leaving guild (find existing guild leave handler):
```typescript
// In the guild left/kicked handlers, add:
clearGuildChat()
```

Note: Using separate state (not chat.messages['guild']) because guild chat has role data and different lifecycle (cleared on leave, loaded on demand).
  </action>
  <verify>
- GuildChatMessageData type exists with optional role field
- gameStore has guildChatMessages array and guildChatLoaded flag
- addGuildChatMessage, setGuildChatHistory, clearGuildChat actions exist
- Guild chat cleared when player leaves guild
  </verify>
  <done>Guild chat types and state management added</done>
</task>

<task type="auto">
  <name>Task 2: Add WebSocket handlers for guild chat</name>
  <files>apps/web/src/lib/ws/gameSocket.ts</files>
  <action>
Add handlers for guild chat messages in gameSocket.ts:

**1. Add imports:**
```typescript
import type { GuildChatMessage } from '@pokemon-idle/shared'
```

**2. Register handlers in constructor:**
```typescript
// In constructor, add:
this.handlers.set('guild_chat_message', this.handleGuildChatMessage)
this.handlers.set('guild_chat_history', this.handleGuildChatHistory)
```

**3. Add handleGuildChatMessage method:**
```typescript
private handleGuildChatMessage = (payload: { message: GuildChatMessage }) => {
  const { message } = payload
  const store = useGameStore.getState()

  store.addGuildChatMessage({
    id: message.id,
    playerId: message.player_id,
    playerName: message.player_name,
    channel: 'guild',
    content: message.content,
    createdAt: new Date(message.created_at),
    isSystem: false,
    role: message.role,
  })
}
```

**4. Add handleGuildChatHistory method:**
```typescript
private handleGuildChatHistory = (payload: { messages: GuildChatMessage[] }) => {
  const { messages } = payload
  const store = useGameStore.getState()

  const chatMessages = messages.map((msg) => ({
    id: msg.id,
    playerId: msg.player_id,
    playerName: msg.player_name,
    channel: 'guild' as const,
    content: msg.content,
    createdAt: new Date(msg.created_at),
    isSystem: false,
    role: msg.role,
  }))

  store.setGuildChatHistory(chatMessages)
}
```

**5. Add send method:**
```typescript
// Add public method for sending guild chat
sendGuildChatMessage(content: string) {
  this.sendMessage('guild_chat_message', { content })
}

getGuildChatHistory() {
  this.sendMessage('get_guild_chat_history', {})
}
```

Note: The handlers convert server types (snake_case) to client types (camelCase) following existing chat message patterns.
  </action>
  <verify>
- guild_chat_message handler registered and converts payload
- guild_chat_history handler registered and sets state
- sendGuildChatMessage and getGuildChatHistory methods exist
- Handlers use correct type conversion (snake_case to camelCase)
  </verify>
  <done>WebSocket handlers added for guild chat</done>
</task>

<task type="auto">
  <name>Task 3: Update ChatSidebar and ChatMessage for guild chat</name>
  <files>apps/web/src/components/game/social/ChatSidebar.tsx, apps/web/src/components/game/social/ChatMessage.tsx</files>
  <action>
**1. Update ChatSidebar.tsx:**

a) Add imports:
```typescript
import type { GuildChatMessageData } from '@/types/chat'
```

b) Add guild state selectors:
```typescript
const guild = useGameStore((state) => state.guild)
const guildChatMessages = useGameStore((state) => state.guildChatMessages)
const guildChatLoaded = useGameStore((state) => state.guildChatLoaded)
```

c) Load guild chat history on channel switch (add useEffect):
```typescript
// Load guild chat history when switching to guild channel
useEffect(() => {
  if (activeChannel === 'guild' && guild && !guildChatLoaded) {
    gameSocket.getGuildChatHistory()
  }
}, [activeChannel, guild, guildChatLoaded])
```

d) Update filteredMessages to handle guild channel:
```typescript
// In filteredMessages useMemo, update the logic:
if (activeChannel === 'guild') {
  // If not in guild, show helpful message
  if (!guild) {
    return [{
      id: 'no-guild',
      playerId: 'system',
      playerName: 'System',
      channel: 'guild',
      content: 'Join a guild to use guild chat!',
      createdAt: new Date(),
      isSystem: true,
    }]
  }
  return guildChatMessages
}
```

e) Update handleSend to route guild messages:
```typescript
// In handleSend function, update the check:
if (activeChannel === 'whisper') {
  return
}
if (activeChannel === 'guild') {
  if (!guild) return
  gameSocket.sendGuildChatMessage(content)
  return
}
gameSocket.sendChatMessage(activeChannel, content)
```

**2. Update ChatMessage.tsx:**

a) Add RoleBadge component (inline or separate):
```typescript
import type { GuildRole } from '@pokemon-idle/shared'

// Role badge configuration
const ROLE_CONFIG: Record<GuildRole, { label: string; color: string; bg: string }> = {
  leader: { label: 'Leader', color: 'text-yellow-400', bg: 'bg-yellow-400/20' },
  officer: { label: 'Officer', color: 'text-blue-400', bg: 'bg-blue-400/20' },
  member: { label: '', color: '', bg: '' }, // No badge for regular members
}

function RoleBadge({ role }: { role: GuildRole }) {
  const config = ROLE_CONFIG[role]
  if (!config.label) return null

  return (
    <span className={`text-[10px] px-1 rounded ${config.color} ${config.bg} ml-1`}>
      {config.label}
    </span>
  )
}
```

b) Update ChatMessageProps to accept role:
```typescript
interface ChatMessageProps {
  message: ChatMessageData & { role?: GuildRole }
}
```

c) Display role badge after player name for guild channel:
```typescript
// In the render, after player name:
{message.channel === 'guild' && message.role && (
  <RoleBadge role={message.role} />
)}
```

The badge appears inline with the player name: "PlayerName [Leader]" or "PlayerName [Officer]"
  </action>
  <verify>
- ChatSidebar loads guild chat history on channel switch
- ChatSidebar shows helpful message when not in guild
- ChatSidebar routes guild messages via sendGuildChatMessage
- ChatMessage displays RoleBadge for leader/officer on guild channel
- Regular members have no badge (requirement: display role badge)
  </verify>
  <done>Frontend components updated for guild chat with role badges</done>
</task>

</tasks>

<verification>
- [ ] Guild chat types added with role field
- [ ] Store manages guild chat state separately from other channels
- [ ] WebSocket handlers convert and store guild messages
- [ ] History loads when switching to guild channel
- [ ] Messages sent via dedicated sendGuildChatMessage method
- [ ] Role badges appear for Leader and Officer roles
- [ ] Non-guild members see helpful message on guild channel
</verification>

<success_criteria>
- Guild tab (already exists in UI) now functional
- Messages display player name + role badge (yellow for Leader, blue for Officer)
- New messages appear immediately for all online guild members
- Switching to guild channel loads last 100 messages
- Leaving guild clears chat history
</success_criteria>

<output>
After completion, create `.planning/phases/03-guild-chat/03-03-SUMMARY.md`
</output>
