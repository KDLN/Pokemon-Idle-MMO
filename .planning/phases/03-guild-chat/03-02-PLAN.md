---
phase: 03-guild-chat
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/shared/src/types/guild.ts
  - apps/game-server/src/db.ts
  - apps/game-server/src/hub.ts
autonomous: true

must_haves:
  truths:
    - "Guild members can send chat messages"
    - "Guild members receive messages in real-time"
    - "Guild members can load message history"
    - "Non-members cannot send to guild chat"
    - "Messages include player name and role for display"
  artifacts:
    - path: "packages/shared/src/types/guild.ts"
      provides: "GuildChatMessage type and WebSocket payloads"
      contains: "GuildChatMessagePayload"
    - path: "apps/game-server/src/db.ts"
      provides: "saveGuildChatMessage and getGuildChatHistory functions"
      contains: "saveGuildChatMessage"
    - path: "apps/game-server/src/hub.ts"
      provides: "handleGuildChatMessage and handleGetGuildChatHistory handlers"
      contains: "guild_chat_message"
  key_links:
    - from: "hub.ts handleGuildChatMessage"
      to: "db.ts saveGuildChatMessage"
      via: "function call"
      pattern: "saveGuildChatMessage\\("
    - from: "hub.ts handleGuildChatMessage"
      to: "broadcastToGuild"
      via: "targeted broadcast"
      pattern: "broadcastToGuild\\("
---

<objective>
Add game server handlers for guild chat messaging with real-time broadcast.

Purpose: Enable guild members to send messages that persist to the database and broadcast to all online guild members using the existing `broadcastToGuild()` infrastructure.

Output: Working backend for guild chat (types, db functions, handlers)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-guild-chat/03-RESEARCH.md
@.planning/phases/03-guild-chat/03-01-SUMMARY.md

# Existing patterns:
@apps/game-server/src/hub.ts (handleChatMessage, broadcastToGuild patterns)
@apps/game-server/src/db.ts (saveChatMessage, getRecentChatMessages patterns)
@packages/shared/src/types/guild.ts (existing guild types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild chat types to shared package</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Add the following types at the end of `packages/shared/src/types/guild.ts`:

```typescript
// ================================
// Guild Chat Types
// ================================

// Guild chat message (includes player info and role for display)
export interface GuildChatMessage {
  id: string
  guild_id: string
  player_id: string
  player_name: string
  role: GuildRole
  content: string
  created_at: string
}

// Client -> Server payloads

export interface SendGuildChatMessagePayload {
  content: string
}

export interface GetGuildChatHistoryPayload {
  // Empty - just requests history
}

// Server -> Client payloads

export interface GuildChatMessagePayload {
  message: GuildChatMessage
}

export interface GuildChatHistoryPayload {
  messages: GuildChatMessage[]
}
```

These types follow the existing pattern where:
- `{Action}Payload` is for client -> server
- `{Event}Payload` is for server -> client
- Message includes denormalized player_name and role for display
  </action>
  <verify>
- File contains `GuildChatMessage` interface
- File contains `SendGuildChatMessagePayload` interface
- File contains `GuildChatHistoryPayload` interface
- Types use existing `GuildRole` type for role field
  </verify>
  <done>Guild chat types added to shared package</done>
</task>

<task type="auto">
  <name>Task 2: Add guild chat database functions</name>
  <files>apps/game-server/src/db.ts</files>
  <action>
Add two functions to `db.ts` following the pattern from `saveChatMessage` and `getRecentChatMessages`:

1. **Add import at top** (if not already present):
```typescript
import type { GuildRole, GuildChatMessage } from '@pokemon-idle/shared'
```

2. **Add saveGuildChatMessage function:**
```typescript
export async function saveGuildChatMessage(
  guildId: string,
  playerId: string,
  playerName: string,
  role: GuildRole,
  content: string
): Promise<GuildChatMessage | null> {
  const { data, error } = await getSupabase()
    .from('guild_messages')
    .insert({
      guild_id: guildId,
      player_id: playerId,
      content,
    })
    .select('id, guild_id, player_id, content, created_at')
    .single()

  if (error || !data) {
    console.error('Failed to save guild chat message:', error)
    return null
  }

  // Return with denormalized player info (we have it from session)
  return {
    id: data.id,
    guild_id: data.guild_id,
    player_id: data.player_id,
    player_name: playerName,
    role: role,
    content: data.content,
    created_at: data.created_at,
  }
}
```

3. **Add getGuildChatHistory function:**
```typescript
export async function getGuildChatHistory(
  guildId: string,
  limit = 100
): Promise<GuildChatMessage[]> {
  const { data, error } = await getSupabase()
    .from('guild_messages')
    .select(`
      id,
      guild_id,
      player_id,
      content,
      created_at,
      player:players!inner(username),
      member:guild_members!inner(role)
    `)
    .eq('guild_id', guildId)
    .order('created_at', { ascending: false })
    .limit(limit)

  if (error) {
    console.error('Failed to load guild chat history:', error)
    return []
  }

  // Map and reverse to get chronological order
  return (data || []).map(row => ({
    id: row.id,
    guild_id: row.guild_id,
    player_id: row.player_id,
    player_name: (row.player as { username: string })?.username || 'Unknown',
    role: ((row.member as { role: GuildRole })?.role || 'member') as GuildRole,
    content: row.content,
    created_at: row.created_at,
  })).reverse()
}
```

Note: The history function joins players and guild_members to get username and role. The save function uses session data directly (avoids extra queries).
  </action>
  <verify>
- `saveGuildChatMessage` function exists with correct signature
- `getGuildChatHistory` function exists with correct signature
- Both functions use `getSupabase()` following codebase pattern
- History query joins players and guild_members tables
- History returns messages in chronological order (oldest first)
  </verify>
  <done>Guild chat database functions added to db.ts</done>
</task>

<task type="auto">
  <name>Task 3: Add guild chat WebSocket handlers</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Add guild chat handlers to hub.ts following the existing `handleChatMessage` pattern:

1. **Add import** (update existing guild imports):
```typescript
import type {
  // ... existing guild imports ...
  GuildChatMessage,
  SendGuildChatMessagePayload,
  GuildChatHistoryPayload,
} from '@pokemon-idle/shared'
```

2. **Add db function imports:**
```typescript
import { saveGuildChatMessage, getGuildChatHistory } from './db'
```

3. **Add cases in the message switch statement** (find existing guild handlers like 'create_guild'):
```typescript
case 'guild_chat_message':
  this.handleGuildChatMessage(client, payload as SendGuildChatMessagePayload)
  break
case 'get_guild_chat_history':
  this.handleGetGuildChatHistory(client)
  break
```

4. **Add handleGuildChatMessage method** (near other guild handlers):
```typescript
private async handleGuildChatMessage(client: Client, payload: SendGuildChatMessagePayload) {
  if (!client.session) return

  // Validate guild membership (from session)
  if (!client.session.guild) {
    this.sendError(client, 'You are not in a guild')
    return
  }

  const trimmedContent = (payload.content ?? '').trim()
  if (!trimmedContent) {
    this.sendError(client, 'Message cannot be empty')
    return
  }

  const safeContent = trimmedContent.slice(0, MAX_CHAT_LENGTH)

  // Save to database with player info from session
  const message = await saveGuildChatMessage(
    client.session.guild.id,
    client.session.player.id,
    client.session.player.username,
    client.session.guild.role,
    safeContent
  )

  if (!message) {
    this.sendError(client, 'Unable to send message')
    return
  }

  // Broadcast to all online guild members
  this.broadcastToGuild(client.session.guild.id, 'guild_chat_message', { message })
}
```

5. **Add handleGetGuildChatHistory method:**
```typescript
private async handleGetGuildChatHistory(client: Client) {
  if (!client.session) return

  if (!client.session.guild) {
    this.sendError(client, 'You are not in a guild')
    return
  }

  const messages = await getGuildChatHistory(client.session.guild.id, 100)
  this.send(client, 'guild_chat_history', { messages })
}
```

Key patterns followed:
- Fire-and-forget (no await in switch case)
- Session-based membership check (no DB query)
- Uses existing `broadcastToGuild()` for real-time
- Uses existing `MAX_CHAT_LENGTH` for content truncation
- Uses existing `sendError()` for error handling
  </action>
  <verify>
- Switch cases added for 'guild_chat_message' and 'get_guild_chat_history'
- `handleGuildChatMessage` validates guild membership via session
- `handleGuildChatMessage` uses `broadcastToGuild()` for message delivery
- `handleGetGuildChatHistory` limits to 100 messages (per requirement)
- Both handlers check `client.session.guild` before processing
  </verify>
  <done>Guild chat WebSocket handlers added to hub.ts</done>
</task>

</tasks>

<verification>
- [ ] GuildChatMessage type exists in shared package
- [ ] saveGuildChatMessage saves to guild_messages table
- [ ] getGuildChatHistory returns last 100 messages in chronological order
- [ ] guild_chat_message handler validates membership and broadcasts
- [ ] get_guild_chat_history handler returns history to requester only
- [ ] Non-members receive error when trying to send/get history
</verification>

<success_criteria>
- Guild chat types exported from @pokemon-idle/shared
- Database functions work with guild_messages table
- WebSocket handlers follow existing fire-and-forget pattern
- broadcastToGuild used for real-time message delivery
- Session-based membership checks (no extra DB queries)
</success_criteria>

<output>
After completion, create `.planning/phases/03-guild-chat/03-02-SUMMARY.md`
</output>
