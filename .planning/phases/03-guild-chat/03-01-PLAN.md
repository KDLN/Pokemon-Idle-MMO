---
phase: 03-guild-chat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/025_guild_messages.sql
autonomous: true

must_haves:
  truths:
    - "Guild messages table exists with proper schema"
    - "Non-members cannot query guild messages"
    - "Members can only see their own guild's messages"
    - "Messages are indexed for efficient retrieval"
  artifacts:
    - path: "supabase/migrations/025_guild_messages.sql"
      provides: "Guild messages table, indexes, RLS policies"
      contains: "CREATE TABLE IF NOT EXISTS guild_messages"
  key_links:
    - from: "guild_messages.guild_id"
      to: "guilds.id"
      via: "FOREIGN KEY with CASCADE DELETE"
      pattern: "REFERENCES guilds\\(id\\) ON DELETE CASCADE"
    - from: "guild_messages.player_id"
      to: "players.id"
      via: "FOREIGN KEY with CASCADE DELETE"
      pattern: "REFERENCES players\\(id\\) ON DELETE CASCADE"
---

<objective>
Create the database schema for guild chat messages with proper RLS isolation.

Purpose: Establish the persistence layer for guild chat. Using a dedicated table (not the existing chat_messages) provides cleaner RLS policies and proper isolation between guilds.

Output: Migration file creating guild_messages table with indexes and RLS policies
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-guild-chat/03-RESEARCH.md

# Existing patterns to follow:
@supabase/migrations/004_chat_and_progression.sql (chat_messages pattern)
@supabase/migrations/022_guilds.sql (guild_members RLS pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guild_messages migration</name>
  <files>supabase/migrations/025_guild_messages.sql</files>
  <action>
Create migration file `025_guild_messages.sql` with:

1. **Table Definition:**
```sql
CREATE TABLE IF NOT EXISTS guild_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE,
  player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE,
  content TEXT NOT NULL CHECK (char_length(content) BETWEEN 1 AND 280),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

2. **Indexes for Performance:**
```sql
-- Primary query: get last N messages for a guild, ordered by time
CREATE INDEX idx_guild_messages_guild_time
  ON guild_messages(guild_id, created_at DESC);

-- Secondary: lookup by player (for audit/history)
CREATE INDEX idx_guild_messages_player
  ON guild_messages(player_id);
```

3. **Enable RLS:**
```sql
ALTER TABLE guild_messages ENABLE ROW LEVEL SECURITY;
```

4. **RLS Policies:**

SELECT policy - members can view their own guild's messages:
```sql
CREATE POLICY "guild_messages_select_policy"
  ON guild_messages FOR SELECT
  USING (
    guild_id IN (
      SELECT gm.guild_id FROM guild_members gm
      JOIN players p ON p.id = gm.player_id
      WHERE p.user_id = auth.uid()
    )
  );
```

INSERT policy - members can insert to their own guild only:
```sql
CREATE POLICY "guild_messages_insert_policy"
  ON guild_messages FOR INSERT
  WITH CHECK (
    guild_id IN (
      SELECT gm.guild_id FROM guild_members gm
      JOIN players p ON p.id = gm.player_id
      WHERE p.user_id = auth.uid()
    )
    AND
    player_id IN (
      SELECT id FROM players WHERE user_id = auth.uid()
    )
  );
```

Note: No UPDATE or DELETE policies - messages are immutable once sent. Guild disbanding cascades deletes via FK.

5. **Add comment:**
```sql
COMMENT ON TABLE guild_messages IS 'Guild chat messages with RLS isolation per guild';
```
  </action>
  <verify>
- File exists at `supabase/migrations/025_guild_messages.sql`
- Contains CREATE TABLE guild_messages with guild_id, player_id, content, created_at
- Contains CASCADE DELETE on both foreign keys
- Contains both indexes (guild_time and player)
- Contains RLS ENABLE and both policies (select and insert)
  </verify>
  <done>
- Migration file created with table, indexes, and RLS policies
- Ready to apply via Supabase Dashboard SQL Editor
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists with correct schema
- [ ] Foreign keys reference guilds(id) and players(id) with CASCADE
- [ ] Indexes exist for guild_id+created_at (primary query path) and player_id
- [ ] RLS enabled with select and insert policies
- [ ] No UPDATE/DELETE policies (messages immutable)
</verification>

<success_criteria>
- Migration file `025_guild_messages.sql` exists in supabase/migrations/
- Schema matches research recommendations (dedicated table, not chat_messages extension)
- RLS policies use guild_members join pattern from existing guild RLS
</success_criteria>

<output>
After completion, create `.planning/phases/03-guild-chat/03-01-SUMMARY.md`
</output>
