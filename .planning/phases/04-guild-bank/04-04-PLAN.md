---
phase: 04-guild-bank
plan: 04
type: execute
wave: 4
depends_on: ["04-02", "04-03"]
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/lib/ws/gameSocket.ts
  - apps/web/src/components/game/guild/GuildBankModal.tsx
  - apps/web/src/components/game/guild/BankCurrencyTab.tsx
  - apps/web/src/components/game/guild/BankItemsTab.tsx
  - apps/web/src/components/game/guild/BankSettingsTab.tsx
  - apps/web/src/components/game/guild/index.ts
autonomous: true

must_haves:
  truths:
    - "Player can open guild bank modal from guild panel"
    - "Player can see currency balance and deposit/withdraw"
    - "Player can see items organized by category"
    - "Player can deposit and withdraw items"
    - "Daily limits are visible when withdrawing"
    - "Bank updates in real-time when other members make changes"
    - "Leaders can configure daily limits per role via Settings tab"
  artifacts:
    - path: "apps/web/src/components/game/guild/GuildBankModal.tsx"
      provides: "Main bank modal with tabbed interface"
      min_lines: 100
    - path: "apps/web/src/components/game/guild/BankCurrencyTab.tsx"
      provides: "Currency deposit/withdraw UI"
      min_lines: 80
    - path: "apps/web/src/components/game/guild/BankItemsTab.tsx"
      provides: "Item deposit/withdraw UI with category grouping"
      min_lines: 120
    - path: "apps/web/src/components/game/guild/BankSettingsTab.tsx"
      provides: "Leader-only settings UI for permissions and limits"
      min_lines: 150
  key_links:
    - from: "apps/web/src/components/game/guild/GuildBankModal.tsx"
      to: "apps/web/src/lib/ws/gameSocket.ts"
      via: "gameSocket.getGuildBank() call"
      pattern: "gameSocket\\.getGuildBank"
    - from: "apps/web/src/stores/gameStore.ts"
      to: "apps/web/src/lib/ws/gameSocket.ts"
      via: "WebSocket message handlers update store"
      pattern: "setGuildBank\\("
    - from: "apps/web/src/components/game/guild/BankSettingsTab.tsx"
      to: "apps/web/src/lib/ws/gameSocket.ts"
      via: "gameSocket.setBankLimit() call"
      pattern: "gameSocket\\.setBankLimit"
---

<objective>
Build the frontend guild bank modal with Currency, Items, and Settings tabs, including Zustand state management and WebSocket integration.

Purpose: Enable players to view and interact with guild bank currency and items. Leaders can configure daily withdrawal limits per role via the Settings tab.

Output: GuildBankModal.tsx (main modal), BankCurrencyTab.tsx, BankItemsTab.tsx, BankSettingsTab.tsx (leader only), updated gameStore.ts and gameSocket.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-guild-bank/04-CONTEXT.md
@apps/web/src/stores/gameStore.ts
@apps/web/src/lib/ws/gameSocket.ts
@apps/web/src/components/game/guild/index.ts
@apps/web/src/components/game/social/TradeModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild bank state to Zustand store and WebSocket handlers</name>
  <files>apps/web/src/stores/gameStore.ts, apps/web/src/lib/ws/gameSocket.ts</files>
  <action>
**gameStore.ts additions:**

Read apps/web/src/stores/gameStore.ts and add guild bank state. Follow existing patterns (guild state, chat state).

Add to interface GameState:
```typescript
// Guild Bank State
guildBank: GuildBank | null
guildBankLogs: GuildBankLog[]
guildBankLogsTotal: number
guildBankRequests: GuildBankRequest[]
myBankLimits: { currency: number; items: number; pokemon_points: number } | null
```

Add actions:
```typescript
setGuildBank: (bank: GuildBank | null) => void
updateGuildBankCurrency: (balance: number) => void
updateGuildBankItem: (item: GuildBankItem) => void
addGuildBankPokemon: (pokemon: GuildBankPokemon) => void
removeGuildBankPokemon: (pokemonId: string) => void
setGuildBankLogs: (logs: GuildBankLog[], total: number) => void
setGuildBankRequests: (requests: GuildBankRequest[]) => void
addGuildBankRequest: (request: GuildBankRequest) => void
removeGuildBankRequest: (requestId: string) => void
setMyBankLimits: (limits: { currency: number; items: number; pokemon_points: number }) => void
clearGuildBank: () => void
```

Add implementations:
```typescript
guildBank: null,
guildBankLogs: [],
guildBankLogsTotal: 0,
guildBankRequests: [],
myBankLimits: null,

setGuildBank: (bank) => set({ guildBank: bank }),

updateGuildBankCurrency: (balance) => set((state) => ({
  guildBank: state.guildBank ? {
    ...state.guildBank,
    currency: { ...state.guildBank.currency, balance }
  } : null
})),

updateGuildBankItem: (item) => set((state) => {
  if (!state.guildBank) return state
  const items = [...state.guildBank.items]
  const idx = items.findIndex(i => i.item_id === item.item_id)
  if (idx >= 0) {
    if (item.quantity <= 0) {
      items.splice(idx, 1)
    } else {
      items[idx] = item
    }
  } else if (item.quantity > 0) {
    items.push(item)
  }
  return { guildBank: { ...state.guildBank, items } }
}),

addGuildBankPokemon: (pokemon) => set((state) => {
  if (!state.guildBank) return state
  return {
    guildBank: {
      ...state.guildBank,
      pokemon: [...state.guildBank.pokemon, pokemon],
      pokemon_slots: {
        ...state.guildBank.pokemon_slots,
        used: state.guildBank.pokemon_slots.used + 1
      }
    }
  }
}),

removeGuildBankPokemon: (pokemonId) => set((state) => {
  if (!state.guildBank) return state
  return {
    guildBank: {
      ...state.guildBank,
      pokemon: state.guildBank.pokemon.filter(p => p.pokemon_id !== pokemonId),
      pokemon_slots: {
        ...state.guildBank.pokemon_slots,
        used: Math.max(0, state.guildBank.pokemon_slots.used - 1)
      }
    }
  }
}),

setGuildBankLogs: (logs, total) => set({ guildBankLogs: logs, guildBankLogsTotal: total }),

setGuildBankRequests: (requests) => set({ guildBankRequests: requests }),

addGuildBankRequest: (request) => set((state) => ({
  guildBankRequests: [request, ...state.guildBankRequests]
})),

removeGuildBankRequest: (requestId) => set((state) => ({
  guildBankRequests: state.guildBankRequests.filter(r => r.id !== requestId)
})),

setMyBankLimits: (limits) => set({ myBankLimits: limits }),

clearGuildBank: () => set({
  guildBank: null,
  guildBankLogs: [],
  guildBankLogsTotal: 0,
  guildBankRequests: [],
  myBankLimits: null
}),
```

Also clear guild bank when player leaves guild (in existing leave guild handler).

**gameSocket.ts additions:**

Read apps/web/src/lib/ws/gameSocket.ts and add message handlers and send methods.

Add to message handler switch:
```typescript
case 'guild_bank_data':
  useGameStore.getState().setGuildBank(msg.payload.bank)
  break

case 'guild_bank_currency_updated':
  useGameStore.getState().updateGuildBankCurrency(msg.payload.balance)
  break

case 'guild_bank_item_updated':
  // Refetch bank for accurate data
  this.getGuildBank()
  break

case 'guild_bank_pokemon_added':
  // Refetch bank for full pokemon data
  this.getGuildBank()
  break

case 'guild_bank_pokemon_removed':
  useGameStore.getState().removeGuildBankPokemon(msg.payload.pokemon_id)
  break

case 'guild_bank_slots_expanded':
  // Refetch bank for updated slot counts
  this.getGuildBank()
  break

case 'guild_bank_logs':
  useGameStore.getState().setGuildBankLogs(msg.payload.logs, msg.payload.total)
  break

case 'guild_bank_requests':
  useGameStore.getState().setGuildBankRequests(msg.payload.requests)
  break

case 'guild_bank_request_created':
  useGameStore.getState().addGuildBankRequest(msg.payload.request)
  break

case 'guild_bank_request_fulfilled':
  useGameStore.getState().removeGuildBankRequest(msg.payload.request_id)
  break

case 'guild_bank_my_limits':
  useGameStore.getState().setMyBankLimits(msg.payload)
  break

case 'guild_bank_error':
  // Could show toast notification
  console.error('Guild bank error:', msg.payload.error)
  break

case 'guild_bank_success':
  // Could show toast notification
  console.log('Guild bank success:', msg.payload.message)
  break
```

Add send methods to GameSocket class:
```typescript
getGuildBank() {
  this.send({ type: 'get_guild_bank', payload: {} })
}

depositCurrency(amount: number) {
  this.send({ type: 'deposit_currency', payload: { amount } })
}

withdrawCurrency(amount: number) {
  this.send({ type: 'withdraw_currency', payload: { amount } })
}

depositItem(itemId: string, quantity: number) {
  this.send({ type: 'deposit_item', payload: { item_id: itemId, quantity } })
}

withdrawItem(itemId: string, quantity: number) {
  this.send({ type: 'withdraw_item', payload: { item_id: itemId, quantity } })
}

depositPokemon(pokemonId: string) {
  this.send({ type: 'deposit_pokemon', payload: { pokemon_id: pokemonId } })
}

withdrawPokemon(pokemonId: string) {
  this.send({ type: 'withdraw_pokemon', payload: { pokemon_id: pokemonId } })
}

expandPokemonSlots() {
  this.send({ type: 'expand_pokemon_slots', payload: {} })
}

createBankRequest(requestType: string, details: Record<string, unknown>, note?: string) {
  this.send({ type: 'create_bank_request', payload: { request_type: requestType, details, note } })
}

fulfillBankRequest(requestId: string) {
  this.send({ type: 'fulfill_bank_request', payload: { request_id: requestId } })
}

cancelBankRequest(requestId: string) {
  this.send({ type: 'cancel_bank_request', payload: { request_id: requestId } })
}

getBankRequests(includeExpired: boolean = false) {
  this.send({ type: 'get_bank_requests', payload: { include_expired: includeExpired } })
}

getBankLogs(options: { page?: number; limit?: number; filterPlayer?: string; filterAction?: string; filterCategory?: string } = {}) {
  this.send({ type: 'get_bank_logs', payload: {
    page: options.page,
    limit: options.limit,
    filter_player: options.filterPlayer,
    filter_action: options.filterAction,
    filter_category: options.filterCategory
  }})
}

// Permission configuration (leader only)
setBankPermission(category: string, role: string, canDeposit: boolean, canWithdraw: boolean) {
  this.send({ type: 'set_bank_permission', payload: { category, role, can_deposit: canDeposit, can_withdraw: canWithdraw } })
}

setBankLimit(role: string, category: string, dailyLimit: number, pokemonPointsLimit?: number) {
  this.send({ type: 'set_bank_limit', payload: { role, category, daily_limit: dailyLimit, pokemon_points_limit: pokemonPointsLimit } })
}

setPlayerOverride(playerId: string, category: string, customLimit: number) {
  this.send({ type: 'set_player_override', payload: { player_id: playerId, category, custom_limit: customLimit } })
}

removePlayerOverride(playerId: string, category: string) {
  this.send({ type: 'remove_player_override', payload: { player_id: playerId, category } })
}
```

Add type imports as needed.
  </action>
  <verify>
Check that:
- gameStore.ts has all guild bank state fields and actions
- gameSocket.ts has all message handlers and send methods
- No TypeScript errors
Run: `npm run build` in apps/web (or check with IDE)
  </verify>
  <done>
Guild bank state management and WebSocket integration complete in Zustand store and gameSocket
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GuildBankModal with tabbed interface</name>
  <files>apps/web/src/components/game/guild/GuildBankModal.tsx, apps/web/src/components/game/guild/index.ts</files>
  <action>
Create the main guild bank modal component following TradeModal patterns.

**GuildBankModal.tsx:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'
import { BankCurrencyTab } from './BankCurrencyTab'
import { BankItemsTab } from './BankItemsTab'
import { BankSettingsTab } from './BankSettingsTab'
// Import Pokemon, Logs, Requests tabs when created in next plan
// import { BankPokemonTab } from './BankPokemonTab'
// import { BankLogsTab } from './BankLogsTab'
// import { BankRequestsTab } from './BankRequestsTab'

type BankTab = 'currency' | 'items' | 'pokemon' | 'logs' | 'requests' | 'settings'

interface GuildBankModalProps {
  isOpen: boolean
  onClose: () => void
}

export function GuildBankModal({ isOpen, onClose }: GuildBankModalProps) {
  const [selectedTab, setSelectedTab] = useState<BankTab>('currency')
  const [isVisible, setIsVisible] = useState(false)

  const guildBank = useGameStore((state) => state.guildBank)
  const myGuild = useGameStore((state) => state.myGuild)
  const myGuildRole = useGameStore((state) => state.myGuildRole)
  const guildBankRequests = useGameStore((state) => state.guildBankRequests)

  // Animation handling (following TradeModal pattern)
  useEffect(() => {
    if (isOpen) {
      setIsVisible(true)
      gameSocket.getGuildBank()
      // Also fetch requests for officers/leaders
      if (myGuildRole === 'leader' || myGuildRole === 'officer') {
        gameSocket.getBankRequests()
      }
    } else {
      const timer = setTimeout(() => setIsVisible(false), 200)
      return () => clearTimeout(timer)
    }
  }, [isOpen, myGuildRole])

  // Keyboard handler
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        onClose()
      }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [isOpen, onClose])

  if (!isVisible) return null

  const pendingRequestCount = guildBankRequests.filter(r => r.status === 'pending').length

  const tabs: { id: BankTab; label: string; badge?: number; leaderOnly?: boolean }[] = [
    { id: 'currency', label: 'Currency' },
    { id: 'items', label: 'Items' },
    { id: 'pokemon', label: 'Pokemon' },
    { id: 'logs', label: 'Logs' },
    // Only show requests tab for officers/leaders
    ...(myGuildRole === 'leader' || myGuildRole === 'officer'
      ? [{ id: 'requests' as BankTab, label: 'Requests', badge: pendingRequestCount }]
      : []
    ),
    // Only show settings tab for leaders
    ...(myGuildRole === 'leader'
      ? [{ id: 'settings' as BankTab, label: 'Settings', leaderOnly: true }]
      : []
    ),
  ]

  return (
    <div
      className={`fixed inset-0 z-50 flex items-center justify-center p-4 transition-all duration-200 ${
        isOpen ? 'bg-black/50' : 'bg-transparent pointer-events-none'
      }`}
      onClick={(e) => e.target === e.currentTarget && onClose()}
    >
      <div
        className={`bg-slate-800 rounded-lg border border-slate-600 shadow-xl w-full max-w-4xl max-h-[85vh] flex flex-col transition-all duration-200 ${
          isOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'
        }`}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-700">
          <div>
            <h2 className="text-lg font-semibold text-white">Guild Bank</h2>
            {myGuild && (
              <p className="text-sm text-slate-400">[{myGuild.tag}] {myGuild.name}</p>
            )}
          </div>
          <button
            onClick={onClose}
            className="text-slate-400 hover:text-white transition-colors"
          >
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Tab Navigation */}
        <div className="flex border-b border-slate-700">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setSelectedTab(tab.id)}
              className={`px-4 py-2 text-sm font-medium transition-colors relative ${
                selectedTab === tab.id
                  ? 'text-yellow-400 border-b-2 border-yellow-400'
                  : 'text-slate-400 hover:text-white'
              }`}
            >
              {tab.label}
              {tab.badge && tab.badge > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                  {tab.badge}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="flex-1 overflow-hidden relative">
          {!guildBank ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-slate-400">Loading bank...</p>
            </div>
          ) : (
            <>
              {selectedTab === 'currency' && <BankCurrencyTab />}
              {selectedTab === 'items' && <BankItemsTab />}
              {selectedTab === 'pokemon' && (
                <div className="p-4 text-slate-400 text-center">Pokemon tab coming soon</div>
              )}
              {selectedTab === 'logs' && (
                <div className="p-4 text-slate-400 text-center">Logs tab coming soon</div>
              )}
              {selectedTab === 'requests' && (
                <div className="p-4 text-slate-400 text-center">Requests tab coming soon</div>
              )}
              {selectedTab === 'settings' && <BankSettingsTab />}
            </>
          )}
        </div>
      </div>
    </div>
  )
}
```

**Update index.ts:**

Add export for GuildBankModal:
```typescript
export { GuildBankModal } from './GuildBankModal'
```
  </action>
  <verify>
Check that:
- GuildBankModal.tsx exists with tabbed interface
- Modal opens on isOpen=true and fetches bank data
- Tab navigation works
- Settings tab only visible to leaders
- Escape key closes modal
- index.ts exports GuildBankModal
  </verify>
  <done>
GuildBankModal created with tabbed interface, animation, and proper state loading. Settings tab added for leaders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BankCurrencyTab, BankItemsTab, and BankSettingsTab components</name>
  <files>apps/web/src/components/game/guild/BankCurrencyTab.tsx, apps/web/src/components/game/guild/BankItemsTab.tsx, apps/web/src/components/game/guild/BankSettingsTab.tsx, apps/web/src/components/game/guild/index.ts</files>
  <action>
**BankCurrencyTab.tsx:**

Create the currency deposit/withdraw UI with split view pattern from CONTEXT.md.

```typescript
'use client'

import { useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'

export function BankCurrencyTab() {
  const [amount, setAmount] = useState('')
  const [mode, setMode] = useState<'deposit' | 'withdraw'>('deposit')

  const guildBank = useGameStore((state) => state.guildBank)
  const player = useGameStore((state) => state.player)
  const myGuildRole = useGameStore((state) => state.myGuildRole)
  const myBankLimits = useGameStore((state) => state.myBankLimits)

  if (!guildBank || !player) return null

  const { currency } = guildBank
  const playerBalance = player.pokedollars || 0
  const numAmount = parseInt(amount) || 0

  const canWithdraw = myGuildRole === 'leader' || myGuildRole === 'officer'
  const remainingLimit = myBankLimits?.currency ?? -1 // -1 = unlimited

  const handleSubmit = () => {
    if (numAmount <= 0) return

    if (mode === 'deposit') {
      if (numAmount > playerBalance) return
      gameSocket.depositCurrency(numAmount)
    } else {
      if (numAmount > currency.balance) return
      if (remainingLimit !== -1 && numAmount > remainingLimit) return
      gameSocket.withdrawCurrency(numAmount)
    }
    setAmount('')
  }

  const handleMax = () => {
    if (mode === 'deposit') {
      const maxDeposit = Math.min(playerBalance, currency.max_capacity - currency.balance)
      setAmount(String(Math.max(0, maxDeposit)))
    } else {
      const maxWithdraw = remainingLimit === -1
        ? currency.balance
        : Math.min(currency.balance, remainingLimit)
      setAmount(String(Math.max(0, maxWithdraw)))
    }
  }

  const isValidAmount = numAmount > 0 && (
    mode === 'deposit'
      ? numAmount <= playerBalance && currency.balance + numAmount <= currency.max_capacity
      : numAmount <= currency.balance && (remainingLimit === -1 || numAmount <= remainingLimit)
  )

  return (
    <div className="p-4 h-full flex flex-col gap-4">
      {/* Balance Display */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-slate-700/50 rounded-lg p-4">
          <div className="text-sm text-slate-400 mb-1">Guild Bank</div>
          <div className="text-2xl font-bold text-yellow-400">
            {currency.balance.toLocaleString()}
          </div>
          <div className="text-xs text-slate-500">
            / {currency.max_capacity.toLocaleString()} max
          </div>
          <div className="mt-2 bg-slate-600 rounded-full h-2 overflow-hidden">
            <div
              className="bg-yellow-400 h-full transition-all"
              style={{ width: `${(currency.balance / currency.max_capacity) * 100}%` }}
            />
          </div>
        </div>
        <div className="bg-slate-700/50 rounded-lg p-4">
          <div className="text-sm text-slate-400 mb-1">Your Balance</div>
          <div className="text-2xl font-bold text-white">
            {playerBalance.toLocaleString()}
          </div>
          {canWithdraw && remainingLimit !== -1 && (
            <div className="text-xs text-slate-500 mt-2">
              Daily limit remaining: {remainingLimit.toLocaleString()}
            </div>
          )}
        </div>
      </div>

      {/* Mode Toggle */}
      <div className="flex gap-2">
        <button
          onClick={() => setMode('deposit')}
          className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
            mode === 'deposit'
              ? 'bg-green-600 text-white'
              : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
          }`}
        >
          Deposit
        </button>
        {canWithdraw && (
          <button
            onClick={() => setMode('withdraw')}
            className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
              mode === 'withdraw'
                ? 'bg-orange-600 text-white'
                : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
            }`}
          >
            Withdraw
          </button>
        )}
      </div>

      {/* Amount Input */}
      <div className="flex gap-2">
        <div className="flex-1 relative">
          <input
            type="number"
            value={amount}
            onChange={(e) => setAmount(e.target.value)}
            placeholder="Enter amount"
            className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:border-yellow-400"
          />
          <button
            onClick={handleMax}
            className="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-yellow-400 hover:text-yellow-300"
          >
            MAX
          </button>
        </div>
        <button
          onClick={handleSubmit}
          disabled={!isValidAmount}
          className={`px-6 py-2 rounded-lg font-medium transition-colors ${
            isValidAmount
              ? mode === 'deposit'
                ? 'bg-green-600 hover:bg-green-500 text-white'
                : 'bg-orange-600 hover:bg-orange-500 text-white'
              : 'bg-slate-700 text-slate-500 cursor-not-allowed'
          }`}
        >
          {mode === 'deposit' ? 'Deposit' : 'Withdraw'}
        </button>
      </div>

      {/* Quick Amount Buttons */}
      <div className="flex gap-2">
        {[100, 500, 1000, 5000, 10000].map((preset) => (
          <button
            key={preset}
            onClick={() => setAmount(String(preset))}
            className="flex-1 py-1 text-sm bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition-colors"
          >
            {preset >= 1000 ? `${preset / 1000}k` : preset}
          </button>
        ))}
      </div>

      {/* Member Request Option (for non-officers) */}
      {!canWithdraw && (
        <div className="mt-auto p-4 bg-slate-700/30 rounded-lg">
          <p className="text-sm text-slate-400 mb-2">
            Only Officers and Leaders can withdraw currency. You can request a withdrawal:
          </p>
          <button
            onClick={() => {
              if (numAmount > 0) {
                gameSocket.createBankRequest('currency', { amount: numAmount })
              }
            }}
            disabled={numAmount <= 0 || numAmount > currency.balance}
            className="w-full py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:text-slate-500 text-white rounded-lg font-medium transition-colors"
          >
            Request {numAmount > 0 ? numAmount.toLocaleString() : 'Amount'}
          </button>
        </div>
      )}
    </div>
  )
}
```

**BankItemsTab.tsx:**

Create the items deposit/withdraw UI with category grouping. Use flex-based layout instead of absolute positioning to avoid layout issues.

```typescript
'use client'

import { useState, useMemo } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'
import type { GuildBankItem } from '@pokemon-idle/shared'

// Item categories matching inventory
const ITEM_CATEGORIES = {
  healing: { name: 'Healing', items: ['potion', 'super_potion', 'hyper_potion', 'max_potion', 'full_restore', 'revive', 'max_revive'] },
  balls: { name: 'Poke Balls', items: ['poke_ball', 'great_ball', 'ultra_ball', 'master_ball'] },
  evolution: { name: 'Evolution', items: ['fire_stone', 'water_stone', 'thunder_stone', 'leaf_stone', 'moon_stone'] },
  other: { name: 'Other', items: [] } // Catch-all
}

interface SelectedItem {
  item_id: string
  source: 'bank' | 'inventory'
}

export function BankItemsTab() {
  const [selectedItem, setSelectedItem] = useState<SelectedItem | null>(null)
  const [quantity, setQuantity] = useState(1)
  const [searchQuery, setSearchQuery] = useState('')

  const guildBank = useGameStore((state) => state.guildBank)
  const inventory = useGameStore((state) => state.inventory)
  const myGuildRole = useGameStore((state) => state.myGuildRole)
  const myBankLimits = useGameStore((state) => state.myBankLimits)

  const canWithdraw = myGuildRole === 'leader' || myGuildRole === 'officer'
  const remainingLimit = myBankLimits?.items ?? -1

  // Group bank items by category
  const bankItemsByCategory = useMemo(() => {
    if (!guildBank) return {}
    const grouped: Record<string, GuildBankItem[]> = {}

    guildBank.items.forEach((item) => {
      let category = 'other'
      for (const [cat, config] of Object.entries(ITEM_CATEGORIES)) {
        if (config.items.includes(item.item_id)) {
          category = cat
          break
        }
      }
      if (!grouped[category]) grouped[category] = []
      grouped[category].push(item)
    })

    return grouped
  }, [guildBank])

  // Filter inventory items
  const inventoryItems = useMemo(() => {
    if (!inventory) return []
    return inventory.filter((item) =>
      item.quantity > 0 &&
      (searchQuery === '' || item.item_id.toLowerCase().includes(searchQuery.toLowerCase()))
    )
  }, [inventory, searchQuery])

  const handleDeposit = () => {
    if (!selectedItem || selectedItem.source !== 'inventory') return
    const invItem = inventory?.find(i => i.item_id === selectedItem.item_id)
    if (!invItem || quantity > invItem.quantity) return

    gameSocket.depositItem(selectedItem.item_id, quantity)
    setSelectedItem(null)
    setQuantity(1)
  }

  const handleWithdraw = () => {
    if (!selectedItem || selectedItem.source !== 'bank' || !canWithdraw) return
    const bankItem = guildBank?.items.find(i => i.item_id === selectedItem.item_id)
    if (!bankItem || quantity > bankItem.quantity) return
    if (remainingLimit !== -1 && quantity > remainingLimit) return

    gameSocket.withdrawItem(selectedItem.item_id, quantity)
    setSelectedItem(null)
    setQuantity(1)
  }

  const handleRequest = () => {
    if (!selectedItem || selectedItem.source !== 'bank') return
    const bankItem = guildBank?.items.find(i => i.item_id === selectedItem.item_id)
    if (!bankItem || quantity > bankItem.quantity) return

    gameSocket.createBankRequest('item', {
      item_id: selectedItem.item_id,
      item_name: formatItemName(selectedItem.item_id),
      quantity
    })
    setSelectedItem(null)
    setQuantity(1)
  }

  const formatItemName = (itemId: string) => {
    return itemId.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())
  }

  if (!guildBank) return null

  return (
    <div className="flex flex-col h-full">
      {/* Main content area with split view */}
      <div className="flex flex-1 overflow-hidden">
        {/* Bank Items (Left Side) */}
        <div className="w-1/2 border-r border-slate-700 p-4 overflow-y-auto">
          <h3 className="text-sm font-medium text-slate-400 mb-3">Guild Bank Items</h3>

          {Object.entries(ITEM_CATEGORIES).map(([catKey, catConfig]) => {
            const items = bankItemsByCategory[catKey]
            if (!items || items.length === 0) return null

            return (
              <div key={catKey} className="mb-4">
                <h4 className="text-xs font-medium text-slate-500 uppercase mb-2">{catConfig.name}</h4>
                <div className="grid grid-cols-4 gap-2">
                  {items.map((item) => (
                    <button
                      key={item.item_id}
                      onClick={() => setSelectedItem({ item_id: item.item_id, source: 'bank' })}
                      className={`p-2 rounded-lg text-center transition-colors ${
                        selectedItem?.item_id === item.item_id && selectedItem?.source === 'bank'
                          ? 'bg-yellow-500/20 border-2 border-yellow-400'
                          : 'bg-slate-700 hover:bg-slate-600 border-2 border-transparent'
                      }`}
                    >
                      <div className="text-xs text-white truncate">{formatItemName(item.item_id)}</div>
                      <div className="text-sm font-bold text-yellow-400">x{item.quantity}</div>
                    </button>
                  ))}
                </div>
              </div>
            )
          })}

          {guildBank.items.length === 0 && (
            <p className="text-slate-500 text-center py-8">No items in bank</p>
          )}
        </div>

        {/* Inventory Items (Right Side) */}
        <div className="w-1/2 p-4 overflow-y-auto">
          <h3 className="text-sm font-medium text-slate-400 mb-3">Your Inventory</h3>

          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search items..."
            className="w-full mb-3 bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm text-white placeholder-slate-400"
          />

          <div className="grid grid-cols-3 gap-2">
            {inventoryItems.map((item) => (
              <button
                key={item.item_id}
                onClick={() => setSelectedItem({ item_id: item.item_id, source: 'inventory' })}
                className={`p-2 rounded-lg text-center transition-colors ${
                  selectedItem?.item_id === item.item_id && selectedItem?.source === 'inventory'
                    ? 'bg-green-500/20 border-2 border-green-400'
                    : 'bg-slate-700 hover:bg-slate-600 border-2 border-transparent'
                }`}
              >
                <div className="text-xs text-white truncate">{formatItemName(item.item_id)}</div>
                <div className="text-sm font-bold text-white">x{item.quantity}</div>
              </button>
            ))}
          </div>

          {inventoryItems.length === 0 && (
            <p className="text-slate-500 text-center py-8">No items in inventory</p>
          )}
        </div>
      </div>

      {/* Action Panel (Bottom - fixed within modal, not absolute) */}
      {selectedItem && (
        <div className="flex-shrink-0 bg-slate-800 border-t border-slate-700 p-4">
          <div className="flex items-center gap-4">
            <div className="flex-1">
              <span className="text-slate-400">Selected: </span>
              <span className="text-white font-medium">{formatItemName(selectedItem.item_id)}</span>
              <span className="text-slate-400 ml-2">from {selectedItem.source}</span>
            </div>

            <div className="flex items-center gap-2">
              <button
                onClick={() => setQuantity(Math.max(1, quantity - 1))}
                className="w-8 h-8 bg-slate-700 rounded text-white hover:bg-slate-600"
              >
                -
              </button>
              <input
                type="number"
                value={quantity}
                onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                className="w-16 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-center text-white"
              />
              <button
                onClick={() => setQuantity(quantity + 1)}
                className="w-8 h-8 bg-slate-700 rounded text-white hover:bg-slate-600"
              >
                +
              </button>
            </div>

            {selectedItem.source === 'inventory' ? (
              <button
                onClick={handleDeposit}
                className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded font-medium"
              >
                Deposit
              </button>
            ) : canWithdraw ? (
              <button
                onClick={handleWithdraw}
                className="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded font-medium"
              >
                Withdraw
              </button>
            ) : (
              <button
                onClick={handleRequest}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-medium"
              >
                Request
              </button>
            )}

            <button
              onClick={() => setSelectedItem(null)}
              className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded"
            >
              Cancel
            </button>
          </div>

          {!canWithdraw && selectedItem.source === 'bank' && remainingLimit !== -1 && (
            <div className="text-xs text-slate-500 mt-2">
              Daily withdrawal limit remaining: {remainingLimit}
            </div>
          )}
        </div>
      )}
    </div>
  )
}
```

**BankSettingsTab.tsx:**

Create the settings UI for leaders to configure daily limits per role.

```typescript
'use client'

import { useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'
import type { BankCategory, GuildRole } from '@pokemon-idle/shared'

const ROLES: GuildRole[] = ['officer', 'member']
const CATEGORIES: BankCategory[] = ['currency', 'item', 'pokemon']

const CATEGORY_LABELS: Record<BankCategory, string> = {
  currency: 'Currency',
  item: 'Items',
  pokemon: 'Pokemon Points',
}

export function BankSettingsTab() {
  const [editingLimit, setEditingLimit] = useState<{ role: GuildRole; category: BankCategory } | null>(null)
  const [limitValue, setLimitValue] = useState('')
  const [pokemonPointsValue, setPokemonPointsValue] = useState('')

  const guildBank = useGameStore((state) => state.guildBank)
  const myGuildRole = useGameStore((state) => state.myGuildRole)

  if (!guildBank || myGuildRole !== 'leader') {
    return (
      <div className="p-4 text-slate-400 text-center">
        Only guild leaders can access bank settings.
      </div>
    )
  }

  const { limits } = guildBank

  const getLimit = (role: GuildRole, category: BankCategory) => {
    const limit = limits.find(l => l.role === role && l.category === category)
    return {
      daily_limit: limit?.daily_limit ?? 0,
      pokemon_points_limit: limit?.pokemon_points_limit ?? 0,
    }
  }

  const handleEditLimit = (role: GuildRole, category: BankCategory) => {
    const current = getLimit(role, category)
    setEditingLimit({ role, category })
    setLimitValue(current.daily_limit === -1 ? 'unlimited' : String(current.daily_limit))
    setPokemonPointsValue(String(current.pokemon_points_limit))
  }

  const handleSaveLimit = () => {
    if (!editingLimit) return

    const dailyLimit = limitValue.toLowerCase() === 'unlimited' ? -1 : parseInt(limitValue) || 0
    const pokemonPoints = editingLimit.category === 'pokemon' ? parseInt(pokemonPointsValue) || 0 : 0

    gameSocket.setBankLimit(editingLimit.role, editingLimit.category, dailyLimit, pokemonPoints)
    setEditingLimit(null)
    setLimitValue('')
    setPokemonPointsValue('')
  }

  const formatLimit = (value: number) => {
    if (value === -1) return 'Unlimited'
    if (value === 0) return 'No Access'
    return value.toLocaleString()
  }

  return (
    <div className="p-4 h-full overflow-y-auto">
      <h3 className="text-sm font-medium text-slate-400 mb-4">Daily Withdrawal Limits</h3>
      <p className="text-xs text-slate-500 mb-6">
        Configure how much each role can withdraw per day. Leaders always have unlimited access.
      </p>

      {/* Limits Table */}
      <div className="bg-slate-700/50 rounded-lg overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="bg-slate-700">
              <th className="text-left p-3 text-sm font-medium text-slate-300">Role</th>
              {CATEGORIES.map(cat => (
                <th key={cat} className="text-left p-3 text-sm font-medium text-slate-300">
                  {CATEGORY_LABELS[cat]}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {/* Leader row (read-only) */}
            <tr className="border-t border-slate-600">
              <td className="p-3 text-white font-medium">Leader</td>
              {CATEGORIES.map(cat => (
                <td key={cat} className="p-3 text-yellow-400">Unlimited</td>
              ))}
            </tr>

            {/* Configurable roles */}
            {ROLES.map(role => (
              <tr key={role} className="border-t border-slate-600">
                <td className="p-3 text-white font-medium capitalize">{role}</td>
                {CATEGORIES.map(cat => {
                  const current = getLimit(role, cat)
                  const isEditing = editingLimit?.role === role && editingLimit?.category === cat

                  return (
                    <td key={cat} className="p-3">
                      {isEditing ? (
                        <div className="flex flex-col gap-2">
                          <input
                            type="text"
                            value={limitValue}
                            onChange={(e) => setLimitValue(e.target.value)}
                            placeholder="Amount or 'unlimited'"
                            className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm text-white"
                          />
                          {cat === 'pokemon' && (
                            <input
                              type="number"
                              value={pokemonPointsValue}
                              onChange={(e) => setPokemonPointsValue(e.target.value)}
                              placeholder="Points limit"
                              className="w-full bg-slate-600 border border-slate-500 rounded px-2 py-1 text-sm text-white"
                            />
                          )}
                          <div className="flex gap-2">
                            <button
                              onClick={handleSaveLimit}
                              className="flex-1 px-2 py-1 bg-green-600 hover:bg-green-500 text-white text-xs rounded"
                            >
                              Save
                            </button>
                            <button
                              onClick={() => setEditingLimit(null)}
                              className="flex-1 px-2 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      ) : (
                        <button
                          onClick={() => handleEditLimit(role, cat)}
                          className="text-left hover:text-yellow-400 transition-colors"
                        >
                          <span className={current.daily_limit === 0 ? 'text-red-400' : 'text-slate-300'}>
                            {formatLimit(current.daily_limit)}
                          </span>
                          {cat === 'pokemon' && current.pokemon_points_limit > 0 && (
                            <span className="text-slate-500 text-xs ml-1">
                              ({current.pokemon_points_limit} pts)
                            </span>
                          )}
                        </button>
                      )}
                    </td>
                  )
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Help text */}
      <div className="mt-6 p-4 bg-slate-700/30 rounded-lg">
        <h4 className="text-sm font-medium text-slate-300 mb-2">Limit Values</h4>
        <ul className="text-xs text-slate-400 space-y-1">
          <li><span className="text-yellow-400">Unlimited (-1):</span> No daily limit</li>
          <li><span className="text-red-400">No Access (0):</span> Cannot withdraw at all</li>
          <li><span className="text-slate-300">Number:</span> Maximum amount per day</li>
          <li><span className="text-slate-300">Pokemon Points:</span> Based on rarity (Common=1, Rare=5, Legendary=25)</li>
        </ul>
      </div>
    </div>
  )
}
```

**Update index.ts:**

Add exports:
```typescript
export { BankCurrencyTab } from './BankCurrencyTab'
export { BankItemsTab } from './BankItemsTab'
export { BankSettingsTab } from './BankSettingsTab'
```
  </action>
  <verify>
Check that:
- BankCurrencyTab.tsx has deposit/withdraw modes, balance display, quick amounts
- BankItemsTab.tsx has split view with bank and inventory, category grouping
- BankItemsTab.tsx uses flex-based layout (not absolute positioning) for action panel
- BankSettingsTab.tsx has table for configuring limits per role per category
- All components handle quantity input and action buttons
- index.ts exports all three components
Run: `npm run build` in apps/web
  </verify>
  <done>
BankCurrencyTab, BankItemsTab, and BankSettingsTab created with full deposit/withdraw/request/configuration functionality. Action panel uses flex layout instead of absolute positioning.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` passes in apps/web
2. GuildBankModal opens and shows tabbed interface
3. BankCurrencyTab shows balances and handles deposit/withdraw
4. BankItemsTab shows items with category grouping (action panel uses flex layout)
5. BankSettingsTab shows limit configuration table for leaders
6. WebSocket messages update store state correctly
7. Real-time updates work when other guild members make changes
</verification>

<success_criteria>
- Modal opens from guild panel with tab navigation
- Currency tab shows guild and personal balance with deposit/withdraw
- Items tab shows split view with category-grouped bank items and player inventory
- Items tab action panel uses flex layout (not absolute positioning)
- Settings tab (leader only) shows table for configuring daily limits per role
- Daily limits visible for officers
- Members can create requests instead of withdrawing
- Real-time updates via WebSocket broadcasts
</success_criteria>

<output>
After completion, create `.planning/phases/04-guild-bank/04-04-SUMMARY.md`
</output>
