---
phase: 04-guild-bank
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/shared/src/types/guild.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match database schema exactly"
    - "All WebSocket payloads have proper typing"
    - "Types are importable from @pokemon-idle/shared"
  artifacts:
    - path: "packages/shared/src/types/guild.ts"
      provides: "Guild bank type definitions"
      exports: ["GuildBank", "GuildBankLog", "GuildBankRequest"]
  key_links:
    - from: "packages/shared/src/types/guild.ts"
      to: "supabase/migrations/026_guild_bank.sql"
      via: "Type shapes match table columns"
      pattern: "interface GuildBank"
---

<objective>
Define TypeScript types for the guild bank system including data models, WebSocket payloads, and UI state types.

Purpose: Enable type-safe communication between game server and frontend. Types must exactly match the database schema from Plan 04-01.

Output: Extended `guild.ts` with all bank-related types following existing patterns (GuildInvite, GuildMessageEntry, etc.)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-guild-bank/04-RESEARCH.md
@.planning/phases/04-guild-bank/04-CONTEXT.md
@packages/shared/src/types/guild.ts
@packages/shared/src/types/trade.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add guild bank data model types</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Read the existing guild.ts file and add new types for guild bank data models after the Guild Chat Types section.

Add a new section header:
```typescript
// ================================
// Guild Bank Types
// ================================
```

Add these data model types:

```typescript
// Bank category for deposits/withdrawals
export type BankCategory = 'currency' | 'item' | 'pokemon'

// Bank action types for logs
export type BankAction = 'deposit' | 'withdraw' | 'request_created' | 'request_fulfilled' | 'request_expired' | 'request_cancelled'

// Request status
export type BankRequestStatus = 'pending' | 'fulfilled' | 'expired' | 'cancelled'

// Guild bank overview (returned by get_guild_bank)
export interface GuildBank {
  currency: {
    balance: number
    max_capacity: number
  }
  items: GuildBankItem[]
  pokemon: GuildBankPokemon[]
  pokemon_slots: {
    used: number
    max: number
    base: number
    purchased: number
    next_expansion_price: number
  }
  permissions: GuildBankPermission[]
  limits: GuildBankLimit[]
  my_limits: {
    currency: number  // -1 = unlimited
    items: number
    pokemon_points: number
  }
}

// Single item in guild bank
export interface GuildBankItem {
  item_id: string
  quantity: number
  deposited_by: string | null  // player_id
  deposited_by_username: string | null
  last_updated: string
}

// Single Pokemon in guild bank
export interface GuildBankPokemon {
  id: string  // bank entry id
  pokemon_id: string
  slot: number
  species_id: number
  species_name: string
  nickname: string | null
  level: number
  is_shiny: boolean
  point_cost: number  // calculated from BST
  deposited_by: string | null
  deposited_by_username: string | null
  deposited_at: string
}

// Permission configuration entry
export interface GuildBankPermission {
  category: BankCategory
  role: GuildRole
  can_deposit: boolean
  can_withdraw: boolean
}

// Daily limit configuration entry
export interface GuildBankLimit {
  role: GuildRole
  category: BankCategory
  daily_limit: number  // -1 = unlimited, 0 = no permission
  pokemon_points_limit: number
}

// Player-specific limit override
export interface GuildBankPlayerOverride {
  player_id: string
  username: string
  category: BankCategory
  custom_limit: number
  set_by: string | null
  set_by_username: string | null
}

// Transaction log entry
export interface GuildBankLog {
  id: string
  player_id: string
  player_username: string
  action: BankAction
  category: BankCategory
  details: GuildBankLogDetails
  balance_after: number | null  // Only for currency
  created_at: string
}

// Log details vary by action type
export interface GuildBankLogDetails {
  amount?: number  // Currency amount
  item_id?: string
  item_name?: string
  quantity?: number
  pokemon_id?: string
  pokemon_species_id?: number
  pokemon_name?: string
  pokemon_level?: number
  pokemon_points?: number
  request_id?: string
  requester_id?: string
  requester_username?: string
}

// Request in the queue
export interface GuildBankRequest {
  id: string
  player_id: string
  player_username: string
  request_type: BankCategory
  item_details: GuildBankRequestDetails
  status: BankRequestStatus
  note: string | null
  created_at: string
  expires_at: string
  fulfilled_by: string | null
  fulfilled_by_username: string | null
  fulfilled_at: string | null
}

// Request details vary by type
export interface GuildBankRequestDetails {
  amount?: number  // For currency
  item_id?: string
  item_name?: string
  quantity?: number  // For items
  pokemon_id?: string
  pokemon_name?: string
  pokemon_level?: number
}
```

These types match the database schema from 026_guild_bank.sql and follow the existing patterns in guild.ts.
  </action>
  <verify>
Check that packages/shared/src/types/guild.ts contains:
- BankCategory, BankAction, BankRequestStatus type aliases
- GuildBank interface with currency, items, pokemon, pokemon_slots, permissions, limits, my_limits
- GuildBankItem, GuildBankPokemon interfaces
- GuildBankPermission, GuildBankLimit, GuildBankPlayerOverride interfaces
- GuildBankLog with GuildBankLogDetails
- GuildBankRequest with GuildBankRequestDetails
  </verify>
  <done>
All data model types added matching database schema structure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add guild bank WebSocket payload types</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Add WebSocket payload types for client-server communication after the data model types.

Add section header:
```typescript
// ================================
// Guild Bank WebSocket Payloads
// ================================
```

**Client -> Server Payloads:**

```typescript
// Get full bank state
export interface GetGuildBankPayload {
  // Empty - requests full bank data
}

// Currency operations
export interface DepositCurrencyPayload {
  amount: number
}

export interface WithdrawCurrencyPayload {
  amount: number
}

// Item operations
export interface DepositItemPayload {
  item_id: string
  quantity: number
}

export interface WithdrawItemPayload {
  item_id: string
  quantity: number
}

// Pokemon operations
export interface DepositPokemonPayload {
  pokemon_id: string
}

export interface WithdrawPokemonPayload {
  pokemon_id: string
}

// Request operations
export interface CreateBankRequestPayload {
  request_type: BankCategory
  details: GuildBankRequestDetails
  note?: string
}

export interface FulfillBankRequestPayload {
  request_id: string
}

export interface CancelBankRequestPayload {
  request_id: string
}

// Get transaction logs
export interface GetBankLogsPayload {
  page?: number
  limit?: number
  filter_player?: string  // player_id
  filter_action?: BankAction
  filter_category?: BankCategory
}

// Get pending requests (for officers)
export interface GetBankRequestsPayload {
  include_expired?: boolean
}

// Permission configuration (leader only)
export interface SetBankPermissionPayload {
  category: BankCategory
  role: GuildRole
  can_deposit: boolean
  can_withdraw: boolean
}

export interface SetBankLimitPayload {
  role: GuildRole
  category: BankCategory
  daily_limit: number
  pokemon_points_limit?: number
}

export interface SetPlayerOverridePayload {
  player_id: string
  category: BankCategory
  custom_limit: number
}

export interface RemovePlayerOverridePayload {
  player_id: string
  category: BankCategory
}

// Slot expansion
export interface ExpandPokemonSlotsPayload {
  // Empty - just triggers expansion
}
```

**Server -> Client Payloads:**

```typescript
// Full bank data response
export interface GuildBankDataPayload {
  bank: GuildBank
}

// Currency update broadcast
export interface GuildBankCurrencyUpdatedPayload {
  balance: number
  max_capacity: number
  player_id: string
  player_username: string
  amount: number
  action: 'deposit' | 'withdraw'
}

// Item update broadcast
export interface GuildBankItemUpdatedPayload {
  item: GuildBankItem
  player_id: string
  player_username: string
  quantity_changed: number
  action: 'deposit' | 'withdraw'
}

// Pokemon update broadcast
export interface GuildBankPokemonAddedPayload {
  pokemon: GuildBankPokemon
  player_id: string
  player_username: string
}

export interface GuildBankPokemonRemovedPayload {
  pokemon_id: string
  slot: number
  player_id: string
  player_username: string
}

// Slots expanded broadcast
export interface GuildBankSlotsExpandedPayload {
  new_total: number
  next_price: number
  expanded_by: string
  expanded_by_username: string
}

// Transaction logs response
export interface GuildBankLogsPayload {
  logs: GuildBankLog[]
  total: number
  page: number
}

// Requests response
export interface GuildBankRequestsPayload {
  requests: GuildBankRequest[]
}

// New request notification (to officers/leaders)
export interface GuildBankRequestCreatedPayload {
  request: GuildBankRequest
}

// Request fulfilled notification
export interface GuildBankRequestFulfilledPayload {
  request_id: string
  fulfilled_by: string
  fulfilled_by_username: string
}

// My remaining limits response
export interface GuildBankMyLimitsPayload {
  currency: number
  items: number
  pokemon_points: number
}

// Error response
export interface GuildBankErrorPayload {
  error: string
  code?: string
}

// Generic success response
export interface GuildBankSuccessPayload {
  success: true
  message?: string
}
```

Ensure all types follow the existing patterns in guild.ts (payload suffix, consistent naming).
  </action>
  <verify>
Check packages/shared/src/types/guild.ts contains:
- All 17 client->server payload types
- All 13 server->client payload types
- Consistent naming (Payload suffix)
- Proper imports/references to data model types
  </verify>
  <done>
All WebSocket payload types added for bank operations, covering deposit/withdraw, requests, logs, permissions, and broadcasts
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. packages/shared/src/types/guild.ts compiles without errors
2. Run `npm run build` in packages/shared to verify
3. All types follow existing naming conventions
4. Data model types match database schema
5. Payload types cover all planned WebSocket messages
</verification>

<success_criteria>
- guild.ts extended with Bank Types and Bank WebSocket Payloads sections
- Types match database schema from 04-01
- Types importable via `import { GuildBank } from '@pokemon-idle/shared'`
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-guild-bank/04-02-SUMMARY.md`
</output>
