---
phase: 04-guild-bank
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - apps/game-server/src/db.ts
  - apps/game-server/src/hub.ts
  - apps/game-server/src/types.ts
autonomous: true

must_haves:
  truths:
    - "Players can deposit currency, items, and Pokemon to guild bank"
    - "Players can withdraw with proper permission and limit checks"
    - "Members can create requests for items they cannot withdraw"
    - "Leaders and officers can fulfill or view requests"
    - "All operations broadcast updates to guild members"
    - "Transaction logs are accessible based on role"
  artifacts:
    - path: "apps/game-server/src/hub.ts"
      provides: "WebSocket handlers for all bank operations"
      contains: "handleGuildBankDeposit"
    - path: "apps/game-server/src/db.ts"
      provides: "Database functions calling bank RPCs"
      contains: "depositCurrencyToBank"
  key_links:
    - from: "apps/game-server/src/hub.ts"
      to: "apps/game-server/src/db.ts"
      via: "handler calls db function"
      pattern: "depositCurrencyToBank\\("
    - from: "apps/game-server/src/db.ts"
      to: "supabase/migrations/026_guild_bank.sql"
      via: "RPC calls to SECURITY DEFINER functions"
      pattern: "supabase\\.rpc\\('guild_bank_"
---

<objective>
Implement game server handlers for all guild bank operations including deposit, withdraw, requests, logs, and permission configuration.

Purpose: Enable WebSocket communication for bank operations. Follows established patterns from guild handlers (fire-and-forget async, broadcastToGuild).

Output: Extended hub.ts with bank handlers, extended db.ts with RPC wrapper functions, extended types.ts with re-exports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-guild-bank/04-RESEARCH.md
@apps/game-server/src/hub.ts
@apps/game-server/src/db.ts
@apps/game-server/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database functions for bank operations</name>
  <files>apps/game-server/src/db.ts</files>
  <action>
Read apps/game-server/src/db.ts and add new functions for guild bank operations. Follow existing patterns (getSupabase(), async/await, proper error handling, typed returns).

Add these database functions:

**Bank State Functions:**

```typescript
// Get full guild bank state for a player
export async function getGuildBank(
  playerId: string,
  guildId: string
): Promise<GuildBank | null> {
  const { data, error } = await getSupabase().rpc('get_guild_bank', {
    p_player_id: playerId,
    p_guild_id: guildId
  })
  if (error) {
    console.error('Error getting guild bank:', error)
    return null
  }
  return data as GuildBank
}

// Get player's remaining daily limits
export async function getBankDailyLimits(
  playerId: string,
  guildId: string
): Promise<{ currency: number; items: number; pokemon_points: number } | null> {
  const { data, error } = await getSupabase().rpc('get_bank_daily_limits', {
    p_player_id: playerId,
    p_guild_id: guildId
  })
  if (error) {
    console.error('Error getting bank limits:', error)
    return null
  }
  return data
}
```

**Currency Functions:**

```typescript
export async function depositCurrencyToBank(
  playerId: string,
  guildId: string,
  amount: number
): Promise<{ success: boolean; new_balance?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_deposit_currency', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_amount: amount
  })
  if (error) {
    console.error('Error depositing currency:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function withdrawCurrencyFromBank(
  playerId: string,
  guildId: string,
  amount: number
): Promise<{ success: boolean; new_balance?: number; remaining_limit?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_withdraw_currency', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_amount: amount
  })
  if (error) {
    console.error('Error withdrawing currency:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}
```

**Item Functions:**

```typescript
export async function depositItemToBank(
  playerId: string,
  guildId: string,
  itemId: string,
  quantity: number
): Promise<{ success: boolean; bank_quantity?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_deposit_item', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_item_id: itemId,
    p_quantity: quantity
  })
  if (error) {
    console.error('Error depositing item:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function withdrawItemFromBank(
  playerId: string,
  guildId: string,
  itemId: string,
  quantity: number
): Promise<{ success: boolean; remaining_limit?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_withdraw_item', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_item_id: itemId,
    p_quantity: quantity
  })
  if (error) {
    console.error('Error withdrawing item:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}
```

**Pokemon Functions:**

```typescript
export async function depositPokemonToBank(
  playerId: string,
  guildId: string,
  pokemonId: string
): Promise<{ success: boolean; slot?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_deposit_pokemon', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_pokemon_id: pokemonId
  })
  if (error) {
    console.error('Error depositing pokemon:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function withdrawPokemonFromBank(
  playerId: string,
  guildId: string,
  pokemonId: string
): Promise<{ success: boolean; remaining_points?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_withdraw_pokemon', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_pokemon_id: pokemonId
  })
  if (error) {
    console.error('Error withdrawing pokemon:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function expandBankPokemonSlots(
  playerId: string,
  guildId: string
): Promise<{ success: boolean; new_total_slots?: number; next_price?: number; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_expand_pokemon_slots', {
    p_player_id: playerId,
    p_guild_id: guildId
  })
  if (error) {
    console.error('Error expanding slots:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}
```

**Request Functions:**

```typescript
export async function createBankRequest(
  playerId: string,
  guildId: string,
  requestType: string,
  details: Record<string, unknown>,
  note?: string
): Promise<{ success: boolean; request_id?: string; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_create_request', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_type: requestType,
    p_details: details,
    p_note: note || null
  })
  if (error) {
    console.error('Error creating request:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function fulfillBankRequest(
  fulfillerId: string,
  guildId: string,
  requestId: string
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_fulfill_request', {
    p_fulfiller_id: fulfillerId,
    p_guild_id: guildId,
    p_request_id: requestId
  })
  if (error) {
    console.error('Error fulfilling request:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function cancelBankRequest(
  playerId: string,
  requestId: string
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('guild_bank_cancel_request', {
    p_player_id: playerId,
    p_request_id: requestId
  })
  if (error) {
    console.error('Error cancelling request:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function getBankRequests(
  guildId: string,
  includeExpired: boolean = false
): Promise<GuildBankRequest[]> {
  const { data, error } = await getSupabase().rpc('get_bank_requests', {
    p_guild_id: guildId,
    p_include_expired: includeExpired
  })
  if (error) {
    console.error('Error getting requests:', error)
    return []
  }
  return data || []
}
```

**Log Functions:**

```typescript
export async function getBankLogs(
  playerId: string,
  guildId: string,
  options: {
    page?: number
    limit?: number
    filterPlayer?: string
    filterAction?: string
    filterCategory?: string
  }
): Promise<{ logs: GuildBankLog[]; total: number }> {
  const { data, error } = await getSupabase().rpc('get_bank_logs', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_page: options.page || 1,
    p_limit: options.limit || 50,
    p_filter_player: options.filterPlayer || null,
    p_filter_action: options.filterAction || null,
    p_filter_category: options.filterCategory || null
  })
  if (error) {
    console.error('Error getting logs:', error)
    return { logs: [], total: 0 }
  }
  return data || { logs: [], total: 0 }
}
```

**Permission Functions:**

```typescript
export async function setBankPermission(
  playerId: string,
  guildId: string,
  category: string,
  role: string,
  canDeposit: boolean,
  canWithdraw: boolean
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('set_bank_permission', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_category: category,
    p_role: role,
    p_can_deposit: canDeposit,
    p_can_withdraw: canWithdraw
  })
  if (error) {
    console.error('Error setting permission:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function setBankLimit(
  playerId: string,
  guildId: string,
  role: string,
  category: string,
  dailyLimit: number,
  pokemonPointsLimit?: number
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('set_bank_limit', {
    p_player_id: playerId,
    p_guild_id: guildId,
    p_role: role,
    p_category: category,
    p_daily_limit: dailyLimit,
    p_pokemon_points_limit: pokemonPointsLimit || 0
  })
  if (error) {
    console.error('Error setting limit:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function setPlayerBankOverride(
  setterId: string,
  guildId: string,
  targetPlayerId: string,
  category: string,
  customLimit: number
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('set_player_bank_override', {
    p_setter_id: setterId,
    p_guild_id: guildId,
    p_target_player_id: targetPlayerId,
    p_category: category,
    p_custom_limit: customLimit
  })
  if (error) {
    console.error('Error setting override:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}

export async function removePlayerBankOverride(
  removerId: string,
  guildId: string,
  targetPlayerId: string,
  category: string
): Promise<{ success: boolean; error?: string }> {
  const { data, error } = await getSupabase().rpc('remove_player_bank_override', {
    p_remover_id: removerId,
    p_guild_id: guildId,
    p_target_player_id: targetPlayerId,
    p_category: category
  })
  if (error) {
    console.error('Error removing override:', error)
    return { success: false, error: 'Database error' }
  }
  return data
}
```

Add necessary type imports at the top of the file.
  </action>
  <verify>
Check apps/game-server/src/db.ts contains:
- All 18 new database functions
- Proper error handling with console.error
- Correct RPC function names matching 026_guild_bank.sql
- Type annotations on all function parameters and returns
  </verify>
  <done>
All database wrapper functions added for bank operations, requests, logs, and permissions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add type re-exports for bank payloads</name>
  <files>apps/game-server/src/types.ts</files>
  <action>
Read apps/game-server/src/types.ts and add re-exports for all guild bank types from @pokemon-idle/shared.

Add to the existing guild re-exports section:

```typescript
// Guild Bank Types
export type {
  BankCategory,
  BankAction,
  BankRequestStatus,
  GuildBank,
  GuildBankItem,
  GuildBankPokemon,
  GuildBankPermission,
  GuildBankLimit,
  GuildBankPlayerOverride,
  GuildBankLog,
  GuildBankLogDetails,
  GuildBankRequest,
  GuildBankRequestDetails,
  // Client -> Server Payloads
  GetGuildBankPayload,
  DepositCurrencyPayload,
  WithdrawCurrencyPayload,
  DepositItemPayload,
  WithdrawItemPayload,
  DepositPokemonPayload,
  WithdrawPokemonPayload,
  CreateBankRequestPayload,
  FulfillBankRequestPayload,
  CancelBankRequestPayload,
  GetBankLogsPayload,
  GetBankRequestsPayload,
  SetBankPermissionPayload,
  SetBankLimitPayload,
  SetPlayerOverridePayload,
  RemovePlayerOverridePayload,
  ExpandPokemonSlotsPayload,
  // Server -> Client Payloads
  GuildBankDataPayload,
  GuildBankCurrencyUpdatedPayload,
  GuildBankItemUpdatedPayload,
  GuildBankPokemonAddedPayload,
  GuildBankPokemonRemovedPayload,
  GuildBankSlotsExpandedPayload,
  GuildBankLogsPayload,
  GuildBankRequestsPayload,
  GuildBankRequestCreatedPayload,
  GuildBankRequestFulfilledPayload,
  GuildBankMyLimitsPayload,
  GuildBankErrorPayload,
  GuildBankSuccessPayload,
} from '@pokemon-idle/shared'
```

This follows the existing pattern of re-exporting shared types for use within game-server.
  </action>
  <verify>
Check apps/game-server/src/types.ts contains all bank-related type re-exports.
Run: `npm run build` in apps/game-server to verify no type errors
  </verify>
  <done>
All guild bank types re-exported from types.ts for use in handlers
  </done>
</task>

<task type="auto">
  <name>Task 3: Add WebSocket handlers for bank operations</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Read apps/game-server/src/hub.ts and add WebSocket handlers for guild bank operations. Follow the existing fire-and-forget async pattern (no await in switch cases).

**Add message type cases to the switch statement in handleMessage():**

```typescript
// Guild Bank messages
case 'get_guild_bank':
  this.handleGetGuildBank(client)
  break
case 'deposit_currency':
  this.handleDepositCurrency(client, msg.payload as DepositCurrencyPayload)
  break
case 'withdraw_currency':
  this.handleWithdrawCurrency(client, msg.payload as WithdrawCurrencyPayload)
  break
case 'deposit_item':
  this.handleDepositItem(client, msg.payload as DepositItemPayload)
  break
case 'withdraw_item':
  this.handleWithdrawItem(client, msg.payload as WithdrawItemPayload)
  break
case 'deposit_pokemon':
  this.handleDepositPokemon(client, msg.payload as DepositPokemonPayload)
  break
case 'withdraw_pokemon':
  this.handleWithdrawPokemon(client, msg.payload as WithdrawPokemonPayload)
  break
case 'expand_pokemon_slots':
  this.handleExpandPokemonSlots(client)
  break
case 'create_bank_request':
  this.handleCreateBankRequest(client, msg.payload as CreateBankRequestPayload)
  break
case 'fulfill_bank_request':
  this.handleFulfillBankRequest(client, msg.payload as FulfillBankRequestPayload)
  break
case 'cancel_bank_request':
  this.handleCancelBankRequest(client, msg.payload as CancelBankRequestPayload)
  break
case 'get_bank_requests':
  this.handleGetBankRequests(client, msg.payload as GetBankRequestsPayload)
  break
case 'get_bank_logs':
  this.handleGetBankLogs(client, msg.payload as GetBankLogsPayload)
  break
case 'set_bank_permission':
  this.handleSetBankPermission(client, msg.payload as SetBankPermissionPayload)
  break
case 'set_bank_limit':
  this.handleSetBankLimit(client, msg.payload as SetBankLimitPayload)
  break
case 'set_player_override':
  this.handleSetPlayerOverride(client, msg.payload as SetPlayerOverridePayload)
  break
case 'remove_player_override':
  this.handleRemovePlayerOverride(client, msg.payload as RemovePlayerOverridePayload)
  break
```

**Add handler methods to the Hub class:**

```typescript
// ================================
// Guild Bank Handlers
// ================================

private async handleGetGuildBank(client: Client) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const bank = await getGuildBank(client.session.player.id, client.session.guild.id)
  if (!bank) {
    this.send(client, 'guild_bank_error', { error: 'Failed to load bank' })
    return
  }

  this.send(client, 'guild_bank_data', { bank })
}

private async handleDepositCurrency(client: Client, payload: DepositCurrencyPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await depositCurrencyToBank(
    client.session.player.id,
    client.session.guild.id,
    payload.amount
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Deposit failed' })
    return
  }

  // Broadcast to guild
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_currency_updated', {
    balance: result.new_balance,
    max_capacity: null, // Could fetch if needed
    player_id: client.session.player.id,
    player_username: client.session.player.username,
    amount: payload.amount,
    action: 'deposit'
  })
}

private async handleWithdrawCurrency(client: Client, payload: WithdrawCurrencyPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await withdrawCurrencyFromBank(
    client.session.player.id,
    client.session.guild.id,
    payload.amount
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Withdraw failed' })
    return
  }

  // Send remaining limit to requester
  this.send(client, 'guild_bank_my_limits', {
    currency: result.remaining_limit ?? -1,
    items: -1, // Could fetch all limits
    pokemon_points: -1
  })

  // Broadcast to guild
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_currency_updated', {
    balance: result.new_balance,
    max_capacity: null,
    player_id: client.session.player.id,
    player_username: client.session.player.username,
    amount: payload.amount,
    action: 'withdraw'
  })
}

private async handleDepositItem(client: Client, payload: DepositItemPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await depositItemToBank(
    client.session.player.id,
    client.session.guild.id,
    payload.item_id,
    payload.quantity
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Deposit failed' })
    return
  }

  // Broadcast item update
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_item_updated', {
    item: { item_id: payload.item_id, quantity: result.bank_quantity },
    player_id: client.session.player.id,
    player_username: client.session.player.username,
    quantity_changed: payload.quantity,
    action: 'deposit'
  })
}

private async handleWithdrawItem(client: Client, payload: WithdrawItemPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await withdrawItemFromBank(
    client.session.player.id,
    client.session.guild.id,
    payload.item_id,
    payload.quantity
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Withdraw failed' })
    return
  }

  // Send remaining limit
  this.send(client, 'guild_bank_my_limits', {
    currency: -1,
    items: result.remaining_limit ?? -1,
    pokemon_points: -1
  })

  // Broadcast (need to fetch current quantity)
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_item_updated', {
    item: { item_id: payload.item_id, quantity: -1 }, // UI should refetch
    player_id: client.session.player.id,
    player_username: client.session.player.username,
    quantity_changed: payload.quantity,
    action: 'withdraw'
  })
}

private async handleDepositPokemon(client: Client, payload: DepositPokemonPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await depositPokemonToBank(
    client.session.player.id,
    client.session.guild.id,
    payload.pokemon_id
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Deposit failed' })
    return
  }

  // Broadcast pokemon added (UI should refetch bank for full details)
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_pokemon_added', {
    pokemon: { pokemon_id: payload.pokemon_id, slot: result.slot },
    player_id: client.session.player.id,
    player_username: client.session.player.username
  })
}

private async handleWithdrawPokemon(client: Client, payload: WithdrawPokemonPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await withdrawPokemonFromBank(
    client.session.player.id,
    client.session.guild.id,
    payload.pokemon_id
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Withdraw failed' })
    return
  }

  // Send remaining points
  this.send(client, 'guild_bank_my_limits', {
    currency: -1,
    items: -1,
    pokemon_points: result.remaining_points ?? -1
  })

  // Broadcast pokemon removed
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_pokemon_removed', {
    pokemon_id: payload.pokemon_id,
    slot: -1, // UI should handle
    player_id: client.session.player.id,
    player_username: client.session.player.username
  })
}

private async handleExpandPokemonSlots(client: Client) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await expandBankPokemonSlots(
    client.session.player.id,
    client.session.guild.id
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Expansion failed' })
    return
  }

  // Broadcast expansion
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_slots_expanded', {
    new_total: result.new_total_slots,
    next_price: result.next_price,
    expanded_by: client.session.player.id,
    expanded_by_username: client.session.player.username
  })
}

private async handleCreateBankRequest(client: Client, payload: CreateBankRequestPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await createBankRequest(
    client.session.player.id,
    client.session.guild.id,
    payload.request_type,
    payload.details,
    payload.note
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Request failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Request created' })

  // Notify officers/leaders (broadcast to guild, UI filters by role)
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_request_created', {
    request: {
      id: result.request_id,
      player_id: client.session.player.id,
      player_username: client.session.player.username,
      request_type: payload.request_type,
      item_details: payload.details,
      status: 'pending',
      note: payload.note || null,
      created_at: new Date().toISOString(),
      expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    }
  })
}

private async handleFulfillBankRequest(client: Client, payload: FulfillBankRequestPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await fulfillBankRequest(
    client.session.player.id,
    client.session.guild.id,
    payload.request_id
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Fulfill failed' })
    return
  }

  // Broadcast fulfillment
  this.broadcastToGuild(client.session.guild.id, 'guild_bank_request_fulfilled', {
    request_id: payload.request_id,
    fulfilled_by: client.session.player.id,
    fulfilled_by_username: client.session.player.username
  })
}

private async handleCancelBankRequest(client: Client, payload: CancelBankRequestPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await cancelBankRequest(
    client.session.player.id,
    payload.request_id
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Cancel failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Request cancelled' })
}

private async handleGetBankRequests(client: Client, payload: GetBankRequestsPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const requests = await getBankRequests(
    client.session.guild.id,
    payload.include_expired || false
  )

  this.send(client, 'guild_bank_requests', { requests })
}

private async handleGetBankLogs(client: Client, payload: GetBankLogsPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await getBankLogs(
    client.session.player.id,
    client.session.guild.id,
    {
      page: payload.page,
      limit: payload.limit,
      filterPlayer: payload.filter_player,
      filterAction: payload.filter_action,
      filterCategory: payload.filter_category
    }
  )

  this.send(client, 'guild_bank_logs', {
    logs: result.logs,
    total: result.total,
    page: payload.page || 1
  })
}

private async handleSetBankPermission(client: Client, payload: SetBankPermissionPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await setBankPermission(
    client.session.player.id,
    client.session.guild.id,
    payload.category,
    payload.role,
    payload.can_deposit,
    payload.can_withdraw
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Permission update failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Permission updated' })
}

private async handleSetBankLimit(client: Client, payload: SetBankLimitPayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await setBankLimit(
    client.session.player.id,
    client.session.guild.id,
    payload.role,
    payload.category,
    payload.daily_limit,
    payload.pokemon_points_limit
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Limit update failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Limit updated' })
}

private async handleSetPlayerOverride(client: Client, payload: SetPlayerOverridePayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await setPlayerBankOverride(
    client.session.player.id,
    client.session.guild.id,
    payload.player_id,
    payload.category,
    payload.custom_limit
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Override update failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Override set' })
}

private async handleRemovePlayerOverride(client: Client, payload: RemovePlayerOverridePayload) {
  if (!client.session?.guild) {
    this.send(client, 'guild_bank_error', { error: 'Not in a guild' })
    return
  }

  const result = await removePlayerBankOverride(
    client.session.player.id,
    client.session.guild.id,
    payload.player_id,
    payload.category
  )

  if (!result.success) {
    this.send(client, 'guild_bank_error', { error: result.error || 'Override removal failed' })
    return
  }

  this.send(client, 'guild_bank_success', { success: true, message: 'Override removed' })
}
```

Add necessary imports at the top of hub.ts for the new types and db functions.
  </action>
  <verify>
Check apps/game-server/src/hub.ts contains:
- 17 new case statements in handleMessage switch
- 17 new handler methods
- Proper guild membership checks
- broadcastToGuild calls for state changes
- Error handling with guild_bank_error messages

Run: `npm run build` in apps/game-server to verify no errors
  </verify>
  <done>
All WebSocket handlers implemented for bank operations with proper error handling, permission checks, and guild broadcasts
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` passes in apps/game-server
2. All 18 db functions exist with proper RPC calls
3. All 17 handlers exist with guild membership checks
4. All type re-exports present in types.ts
5. broadcastToGuild used for all state-changing operations
</verification>

<success_criteria>
- Game server compiles without errors
- All bank operations have corresponding db.ts functions and hub.ts handlers
- Fire-and-forget async pattern followed (no await in switch cases)
- Error responses use guild_bank_error message type
- State changes broadcast to all guild members
</success_criteria>

<output>
After completion, create `.planning/phases/04-guild-bank/04-03-SUMMARY.md`
</output>
