---
phase: 04-guild-bank
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/026_guild_bank.sql
autonomous: true

must_haves:
  truths:
    - "Guild has a shared currency pool with configurable capacity"
    - "Guild has item storage organized by category with stack limits"
    - "Guild has Pokemon storage with slot-based capacity"
    - "Deposits and withdrawals are atomic with proper locking"
    - "All bank transactions are logged with full context"
    - "Daily withdrawal limits reset at midnight UTC"
    - "Members can create requests that expire after 24 hours"
    - "Query functions return formatted data for frontend consumption"
  artifacts:
    - path: "supabase/migrations/026_guild_bank.sql"
      provides: "Complete guild bank database schema"
      min_lines: 500
      contains: "guild_bank_currency"
  key_links:
    - from: "guild_bank_currency"
      to: "guilds"
      via: "FOREIGN KEY guild_id"
      pattern: "REFERENCES guilds\\(id\\)"
    - from: "guild_bank_pokemon"
      to: "pokemon"
      via: "FOREIGN KEY pokemon_id"
      pattern: "REFERENCES pokemon\\(id\\)"
    - from: "guild_bank_logs"
      to: "guild_members"
      via: "player_id verification in functions"
      pattern: "FROM guild_members WHERE player_id"
    - from: "get_guild_bank"
      to: "apps/game-server/src/db.ts"
      via: "RPC call from db.ts"
      pattern: "rpc\\('get_guild_bank'"
---

<objective>
Create the complete PostgreSQL schema for the guild bank system including tables for currency, items, Pokemon storage, permissions, withdrawal limits, request system, and transaction logging.

Purpose: Establish the data foundation that all guild bank features depend on. This follows the established SECURITY DEFINER pattern from Phase 1 (022_guilds.sql).

Output: Single migration file `026_guild_bank.sql` with all tables, enums, indexes, RLS policies, mutation functions, and query functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-guild-bank/04-RESEARCH.md
@.planning/phases/04-guild-bank/04-CONTEXT.md
@supabase/migrations/022_guilds.sql
@supabase/migrations/009_trades.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bank storage tables and enums</name>
  <files>supabase/migrations/026_guild_bank.sql</files>
  <action>
Create the core storage tables for guild bank:

**Enums:**
- `bank_category` ENUM: 'currency', 'item', 'pokemon'
- `bank_action` ENUM: 'deposit', 'withdraw', 'request_created', 'request_fulfilled', 'request_expired', 'request_cancelled'
- `request_status` ENUM: 'pending', 'fulfilled', 'expired', 'cancelled'

**Storage Tables:**

1. `guild_bank_currency` - One row per guild
   - guild_id UUID PRIMARY KEY REFERENCES guilds(id) ON DELETE CASCADE
   - balance BIGINT NOT NULL DEFAULT 0 CHECK (balance >= 0)
   - max_capacity BIGINT NOT NULL DEFAULT 50000
   - created_at TIMESTAMPTZ DEFAULT NOW()

2. `guild_bank_items` - One row per item type per guild
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - item_id VARCHAR(50) NOT NULL (matches inventory item_id pattern)
   - quantity INT NOT NULL DEFAULT 0 CHECK (quantity >= 0 AND quantity <= 99)
   - deposited_by UUID REFERENCES players(id) ON DELETE SET NULL
   - last_updated TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(guild_id, item_id)

3. `guild_bank_pokemon` - One row per Pokemon in bank
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - pokemon_id UUID NOT NULL REFERENCES pokemon(id) ON DELETE CASCADE
   - slot INT NOT NULL CHECK (slot >= 1)
   - deposited_by UUID REFERENCES players(id) ON DELETE SET NULL
   - deposited_at TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(guild_id, slot)
   - UNIQUE(pokemon_id) -- Pokemon can only be in one bank

4. `guild_bank_slots` - Track Pokemon slot count and expansions
   - guild_id UUID PRIMARY KEY REFERENCES guilds(id) ON DELETE CASCADE
   - base_slots INT NOT NULL DEFAULT 25
   - purchased_slots INT NOT NULL DEFAULT 0
   - next_expansion_price BIGINT NOT NULL DEFAULT 5000
   - created_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:**
- CREATE INDEX idx_guild_bank_items_guild ON guild_bank_items(guild_id)
- CREATE INDEX idx_guild_bank_pokemon_guild ON guild_bank_pokemon(guild_id)

**Trigger:** Create bank records when guild is created
- After INSERT on guilds: INSERT into guild_bank_currency and guild_bank_slots

Follow 022_guilds.sql patterns for table structure and constraints.
  </action>
  <verify>
SQL file exists and contains:
- All 4 storage tables with proper constraints
- All 3 enum types
- Indexes for performance
- Trigger for auto-creating bank on guild creation
  </verify>
  <done>
Storage tables (guild_bank_currency, guild_bank_items, guild_bank_pokemon, guild_bank_slots) exist with proper foreign keys, constraints, and indexes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create permissions, limits, and tracking tables</name>
  <files>supabase/migrations/026_guild_bank.sql</files>
  <action>
Add permission configuration, withdrawal tracking, and request system tables:

**Permission Tables:**

1. `guild_bank_permissions` - Per-category per-role permissions
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - category bank_category NOT NULL
   - role guild_role NOT NULL
   - can_deposit BOOLEAN NOT NULL DEFAULT true
   - can_withdraw BOOLEAN NOT NULL DEFAULT false
   - UNIQUE(guild_id, category, role)

2. `guild_bank_limits` - Daily withdrawal limits per role
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - role guild_role NOT NULL
   - category bank_category NOT NULL
   - daily_limit INT NOT NULL DEFAULT 0 (0 = no permission)
   - pokemon_points_limit INT NOT NULL DEFAULT 0 (only for pokemon category)
   - UNIQUE(guild_id, role, category)

3. `guild_bank_player_overrides` - Individual player limit overrides
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE
   - category bank_category NOT NULL
   - custom_limit INT NOT NULL
   - set_by UUID REFERENCES players(id) ON DELETE SET NULL
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(guild_id, player_id, category)

**Tracking Tables:**

4. `guild_bank_withdrawals` - Track daily usage
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE
   - category bank_category NOT NULL
   - amount_or_points INT NOT NULL (currency amount, item count, or pokemon points)
   - withdrawn_at TIMESTAMPTZ DEFAULT NOW()

5. `guild_bank_requests` - Member request queue
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE
   - request_type bank_category NOT NULL
   - item_details JSONB NOT NULL (amount, item_id+quantity, or pokemon_id)
   - status request_status NOT NULL DEFAULT 'pending'
   - note TEXT
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours')
   - fulfilled_by UUID REFERENCES players(id) ON DELETE SET NULL
   - fulfilled_at TIMESTAMPTZ

**Transaction Log:**

6. `guild_bank_logs` - Full audit trail
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE
   - player_id UUID NOT NULL REFERENCES players(id) ON DELETE SET NULL
   - action bank_action NOT NULL
   - category bank_category NOT NULL
   - details JSONB NOT NULL
   - balance_after BIGINT (for currency transactions)
   - created_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:**
- CREATE INDEX idx_guild_bank_withdrawals_daily ON guild_bank_withdrawals(guild_id, player_id, category, withdrawn_at)
- CREATE INDEX idx_guild_bank_requests_pending ON guild_bank_requests(guild_id, status) WHERE status = 'pending'
- CREATE INDEX idx_guild_bank_logs_guild ON guild_bank_logs(guild_id, created_at DESC)
- CREATE INDEX idx_guild_bank_logs_player ON guild_bank_logs(guild_id, player_id, created_at DESC)

**Default Permissions Trigger:** When guild_bank_currency created, insert default permissions:
- All roles: can_deposit = true for all categories
- Leader: can_withdraw = true, daily_limit = -1 (unlimited)
- Officer: can_withdraw = true, daily_limit = 10000 currency, 20 items, 20 pokemon points
- Member: can_withdraw = false, daily_limit = 0
  </action>
  <verify>
SQL file contains:
- Permission tables (permissions, limits, player_overrides)
- Tracking tables (withdrawals, requests)
- Logs table with JSONB details
- Indexes for common query patterns
- Default permissions trigger
  </verify>
  <done>
Permission system tables exist with default triggers, withdrawal tracking ready for daily limit checks, request queue table with expiration, and transaction log table ready
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SECURITY DEFINER functions for bank mutations</name>
  <files>supabase/migrations/026_guild_bank.sql</files>
  <action>
Create atomic SECURITY DEFINER functions with FOR UPDATE locking for all bank operations:

**Helper Functions:**

1. `check_bank_permission(p_guild_id, p_player_id, p_category, p_action)` -> BOOLEAN
   - Check if player has permission for action on category
   - Leaders always return true for withdraw
   - Check guild_bank_permissions table for role-based permissions

2. `get_remaining_daily_limit(p_guild_id, p_player_id, p_category)` -> INT
   - Returns -1 for leaders (unlimited)
   - Returns 0 if no permission
   - Calculates: configured_limit - SUM(today's withdrawals)
   - Today = since midnight UTC using date_trunc('day', NOW() AT TIME ZONE 'UTC')

3. `calculate_pokemon_point_cost(p_species_id)` -> INT
   - BST-based tier calculation:
   - >= 580: 25 points (Legendary)
   - >= 500: 10 points (Very Rare)
   - >= 400: 5 points (Rare)
   - >= 300: 2 points (Uncommon)
   - < 300: 1 point (Common)

4. `calculate_max_pokemon_slots(p_guild_id)` -> INT
   - Returns: base_slots + purchased_slots + (member_count * 2)
   - Cap at 500 max

**Currency Functions:**

5. `guild_bank_deposit_currency(p_player_id, p_guild_id, p_amount)` -> JSON
   - Verify membership and deposit permission
   - Lock player row, verify sufficient balance
   - Lock bank row, verify won't exceed capacity
   - Deduct from player, add to bank
   - Log transaction with balance_after
   - Return {success, new_balance, error?}

6. `guild_bank_withdraw_currency(p_player_id, p_guild_id, p_amount)` -> JSON
   - Verify membership and withdraw permission
   - Check daily limit remaining
   - Lock bank row, verify sufficient balance
   - Lock player row
   - Deduct from bank, add to player
   - Record withdrawal in tracking table
   - Log transaction with balance_after
   - Return {success, new_balance, remaining_limit, error?}

**Item Functions:**

7. `guild_bank_deposit_item(p_player_id, p_guild_id, p_item_id, p_quantity)` -> JSON
   - Verify membership and deposit permission
   - Lock player inventory row, verify sufficient quantity
   - Lock or create bank item row (UPSERT)
   - Verify won't exceed 99 stack
   - Transfer quantity
   - Log transaction
   - Return {success, bank_quantity, error?}

8. `guild_bank_withdraw_item(p_player_id, p_guild_id, p_item_id, p_quantity)` -> JSON
   - Verify membership and withdraw permission
   - Check daily limit (count items withdrawn today)
   - Lock bank item row, verify sufficient quantity
   - Lock player inventory row (UPSERT)
   - Transfer quantity
   - Record withdrawal in tracking
   - Log transaction
   - Return {success, remaining_limit, error?}

**Pokemon Functions:**

9. `guild_bank_deposit_pokemon(p_player_id, p_guild_id, p_pokemon_id)` -> JSON
   - Verify membership and deposit permission
   - Verify player owns pokemon and it's not in party
   - Lock pokemon row
   - Calculate current slots used, verify under max
   - Find first available slot
   - Clear owner_id, set guild bank reference
   - Insert into guild_bank_pokemon
   - Log transaction with pokemon details
   - Return {success, slot, error?}

10. `guild_bank_withdraw_pokemon(p_player_id, p_guild_id, p_pokemon_id)` -> JSON
    - Verify membership and withdraw permission
    - Get pokemon details for point cost calculation
    - Check daily points limit remaining
    - Lock pokemon row and bank entry
    - Set pokemon owner_id back to player
    - Delete from guild_bank_pokemon
    - Record withdrawal with point cost
    - Log transaction
    - Return {success, remaining_points, error?}

**Request Functions:**

11. `guild_bank_create_request(p_player_id, p_guild_id, p_type, p_details, p_note)` -> JSON
    - Verify membership
    - Clean up expired requests (opportunistic)
    - Insert request with 24hr expiration
    - Log request_created
    - Return {success, request_id, error?}

12. `guild_bank_fulfill_request(p_fulfiller_id, p_guild_id, p_request_id)` -> JSON
    - Verify fulfiller has withdraw permission
    - Lock request row, verify pending and not expired
    - Execute appropriate withdraw operation (currency/item/pokemon)
    - Mark request fulfilled, set fulfiller and timestamp
    - Log request_fulfilled
    - Return {success, error?}

13. `guild_bank_cancel_request(p_player_id, p_request_id)` -> JSON
    - Verify player owns request
    - Lock and update status to cancelled
    - Log request_cancelled
    - Return {success, error?}

**Slot Expansion Function:**

14. `guild_bank_expand_pokemon_slots(p_player_id, p_guild_id)` -> JSON
    - Verify player is leader
    - Lock bank currency and slots rows
    - Verify sufficient balance for next_expansion_price
    - Verify won't exceed 500 total slots
    - Deduct currency, add 10 slots
    - Update next_expansion_price (double it)
    - Log transaction
    - Return {success, new_total_slots, next_price, error?}

**RLS Policies:**
- Block all direct INSERT/UPDATE/DELETE on bank tables
- Allow SELECT for guild members on their guild's data
- Allow SELECT on guild_bank_logs filtered by role (full for leader/officer, own-only for member)

Add RLS to all tables:
```sql
ALTER TABLE guild_bank_currency ENABLE ROW LEVEL SECURITY;
-- etc for all tables

-- Example policy for logs
CREATE POLICY "Guild members can view logs"
  ON guild_bank_logs FOR SELECT
  USING (
    guild_id IN (
      SELECT gm.guild_id FROM guild_members gm WHERE gm.player_id = auth.uid()
    )
    AND (
      -- Leaders and officers see all
      EXISTS (SELECT 1 FROM guild_members gm WHERE gm.player_id = auth.uid() AND gm.guild_id = guild_bank_logs.guild_id AND gm.role IN ('leader', 'officer'))
      OR
      -- Members see only their own
      player_id = auth.uid()
    )
  );
```
  </action>
  <verify>
SQL file contains:
- All 14 SECURITY DEFINER mutation functions with FOR UPDATE locking
- Helper functions for permissions and limits
- Pokemon point calculation function
- RLS policies blocking direct mutations
- RLS policies for read access with role-based filtering
Run: Check SQL syntax by reviewing the file structure
  </verify>
  <done>
All SECURITY DEFINER mutation functions created for deposit, withdraw, requests, and slot expansion with proper locking, limit checking, and transaction logging. RLS policies in place.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create SECURITY DEFINER functions for bank queries</name>
  <files>supabase/migrations/026_guild_bank.sql</files>
  <action>
Create SECURITY DEFINER query functions that Plan 04-03 calls via RPC. These functions format data for frontend consumption.

**Bank State Query Functions:**

1. `get_guild_bank(p_player_id UUID, p_guild_id UUID)` -> JSON
   - Verify player is member of guild
   - Return complete bank state as JSON:
   ```json
   {
     "currency": { "balance": number, "max_capacity": number },
     "items": [ { "item_id": string, "quantity": number, "deposited_by": uuid, "deposited_by_username": string, "last_updated": timestamp } ],
     "pokemon": [ { "id": uuid, "pokemon_id": uuid, "slot": number, "species_id": number, "species_name": string, "nickname": string|null, "level": number, "is_shiny": boolean, "point_cost": number, "deposited_by": uuid, "deposited_by_username": string, "deposited_at": timestamp } ],
     "pokemon_slots": { "used": number, "max": number, "base": number, "purchased": number, "next_expansion_price": number },
     "permissions": [ { "category": string, "role": string, "can_deposit": boolean, "can_withdraw": boolean } ],
     "limits": [ { "role": string, "category": string, "daily_limit": number, "pokemon_points_limit": number } ],
     "my_limits": { "currency": number, "items": number, "pokemon_points": number }
   }
   ```
   - Join pokemon with pokemon_species for species_name
   - Join deposited_by with players for username
   - Calculate point_cost using calculate_pokemon_point_cost()
   - Calculate my_limits using get_remaining_daily_limit() for each category

2. `get_bank_daily_limits(p_player_id UUID, p_guild_id UUID)` -> JSON
   - Verify membership
   - Return { currency: number, items: number, pokemon_points: number }
   - Each value is remaining limit for today (-1 = unlimited)
   - Uses get_remaining_daily_limit() helper for each category

3. `get_bank_requests(p_guild_id UUID, p_include_expired BOOLEAN)` -> JSON ARRAY
   - Return array of request objects:
   ```json
   [
     {
       "id": uuid,
       "player_id": uuid,
       "player_username": string,
       "request_type": string,
       "item_details": jsonb,
       "status": string,
       "note": string|null,
       "created_at": timestamp,
       "expires_at": timestamp,
       "fulfilled_by": uuid|null,
       "fulfilled_by_username": string|null,
       "fulfilled_at": timestamp|null
     }
   ]
   ```
   - If p_include_expired is false, only return status = 'pending' and expires_at > NOW()
   - Join with players table for usernames
   - Order by created_at DESC

4. `get_bank_logs(p_player_id UUID, p_guild_id UUID, p_page INT, p_limit INT, p_filter_player UUID, p_filter_action TEXT, p_filter_category TEXT)` -> JSON
   - Verify membership and check role
   - If role is 'member', only return logs where player_id = p_player_id
   - If role is 'leader' or 'officer', return all logs for the guild
   - Apply optional filters (p_filter_player, p_filter_action, p_filter_category)
   - Return:
   ```json
   {
     "logs": [ { "id": uuid, "player_id": uuid, "player_username": string, "action": string, "category": string, "details": jsonb, "balance_after": number|null, "created_at": timestamp } ],
     "total": number
   }
   ```
   - Paginate using OFFSET and LIMIT
   - Join with players for username
   - Order by created_at DESC

**Permission Configuration Functions (leader only):**

5. `set_bank_permission(p_player_id UUID, p_guild_id UUID, p_category TEXT, p_role TEXT, p_can_deposit BOOLEAN, p_can_withdraw BOOLEAN)` -> JSON
   - Verify p_player_id is leader of guild
   - UPSERT into guild_bank_permissions
   - Return { success: true } or { success: false, error: string }

6. `set_bank_limit(p_player_id UUID, p_guild_id UUID, p_role TEXT, p_category TEXT, p_daily_limit INT, p_pokemon_points_limit INT)` -> JSON
   - Verify p_player_id is leader of guild
   - UPSERT into guild_bank_limits
   - Return { success: true } or { success: false, error: string }

7. `set_player_bank_override(p_setter_id UUID, p_guild_id UUID, p_target_player_id UUID, p_category TEXT, p_custom_limit INT)` -> JSON
   - Verify p_setter_id is leader of guild
   - Verify p_target_player_id is member of same guild
   - UPSERT into guild_bank_player_overrides
   - Return { success: true } or { success: false, error: string }

8. `remove_player_bank_override(p_remover_id UUID, p_guild_id UUID, p_target_player_id UUID, p_category TEXT)` -> JSON
   - Verify p_remover_id is leader of guild
   - DELETE from guild_bank_player_overrides
   - Return { success: true } or { success: false, error: string }

All functions should be SECURITY DEFINER and follow the same error handling patterns as existing guild functions.
  </action>
  <verify>
SQL file contains:
- get_guild_bank function returning complete bank state
- get_bank_daily_limits function returning remaining limits
- get_bank_requests function with filtering and pagination
- get_bank_logs function with role-based filtering and pagination
- set_bank_permission, set_bank_limit functions for leader configuration
- set_player_bank_override, remove_player_bank_override functions
All 8 query/configuration functions present with proper return types.
  </verify>
  <done>
All query functions created: get_guild_bank, get_bank_daily_limits, get_bank_requests, get_bank_logs for reading data, and set_bank_permission, set_bank_limit, set_player_bank_override, remove_player_bank_override for configuration.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. SQL file exists at supabase/migrations/026_guild_bank.sql
2. File contains all required tables (10 tables total)
3. File contains all SECURITY DEFINER mutation functions (14 functions)
4. File contains all SECURITY DEFINER query functions (8 functions)
5. File contains RLS policies for all tables
6. File is syntactically valid SQL (no unclosed statements)
</verification>

<success_criteria>
- Migration file exists with complete schema
- Tables cover currency, items, Pokemon, permissions, limits, tracking, requests, logs
- Atomic mutation functions handle all bank operations with proper locking
- Query functions return formatted JSON for frontend consumption
- RLS enforces guild membership checks and role-based log visibility
- Default permissions created automatically when guild bank initialized
</success_criteria>

<output>
After completion, create `.planning/phases/04-guild-bank/04-01-SUMMARY.md`
</output>
