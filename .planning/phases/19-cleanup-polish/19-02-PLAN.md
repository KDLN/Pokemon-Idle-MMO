---
phase: 19-cleanup-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/.storybook/main.ts
  - apps/web/package.json
  - apps/web/src/stories/showcase/BattleUI.mdx
  - apps/web/src/stories/showcase/PartyUI.mdx
  - apps/web/src/stories/showcase/MapUI.mdx
  - apps/web/src/stories/showcase/SocialUI.mdx
  - apps/web/src/stories/showcase/InventoryUI.mdx
  - apps/web/src/stories/showcase/CoreUI.mdx
  - apps/web/.eslintrc.json
autonomous: true

must_haves:
  truths:
    - "Storybook builds successfully to public/storybook"
    - "/storybook route serves component documentation in production"
    - "npm run build executes Storybook build before Next.js build"
    - "Modern theme components are showcased"
  artifacts:
    - path: "apps/web/public/storybook/index.html"
      provides: "Storybook entry point served at /storybook"
    - path: "apps/web/package.json"
      provides: "Updated build script with Storybook integration"
    - path: "apps/web/.storybook/main.ts"
      provides: "Storybook config with correct output directory"
  key_links:
    - from: "npm run build"
      to: "storybook build --output-dir public/storybook"
      via: "package.json scripts"
    - from: "Next.js static serving"
      to: "public/storybook/"
      via: "Static file serving"
---

<objective>
Integrate Storybook into the production build pipeline so component documentation is accessible at /storybook.

Purpose: The design system and component library need documentation accessible to designers and developers. Storybook provides interactive component examples with all states (hover, active, disabled, loading).

Output: Storybook builds to public/storybook and is served at /storybook in production.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/19-cleanup-polish/19-CONTEXT.md
@.planning/phases/19-cleanup-polish/19-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Storybook MDX indexing errors</name>
  <files>
    - apps/web/src/stories/showcase/BattleUI.mdx
    - apps/web/src/stories/showcase/PartyUI.mdx
    - apps/web/src/stories/showcase/MapUI.mdx
    - apps/web/src/stories/showcase/SocialUI.mdx
    - apps/web/src/stories/showcase/InventoryUI.mdx
    - apps/web/src/stories/showcase/CoreUI.mdx
    - apps/web/.storybook/main.ts
  </files>
  <action>
The Storybook build fails with MDX indexing errors:
```
Unable to index files:
- ./src/stories/showcase/BattleUI.mdx: Unexpected character `2`
- ./src/stories/showcase/InventoryUI.mdx: Unexpected character `1`
```

**Approach 1 (Try first): Run Storybook automigrate**
```bash
cd apps/web && npx storybook automigrate
```
This may auto-fix MDX compatibility issues.

**Approach 2: Simplify MDX files**
If automigrate doesn't fix it, the issue is likely MDX v2/v3 parsing. Check each MDX file for:
- JSX expressions that need escaping
- Import paths with special characters
- HTML comments that aren't MDX-compatible

Common fixes:
- Wrap numeric expressions: `{2}` should be `{'2'}` if used in JSX
- Use proper MDX comment syntax: `{/* comment */}` not `<!-- comment -->`
- Ensure all imports resolve correctly

**Approach 3: Exclude problematic MDX (fallback)**
If MDX files can't be fixed quickly, temporarily exclude them and keep .stories.tsx files:
```typescript
// .storybook/main.ts
stories: [
  "../src/**/*.stories.@(js|jsx|mjs|ts|tsx)"
  // Temporarily exclude MDX: "../src/**/*.mdx"
]
```

**Verify with:**
```bash
cd apps/web && npm run build-storybook
```
Build should complete without errors.
  </action>
  <verify>
`cd apps/web && npm run build-storybook` completes successfully without "Unable to index" errors
  </verify>
  <done>Storybook builds without MDX indexing errors</done>
</task>

<task type="auto">
  <name>Task 2: Configure Storybook for production deployment</name>
  <files>
    - apps/web/package.json
    - apps/web/.storybook/main.ts
    - apps/web/.eslintrc.json (or eslint.config.js)
  </files>
  <action>
**Update package.json scripts:**
```json
{
  "scripts": {
    "build": "cd ../../packages/shared && npm run build && cd ../../apps/web && npm run build:storybook && next build",
    "build:storybook": "storybook build --output-dir public/storybook",
    "storybook": "storybook dev -p 6006"
  }
}
```

Key changes:
1. Add `build:storybook` script with `--output-dir public/storybook`
2. Update `build` to run `npm run build:storybook` BEFORE `next build`
3. Order matters: Storybook outputs to public/, Next.js includes public/ in build

**Update ESLint to ignore Storybook output:**
Add to eslint config (find correct file format):
```json
{
  "ignorePatterns": ["public/storybook/**"]
}
```
Or if using flat config (eslint.config.js):
```javascript
{
  ignores: ["public/storybook/**"]
}
```

**Verify build order works:**
The `staticDirs: ["../public"]` in Storybook config is fine - it copies public/ TO storybook output. We're doing the opposite: outputting TO public/storybook.

**Important:** After first build, the public/storybook folder will be large (~50MB). Consider adding to .gitignore:
```
# Storybook build output (generated during deploy)
public/storybook/
```
  </action>
  <verify>
1. `cd apps/web && npm run build:storybook` creates `public/storybook/index.html`
2. `ls public/storybook/` shows Storybook assets (index.html, *.js, *.css)
3. `npm run build` (full build) completes successfully including Storybook
  </verify>
  <done>Storybook builds to public/storybook, integrated into npm run build, ESLint ignores output</done>
</task>

<task type="auto">
  <name>Task 3: Add public/storybook to .gitignore and verify deployment</name>
  <files>
    - apps/web/.gitignore
  </files>
  <action>
**Update .gitignore:**
Add entry to ignore generated Storybook output:
```
# Storybook build output (regenerated during deploy)
public/storybook/
```

**Clean up any committed Storybook files:**
If Storybook was previously built and committed, remove it:
```bash
git rm -r --cached apps/web/public/storybook/ 2>/dev/null || echo "Not tracked"
```

**Local verification:**
Start production server locally to verify /storybook serves correctly:
```bash
cd apps/web
npm run build
npm run start
# Visit http://localhost:3000/storybook/
```

The route should show:
- Storybook sidebar with component list
- Button, Card, Badge stories working
- Theme applied correctly (Modern theme)

**Vercel deployment note:**
Vercel will run `npm run build` which now includes Storybook build.
The public/storybook/ folder will be included in deployment automatically.
  </action>
  <verify>
1. `git status` shows public/storybook/ not tracked (if previously was)
2. After `npm run build && npm start`, visiting `http://localhost:3000/storybook/` shows Storybook UI
3. Component stories render correctly with Modern theme
  </verify>
  <done>public/storybook gitignored, /storybook route serves component documentation</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` completes (includes Storybook build)
2. `ls apps/web/public/storybook/index.html` exists
3. `npm run start` then curl `http://localhost:3000/storybook/` returns HTML
4. `cat apps/web/.gitignore | grep "public/storybook"` shows entry
</verification>

<success_criteria>
- Storybook builds without errors
- Output goes to public/storybook/
- npm run build includes Storybook step
- /storybook route accessible in production
- ESLint ignores Storybook output files
- Storybook output not committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/19-cleanup-polish/19-02-SUMMARY.md`
</output>
