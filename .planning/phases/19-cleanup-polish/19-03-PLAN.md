---
phase: 19-cleanup-polish
plan: 03
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - apps/web/package.json
  - apps/web/playwright.config.ts
  - apps/web/e2e/auth/login.spec.ts
  - apps/web/e2e/auth/signup.spec.ts
  - apps/web/e2e/gameplay/zone-navigation.spec.ts
  - apps/web/e2e/gameplay/party-management.spec.ts
  - apps/web/e2e/guild/guild-basics.spec.ts
  - apps/web/e2e/helpers/auth.ts
  - apps/web/.gitignore
autonomous: false

must_haves:
  truths:
    - "Core gameplay loop verified via automated tests (login, zone navigation, party management)"
    - "Guild features verified via automated tests (panel access, chat, channels)"
    - "No regressions detected at desktop (1440px), tablet (768px), and mobile (375px) breakpoints"
    - "All E2E tests pass across all three viewport configurations"
  artifacts:
    - path: "apps/web/playwright.config.ts"
      provides: "Playwright configuration with 3 viewport sizes"
    - path: "apps/web/e2e/auth/login.spec.ts"
      provides: "Login flow tests"
    - path: "apps/web/e2e/gameplay/zone-navigation.spec.ts"
      provides: "Zone navigation tests"
    - path: "apps/web/e2e/guild/guild-basics.spec.ts"
      provides: "Guild creation and chat tests"
  key_links:
    - from: "npm run test:e2e"
      to: "playwright test"
      via: "package.json scripts"
    - from: "E2E tests"
      to: "localhost:3000"
      via: "webServer config in playwright.config.ts"
---

<objective>
Set up Playwright E2E testing to verify all core features work correctly at all breakpoints.

Purpose: v1.2 theme finalization changed significant UI code. E2E tests provide automated verification that core gameplay loop and guild features still function. Testing at 3 breakpoints catches responsive regressions.

Output: Playwright configured with passing E2E tests for core gameplay and guild features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/19-cleanup-polish/19-CONTEXT.md
@.planning/phases/19-cleanup-polish/19-RESEARCH.md

# Prior plan context (code cleanup must be complete first)
@.planning/phases/19-cleanup-polish/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright</name>
  <files>
    - apps/web/package.json
    - apps/web/playwright.config.ts
    - apps/web/.gitignore
  </files>
  <action>
**Install Playwright:**
```bash
cd apps/web
npm init playwright@latest
```

When prompted:
- Where to put E2E tests: `e2e`
- Add GitHub Actions workflow: `No` (manual runs for now)
- Install browsers: `Yes`

**Configure playwright.config.ts:**
```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    // Desktop (1440px) - primary development target
    {
      name: 'desktop',
      use: {
        ...devices['Desktop Chrome'],
        viewport: { width: 1440, height: 900 }
      },
    },
    // Tablet (768px) - iPad portrait
    {
      name: 'tablet',
      use: {
        ...devices['iPad'],
        viewport: { width: 768, height: 1024 }
      },
    },
    // Mobile (375px) - iPhone 13
    {
      name: 'mobile',
      use: {
        ...devices['iPhone 13'],
        viewport: { width: 375, height: 812 }
      },
    },
  ],
  webServer: {
    command: 'npm run start',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
})
```

**Add package.json scripts:**
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:headed": "playwright test --headed"
  }
}
```

**Update .gitignore:**
```
# Playwright
/test-results/
/playwright-report/
/blob-report/
/playwright/.cache/
```

**Create test directory structure:**
```
e2e/
  auth/
    login.spec.ts
    signup.spec.ts
  gameplay/
    zone-navigation.spec.ts
    party-management.spec.ts
  guild/
    guild-basics.spec.ts
  helpers/
    auth.ts
```
  </action>
  <verify>
1. `cd apps/web && npx playwright --version` returns version
2. `ls apps/web/e2e/` shows directory structure
3. `ls apps/web/playwright.config.ts` exists
  </verify>
  <done>Playwright installed with 3-viewport config, test scripts added, directory structure created</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E tests for core gameplay</name>
  <files>
    - apps/web/e2e/auth/login.spec.ts
    - apps/web/e2e/gameplay/zone-navigation.spec.ts
    - apps/web/e2e/gameplay/party-management.spec.ts
    - apps/web/e2e/helpers/auth.ts
  </files>
  <action>
**Create auth helper (e2e/helpers/auth.ts):**
```typescript
import { Page } from '@playwright/test'

// Test account credentials (create in Supabase if needed)
export const TEST_USER = {
  email: 'e2e-test@pokemon-idle.local',
  password: 'TestPassword123!'
}

export async function login(page: Page) {
  await page.goto('/login')
  await page.fill('[name="email"]', TEST_USER.email)
  await page.fill('[name="password"]', TEST_USER.password)
  await page.click('button[type="submit"]')
  // Wait for redirect to game
  await page.waitForURL('**/game**', { timeout: 10000 })
}

export async function waitForGameLoad(page: Page) {
  // Wait for WebSocket connection and initial state
  // Use CSS selectors - more resilient than data-testid for existing components
  await page.waitForSelector('[class*="game-shell"], [class*="GameShell"], main', { timeout: 15000 })
}
```

**Create login test (e2e/auth/login.spec.ts):**
```typescript
import { test, expect } from '@playwright/test'
import { TEST_USER } from '../helpers/auth'

test.describe('Login Flow', () => {
  test('shows login form', async ({ page }) => {
    await page.goto('/login')
    await expect(page.getByRole('heading', { name: /sign in/i })).toBeVisible()
    await expect(page.locator('[name="email"]')).toBeVisible()
    await expect(page.locator('[name="password"]')).toBeVisible()
  })

  test('redirects to game on successful login', async ({ page }) => {
    await page.goto('/login')
    await page.fill('[name="email"]', TEST_USER.email)
    await page.fill('[name="password"]', TEST_USER.password)
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL(/.*game.*/, { timeout: 10000 })
  })

  test('shows error on invalid credentials', async ({ page }) => {
    await page.goto('/login')
    await page.fill('[name="email"]', 'invalid@test.com')
    await page.fill('[name="password"]', 'wrongpassword')
    await page.click('button[type="submit"]')
    await expect(page.getByText(/invalid/i)).toBeVisible({ timeout: 5000 })
  })
})
```

**Create zone navigation test (e2e/gameplay/zone-navigation.spec.ts):**
```typescript
import { test, expect } from '@playwright/test'
import { login, waitForGameLoad } from '../helpers/auth'

test.describe('Zone Navigation', () => {
  test.beforeEach(async ({ page }) => {
    await login(page)
    await waitForGameLoad(page)
  })

  test('displays current zone', async ({ page }) => {
    // Should show zone name (Pallet Town for new players)
    await expect(page.getByText(/pallet town|route 1/i)).toBeVisible()
  })

  test('shows travel buttons', async ({ page }) => {
    // Should have navigation buttons to adjacent zones - use text content selector
    const travelButtons = page.locator('button:has-text("Travel"), button:has-text("Route"), button:has-text("Town")')
    await expect(travelButtons.first()).toBeVisible()
  })

  test('can navigate to adjacent zone', async ({ page }) => {
    // Click first available travel option
    const travelButton = page.locator('button:has-text("Route")').first()
    if (await travelButton.isVisible()) {
      const buttonText = await travelButton.textContent()
      await travelButton.click()
      // Wait for zone change
      await page.waitForTimeout(1000)
      // Zone should have changed
      await expect(page.getByText(buttonText || '')).toBeVisible()
    }
  })
})
```

**Create party management test (e2e/gameplay/party-management.spec.ts):**
```typescript
import { test, expect } from '@playwright/test'
import { login, waitForGameLoad } from '../helpers/auth'

test.describe('Party Management', () => {
  test.beforeEach(async ({ page }) => {
    await login(page)
    await waitForGameLoad(page)
  })

  test('displays party panel', async ({ page, isMobile }) => {
    // On mobile, may need to click Party tab
    if (isMobile) {
      const partyTab = page.getByRole('tab', { name: /party/i })
      if (await partyTab.isVisible()) {
        await partyTab.click()
      }
    }

    // Should show party section with Pokemon - use class selector
    await expect(page.locator('[class*="party"], [class*="Party"]').first()).toBeVisible()
  })

  test('shows Pokemon in party', async ({ page, isMobile }) => {
    if (isMobile) {
      const partyTab = page.getByRole('tab', { name: /party/i })
      if (await partyTab.isVisible()) {
        await partyTab.click()
      }
    }

    // Should show at least one Pokemon (starter) - use class selector for pokemon cards
    const pokemonCard = page.locator('[class*="pokemon"], [class*="Pokemon"]').first()
    await expect(pokemonCard).toBeVisible({ timeout: 10000 })
  })
})
```

Note: Tests use CSS class selectors which are more resilient with existing components. If tests are brittle, add data-testid attributes incrementally.
  </action>
  <verify>
```bash
cd apps/web
npm run build  # Ensure production build
npm run test:e2e -- --project=desktop --grep "Login|Zone|Party"
```
Tests should pass (or fail with meaningful errors to fix).
  </verify>
  <done>Core gameplay E2E tests created - login flow, zone navigation, party management</done>
</task>

<task type="auto">
  <name>Task 3: Create E2E tests for guild features</name>
  <files>
    - apps/web/e2e/guild/guild-basics.spec.ts
  </files>
  <action>
**Create guild tests (e2e/guild/guild-basics.spec.ts):**
```typescript
import { test, expect } from '@playwright/test'
import { login, waitForGameLoad } from '../helpers/auth'

test.describe('Guild Features', () => {
  test.beforeEach(async ({ page }) => {
    await login(page)
    await waitForGameLoad(page)
  })

  test('can access guild panel', async ({ page, isMobile }) => {
    // On mobile, may need to navigate to Social tab
    if (isMobile) {
      const socialTab = page.getByRole('tab', { name: /social/i })
      if (await socialTab.isVisible()) {
        await socialTab.click()
      }
    }

    // Look for guild UI elements - use class selector
    const guildSection = page.locator('[class*="guild"], [class*="Guild"]')
    await expect(guildSection.first()).toBeVisible({ timeout: 10000 })
  })

  test('shows chat interface', async ({ page, isMobile }) => {
    if (isMobile) {
      const socialTab = page.getByRole('tab', { name: /social/i })
      if (await socialTab.isVisible()) {
        await socialTab.click()
      }
    }

    // Chat panel should be visible - use class selector
    const chatPanel = page.locator('[class*="chat"], [class*="Chat"]')
    await expect(chatPanel.first()).toBeVisible()
  })

  test('can switch chat channels', async ({ page, isMobile }) => {
    if (isMobile) {
      const socialTab = page.getByRole('tab', { name: /social/i })
      if (await socialTab.isVisible()) {
        await socialTab.click()
      }
    }

    // Look for channel tabs/buttons (Global, Zone, Guild, etc.)
    const channelSelector = page.locator('button:has-text("Global"), button:has-text("Zone"), button:has-text("Guild")')
    await expect(channelSelector.first()).toBeVisible()
  })

  test('chat input is functional', async ({ page, isMobile }) => {
    if (isMobile) {
      const socialTab = page.getByRole('tab', { name: /social/i })
      if (await socialTab.isVisible()) {
        await socialTab.click()
      }
    }

    // Find chat input - use placeholder selector
    const chatInput = page.locator('input[placeholder*="message"], textarea[placeholder*="message"], input[placeholder*="Message"]')
    await expect(chatInput.first()).toBeVisible()

    // Should be able to type (but don't actually send in test)
    await chatInput.first().fill('Test message')
    await expect(chatInput.first()).toHaveValue('Test message')
  })
})
```

Note: Guild creation/joining requires specific test data setup. These tests verify the UI is accessible and functional, not that a user can create a new guild (which would require cleanup logic).
  </action>
  <verify>
```bash
cd apps/web
npm run test:e2e -- --project=desktop --grep "Guild"
```
Guild tests pass (or identify specific UI issues to fix).
  </verify>
  <done>Guild E2E tests created - panel access, chat interface, channel switching</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>E2E test suite with Playwright covering core gameplay and guild features at 3 viewports</what-built>
  <how-to-verify>
**Run full E2E test suite:**
```bash
cd apps/web
npm run build
npm run test:e2e
```

**Check results:**
1. All 3 projects run: desktop, tablet, mobile
2. Tests pass (or identify specific failures)
3. Review HTML report: `npx playwright show-report`

**Manual verification checklist:**
Run the app locally and manually verify at each breakpoint:

Desktop (1440px):
- [ ] Login flow works
- [ ] Zone navigation buttons visible and functional
- [ ] Party panel shows Pokemon on left sidebar
- [ ] Chat panel shows on right, channels switchable
- [ ] Guild panel accessible

Tablet (768px):
- [ ] Same features work
- [ ] Layout adjusts appropriately

Mobile (375px):
- [ ] Tab navigation works (Zone / Party / Social / Map)
- [ ] Each tab shows correct content
- [ ] Touch targets are 44px minimum
- [ ] No horizontal scroll

**Pass criteria:**
- All automated tests pass (0 failures across 3 viewports)
- Manual checklist items all checked
- No visual regressions observed
  </how-to-verify>
  <resume-signal>
Type "verified" when all tests pass and manual verification complete.

If regressions found:
1. List each regression with description (e.g., "Mobile: Party tab doesn't show Pokemon cards")
2. These will be added as new tasks in a 19-04 gap closure plan
3. Type "regressions found: [list]" to continue
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run test:e2e` passes on all 3 viewports
2. No visual regressions found in manual verification
3. Core gameplay loop works: login -> zone -> party management
4. Guild features work: panel access, chat, channel switching
</verification>

<success_criteria>
- Playwright installed and configured
- E2E tests exist for: login, zone navigation, party management, guild basics
- Tests run at 1440px, 768px, and 375px viewports
- All tests pass
- Manual verification confirms no regressions from v1.2 theme work
</success_criteria>

<regression_handling>
If Task 4 checkpoint identifies regressions:
1. User provides list of regressions found
2. Execute `/gsd:plan-phase 19 --gaps` to create 19-04 plan
3. 19-04 will contain fix tasks for each identified regression
4. Re-run E2E tests after fixes to verify
</regression_handling>

<output>
After completion, create `.planning/phases/19-cleanup-polish/19-03-SUMMARY.md`
</output>
