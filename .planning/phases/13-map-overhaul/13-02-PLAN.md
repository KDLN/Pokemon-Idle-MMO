---
phase: 13-map-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web/src/components/game/map/ZoneNode.tsx
  - apps/web/src/components/game/map/ZoneTooltip.tsx
  - apps/web/src/components/game/map/mapUtils.ts
  - apps/web/src/components/game/map/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Zone nodes render at calculated positions on the map"
    - "Towns display as amber nodes, routes as green nodes"
    - "Current zone shows player icon overlay"
    - "Hovering a zone shows tooltip with name, type, level range"
  artifacts:
    - path: "apps/web/src/components/game/map/ZoneNode.tsx"
      provides: "Individual zone button component"
      exports: ["ZoneNode"]
    - path: "apps/web/src/components/game/map/ZoneTooltip.tsx"
      provides: "Tooltip content for zone hover"
      exports: ["ZoneTooltip"]
    - path: "apps/web/src/components/game/map/mapUtils.ts"
      provides: "Position calculation from direction graph"
      exports: ["calculateZonePositions", "DIRECTION_VECTORS", "ZONE_SPACING"]
  key_links:
    - from: "MapCanvas.tsx"
      to: "ZoneNode.tsx"
      via: "maps over zones array"
      pattern: "zones\\.map.*ZoneNode"
    - from: "ZoneNode.tsx"
      to: "ZoneTooltip.tsx"
      via: "Tooltip wrapper"
      pattern: "Tooltip.*ZoneTooltip"
    - from: "mapUtils.ts"
      to: "zone_connections direction"
      via: "BFS from start zone"
      pattern: "DIRECTION_VECTORS"
---

<objective>
Create zone node components with calculated positions from the direction graph.

Purpose: Transform zone connection data into visual map positions and render interactive zone nodes.
Output: ZoneNode and ZoneTooltip components, mapUtils for position calculation, updated MapCanvas showing zones.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-map-overhaul/13-CONTEXT.md
@.planning/phases/13-map-overhaul/13-RESEARCH.md
@.planning/phases/13-map-overhaul/13-01-SUMMARY.md
@packages/shared/src/types/core.ts
@apps/web/src/components/ui/Tooltip.tsx
@apps/web/src/stores/gameStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mapUtils with position calculation</name>
  <files>apps/web/src/components/game/map/mapUtils.ts</files>
  <action>
    Create mapUtils.ts with zone position calculation:

    1. Define ZONE_SPACING constant (100 pixels between zones)

    2. Define DIRECTION_VECTORS mapping:
       - 'N': { dx: 0, dy: -1 }
       - 'S': { dx: 0, dy: 1 }
       - 'E': { dx: 1, dy: 0 }
       - 'W': { dx: -1, dy: 0 }
       - Diagonals: NE, SE, SW, NW with appropriate vectors

    3. Create calculateZonePositions function:
       - Input: zones array, connections array, startZoneId
       - Output: Map<number, ZonePosition>
       - Algorithm: BFS from start zone
         - Start zone at center (400, 300)
         - For each connection, calculate position based on direction vector
         - Handle already-visited zones (skip re-positioning)
       - Return positions map

    4. Create getCanvasBounds function:
       - Input: positions Map
       - Output: { minX, maxX, minY, maxY, width, height }
       - Used to determine canvas size and centering
  </action>
  <verify>
    - calculateZonePositions returns Map with positions for all connected zones
    - Starting zone is at center coordinates
    - Adjacent zones are ZONE_SPACING pixels apart
    - Direction vectors correctly offset positions
  </verify>
  <done>Zone positions calculated from direction graph using BFS traversal</done>
</task>

<task type="auto">
  <name>Task 2: Create ZoneTooltip and ZoneNode components</name>
  <files>apps/web/src/components/game/map/ZoneTooltip.tsx, apps/web/src/components/game/map/ZoneNode.tsx</files>
  <action>
    1. Create ZoneTooltip.tsx:
       - Styled content for zone hover tooltip
       - Display: zone name (pixel font, uppercase), type badge (town/route), level range (for routes)
       - Style matching existing ItemTooltipContent pattern:
         - bg-surface-elevated, border, rounded-lg, padding
         - Town type badge: amber background
         - Route type badge: green background
         - Level range: text-secondary

    2. Create ZoneNode.tsx:
       - Props: zone data, position, isCurrent, visibility, onClick
       - Button element with absolute positioning at (x, y)
       - Use transform: translate(-50%, -50%) for center alignment
       - Styling based on zone_type:
         - Town: amber-500/80 background, hover amber-400
         - Route: green-500/80 background, hover green-400
       - Size: w-12 h-12 (48px) for towns, w-10 h-10 (40px) for routes
       - Current zone: ring-2 ring-yellow-400 ring-offset-2, plus player icon overlay
       - Player icon: Small trainer emoji or SVG positioned at center
       - Hover: scale(1.1) with smooth transition
       - Touch target: ::before pseudo-element for 44px minimum
       - Wrap in Tooltip component with ZoneTooltip content
       - Town names always visible as labels below node
       - Route names only visible on hover (via tooltip)
  </action>
  <verify>
    - ZoneNode renders as clickable button at correct position
    - Current zone has distinctive yellow ring and player icon
    - Tooltip appears on hover with zone info
    - Town nodes show name label, route nodes don't
    - Touch target is at least 44px
  </verify>
  <done>Zone nodes render with proper styling, tooltips, and player indicator</done>
</task>

<task type="auto">
  <name>Task 3: Integrate zones into MapCanvas</name>
  <files>apps/web/src/components/game/map/MapCanvas.tsx</files>
  <action>
    Update MapCanvas.tsx to render zone nodes:

    1. Import from gameStore: currentZone, connectedZones
    2. Import calculateZonePositions from mapUtils
    3. Import ZoneNode component

    4. For now, use mock data for all zones (we'll wire to real data later):
       - Create MOCK_ZONES array matching database zones
       - Create MOCK_CONNECTIONS array with directions

    5. Calculate positions using calculateZonePositions:
       - Start from zone 1 (Pallet Town)
       - Memoize with useMemo

    6. Render zone nodes:
       - Map over zones, render ZoneNode for each
       - Pass isCurrent based on currentZone.id match
       - Pass visibility as 'visited' for now (fog of war later)
       - onClick: for now, console.log zone id

    7. Set canvas dimensions based on calculated bounds:
       - Add padding around bounds
       - Minimum 800x600
  </action>
  <verify>
    - MapCanvas renders all mock zones as nodes
    - Zones are positioned according to direction graph
    - Current zone (from gameStore) shows player indicator
    - Clicking a zone logs to console
    - Canvas size accommodates all zone positions
  </verify>
  <done>Map displays zone nodes at calculated positions with current zone highlighted</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/web && npm run build`
2. No TypeScript errors
3. Visual check:
   - Zones appear at reasonable positions
   - Pallet Town at center
   - Route 1 north of Pallet Town
   - Viridian City north of Route 1
   - Towns are amber, routes are green
   - Current zone has yellow ring and player icon
   - Hovering shows tooltip
</verification>

<success_criteria>
- Zone positions calculated from direction graph
- ZoneNode components render at correct positions
- Current zone clearly highlighted with player icon
- Tooltips show zone info on hover
- Town names visible, route names on hover only
- Click interaction working (console log)
</success_criteria>

<output>
After completion, create `.planning/phases/13-map-overhaul/13-02-SUMMARY.md`
</output>
