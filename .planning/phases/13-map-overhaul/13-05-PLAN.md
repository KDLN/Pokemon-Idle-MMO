---
phase: 13-map-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - apps/web/src/components/game/map/MapControls.tsx
  - apps/web/src/components/game/map/InteractiveMap.tsx
  - apps/web/src/components/game/map/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Map centers on current zone when first opened"
    - "'Center on me' button appears when current zone scrolls off-screen"
    - "Clicking 'Center on me' smoothly scrolls to current zone"
  artifacts:
    - path: "apps/web/src/components/game/map/MapControls.tsx"
      provides: "CenterOnMe button with visibility logic"
      exports: ["MapControls"]
    - path: "apps/web/src/components/game/map/InteractiveMap.tsx"
      provides: "Initial centering on current zone"
      exports: ["InteractiveMap"]
  key_links:
    - from: "MapControls.tsx"
      to: "react-zoom-pan-pinch"
      via: "centerView and state"
      pattern: "centerView"
    - from: "InteractiveMap.tsx"
      to: "current zone position"
      via: "initialPositionX/Y props"
      pattern: "initialPositionX|initialPositionY"
---

<objective>
Add center-on-current-zone functionality with visibility-based button and initial centering.

Purpose: Players can quickly find their location on the map, especially after panning away.
Output: Map centers on current zone initially, "Center on me" button appears when zone is off-screen.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-map-overhaul/13-CONTEXT.md
@.planning/phases/13-map-overhaul/13-01-SUMMARY.md
@.planning/phases/13-map-overhaul/13-02-SUMMARY.md
@apps/web/src/components/game/map/mapTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add viewport visibility detection</name>
  <files>apps/web/src/components/game/map/mapUtils.ts</files>
  <action>
    Add isZoneInViewport utility function to mapUtils.ts:

    1. Create function:
       isZoneInViewport(
         zonePosition: { x: number; y: number },
         transformState: { scale: number; positionX: number; positionY: number },
         viewportSize: { width: number; height: number }
       ): boolean

    2. Calculate transformed zone position:
       - transformedX = zonePosition.x * scale + positionX
       - transformedY = zonePosition.y * scale + positionY

    3. Check if within viewport bounds:
       - Add margin (50px) so zone is considered "in view" with some buffer
       - Return true if transformedX/Y within viewport bounds + margin
       - Return false if zone is outside visible area

    4. Export function for use in MapControls
  </action>
  <verify>
    - Function correctly identifies when zone is in viewport
    - Function correctly identifies when zone is scrolled out of view
    - Works with different scale values (zoomed in/out)
  </verify>
  <done>Viewport visibility detection function ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Add "Center on me" button to MapControls</name>
  <files>apps/web/src/components/game/map/MapControls.tsx</files>
  <action>
    Enhance MapControls with conditional "Center on me" button:

    1. Add props:
       - currentZonePosition: { x: number; y: number } | null
       - transformState from react-zoom-pan-pinch (use useTransformContext if available, or prop)

    2. Track viewport size:
       - useEffect to get container dimensions
       - Update on resize

    3. Calculate zone visibility:
       - Use isZoneInViewport from mapUtils
       - Update on transform state changes

    4. Render "Center on me" button:
       - Only show when currentZonePosition exists AND zone is out of viewport
       - Position: bottom of controls stack, or separate position (bottom-left)
       - Style: More prominent than +/- buttons
         - Use lb-accent background
         - Icon: crosshairs or location marker
         - Text: "Center" or just icon
       - onClick: call centerView with current zone position

    5. Use useControls() for centerView function:
       - Calculate offset to center the zone in viewport
       - centerView(scale, 0) centers on content
       - May need to use setTransform for precise positioning
  </action>
  <verify>
    - "Center on me" button hidden when current zone is visible
    - Button appears when current zone is scrolled off-screen
    - Clicking button smoothly centers map on current zone
    - Button styled to stand out from zoom controls
  </verify>
  <done>"Center on me" button shows conditionally and works correctly</done>
</task>

<task type="auto">
  <name>Task 3: Implement initial centering on current zone</name>
  <files>apps/web/src/components/game/map/InteractiveMap.tsx, apps/web/src/components/game/map/MapCanvas.tsx</files>
  <action>
    Set up map to center on current zone when first rendered:

    1. In InteractiveMap.tsx:
       - Accept currentZonePosition prop from parent
       - Calculate initial transform to center on zone:
         - initialPositionX = (viewportWidth / 2) - currentZonePosition.x
         - initialPositionY = (viewportHeight / 2) - currentZonePosition.y
       - Pass to TransformWrapper as initialPositionX/Y

    2. Update MapCanvas.tsx:
       - Pass calculated zone positions up to InteractiveMap
       - Or: Pass current zone position directly to InteractiveMap

    3. Handle zone changes:
       - When currentZone changes (player travels), re-center map
       - Use useEffect with currentZone.id dependency
       - Call centerView or setTransform to animate to new position

    4. Smooth animation:
       - TransformWrapper supports animation options
       - Use default animation for smooth centering

    5. Pass necessary state to MapControls:
       - Current zone position
       - Access to transform state for visibility check
  </action>
  <verify>
    - Map initially centers on player's current zone
    - When player travels, map animates to new zone
    - MapControls receives necessary props for visibility check
  </verify>
  <done>Map centers on current zone initially and on travel</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/web && npm run build`
2. No TypeScript errors
3. Manual test:
   - Load map - current zone is centered
   - Pan away from current zone - "Center on me" appears
   - Click "Center on me" - map smoothly centers on current zone
   - Pan back to current zone - button disappears
   - Travel to new zone - map centers on new location
</verification>

<success_criteria>
- Map initially centers on player's current zone
- "Center on me" button appears only when current zone off-screen
- Button click smoothly animates to center current zone
- Traveling to new zone re-centers the map
- No jank or abrupt position changes
</success_criteria>

<output>
After completion, create `.planning/phases/13-map-overhaul/13-05-SUMMARY.md`
</output>
