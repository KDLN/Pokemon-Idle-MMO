---
phase: 13-map-overhaul
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web/src/components/game/map/ZoneConnection.tsx
  - apps/web/src/components/game/map/ConnectionLayer.tsx
  - apps/web/src/components/game/map/MapCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "Connection lines visibly link connected zones"
    - "Direction arrows indicate travel direction on paths"
    - "Connections to current zone are visually emphasized"
  artifacts:
    - path: "apps/web/src/components/game/map/ZoneConnection.tsx"
      provides: "SVG line with direction arrow between zones"
      exports: ["ZoneConnection"]
    - path: "apps/web/src/components/game/map/ConnectionLayer.tsx"
      provides: "SVG container for all connection lines"
      exports: ["ConnectionLayer"]
  key_links:
    - from: "MapCanvas.tsx"
      to: "ConnectionLayer.tsx"
      via: "renders below zone nodes"
      pattern: "ConnectionLayer"
    - from: "ConnectionLayer.tsx"
      to: "ZoneConnection.tsx"
      via: "maps connections to lines"
      pattern: "connections\\.map.*ZoneConnection"
---

<objective>
Create zone connection lines with direction arrows between connected zones.

Purpose: Visualize the path network so players understand zone connectivity at a glance.
Output: ZoneConnection and ConnectionLayer components showing paths between zones with directional arrows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-map-overhaul/13-CONTEXT.md
@.planning/phases/13-map-overhaul/13-RESEARCH.md
@.planning/phases/13-map-overhaul/13-01-SUMMARY.md
@apps/web/src/components/game/map/mapTypes.ts
@apps/web/src/components/game/map/mapUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ZoneConnection component</name>
  <files>apps/web/src/components/game/map/ZoneConnection.tsx</files>
  <action>
    Create ZoneConnection.tsx for drawing a single connection line:

    1. Props:
       - from: ZonePosition
       - to: ZonePosition
       - direction: string (N, S, E, W, etc.)
       - isActive: boolean (true if connected to current zone)
       - isReachable: boolean (true if player can travel this path)

    2. Calculate line geometry:
       - Line from (from.x, from.y) to (to.x, to.y)
       - Midpoint for arrow placement: ((from.x + to.x) / 2, (from.y + to.y) / 2)
       - Angle for arrow rotation: Math.atan2(to.y - from.y, to.x - from.x) * 180 / Math.PI

    3. Render SVG group containing:
       - <line> element from start to end
         - stroke: gray-500 for inactive, lb-accent for active
         - stroke-width: 2px inactive, 3px active
         - stroke-dasharray: optional subtle dashes
       - <polygon> for direction arrow at midpoint
         - points="-6,-4 6,0 -6,4" (triangle pointing right)
         - transform: translate(midX, midY) rotate(angle)
         - fill matching line stroke color

    4. Styling:
       - Active paths: Use lb-accent color with glow effect (filter: drop-shadow)
       - Inactive/unreachable: opacity-30, gray color
       - Transition on opacity and stroke for smooth state changes
  </action>
  <verify>
    - Component renders SVG line between two points
    - Arrow appears at midpoint pointing in travel direction
    - Active state shows accent color with glow
    - Inactive state shows muted gray
  </verify>
  <done>ZoneConnection draws styled path lines with direction arrows</done>
</task>

<task type="auto">
  <name>Task 2: Create ConnectionLayer component</name>
  <files>apps/web/src/components/game/map/ConnectionLayer.tsx</files>
  <action>
    Create ConnectionLayer.tsx as SVG container for all connections:

    1. Props:
       - connections: ConnectionData[] (from mapTypes)
       - positions: Map<number, ZonePosition>
       - currentZoneId: number

    2. Create SVG element:
       - Position absolute, inset-0 (full canvas coverage)
       - pointer-events: none (allow clicks through to zones)
       - viewBox matching canvas dimensions

    3. Filter and deduplicate connections:
       - zone_connections has bidirectional entries (A->B and B->A)
       - Only render each connection once
       - Create Set of rendered pairs: `${Math.min(a,b)}-${Math.max(a,b)}`

    4. Map filtered connections to ZoneConnection:
       - Look up positions for from and to zones
       - Skip if either position missing
       - Set isActive if either zone is currentZoneId
       - Set isReachable based on visibility (for now, all true)

    5. Render connections BELOW zone nodes in z-order
  </action>
  <verify>
    - ConnectionLayer renders SVG with correct dimensions
    - Each physical connection rendered once (not duplicated)
    - Active connections (to current zone) styled differently
    - SVG allows click-through to zone nodes
  </verify>
  <done>ConnectionLayer renders all zone connections as SVG paths</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ConnectionLayer into MapCanvas</name>
  <files>apps/web/src/components/game/map/MapCanvas.tsx</files>
  <action>
    Update MapCanvas.tsx to include connections:

    1. Import ConnectionLayer component

    2. Update MOCK_CONNECTIONS to include all zone connections:
       - Each connection has from_zone_id, to_zone_id, direction
       - Include both directions for each pair

    3. Render ConnectionLayer BEFORE zone nodes:
       - Pass connections, positions, currentZoneId
       - Connections appear below zones in visual hierarchy

    4. Ensure proper layering:
       - ConnectionLayer: z-0
       - Zone nodes: z-10
       - Controls: z-20

    5. Verify connections display:
       - Lines connect all adjacent zones
       - Arrows point in correct directions
       - Paths to current zone are highlighted
  </action>
  <verify>
    - Connection lines visible between all adjacent zones
    - Direction arrows point correctly (N = up, E = right, etc.)
    - Paths to current zone highlighted with accent color
    - Zone nodes remain clickable above connection lines
  </verify>
  <done>Map shows connected zone paths with direction indicators</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/web && npm run build`
2. No TypeScript errors
3. Visual check:
   - Lines connect adjacent zones
   - Arrows visible at line midpoints
   - Arrows point in travel direction
   - Active paths glow with accent color
   - Zone nodes clickable (not blocked by SVG)
</verification>

<success_criteria>
- Connection lines drawn between all adjacent zones
- Direction arrows indicate travel direction
- Active paths (connected to current zone) visually emphasized
- SVG layer does not block zone node interactions
- Clean deduplication (no overlapping duplicate lines)
</success_criteria>

<output>
After completion, create `.planning/phases/13-map-overhaul/13-03-SUMMARY.md`
</output>
