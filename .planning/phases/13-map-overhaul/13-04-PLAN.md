---
phase: 13-map-overhaul
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/game/map/MapCanvas.tsx
  - apps/web/src/components/game/map/ZoneNode.tsx
  - apps/web/src/components/game/map/mapUtils.ts
autonomous: true

must_haves:
  truths:
    - "Unvisited zones are hidden from the map"
    - "Zones adjacent to visited zones appear as '?' markers"
    - "Visiting a zone reveals it and its adjacent zones"
    - "Visited zones persist across page refresh"
  artifacts:
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "visitedZones state with persistence"
      exports: ["useGameStore.visitedZones", "useGameStore.markZoneVisited"]
    - path: "apps/web/src/components/game/map/mapUtils.ts"
      provides: "getZoneVisibility function"
      exports: ["getZoneVisibility"]
  key_links:
    - from: "MapCanvas.tsx"
      to: "gameStore.visitedZones"
      via: "useGameStore selector"
      pattern: "useGameStore.*visitedZones"
    - from: "MapCanvas.tsx"
      to: "mapUtils.getZoneVisibility"
      via: "calculates visibility per zone"
      pattern: "getZoneVisibility"
    - from: "ZoneNode.tsx"
      to: "visibility prop"
      via: "controls rendering"
      pattern: "visibility.*hidden.*return null"
---

<objective>
Implement fog of war system that hides unvisited zones and shows adjacent unknown zones as mystery markers.

Purpose: Add exploration feel by progressively revealing the map as players travel to new zones.
Output: visitedZones in gameStore with persistence, visibility calculation, fog of war rendering in map.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-map-overhaul/13-CONTEXT.md
@.planning/phases/13-map-overhaul/13-01-SUMMARY.md
@.planning/phases/13-map-overhaul/13-02-SUMMARY.md
@apps/web/src/stores/gameStore.ts
@apps/web/src/components/game/map/mapTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visitedZones state to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
    Add visited zones tracking to gameStore:

    1. Add to state interface:
       - visitedZones: number[] (array of visited zone IDs)

    2. Add actions:
       - markZoneVisited: (zoneId: number) => void
         - Adds zone to visitedZones if not already present
         - Uses Set for deduplication, converts back to array

    3. Add to initialState:
       - visitedZones: [1] (start with Pallet Town visited)

    4. Add visitedZones to persist configuration:
       - Include in partialize function so it persists
       - Already using zustand/middleware persist

    5. Auto-mark zone visited when player moves:
       - In setZone action, call markZoneVisited with new zone id
       - Ensures visited zones update automatically on travel
  </action>
  <verify>
    - gameStore exports visitedZones and markZoneVisited
    - Initial state includes zone 1
    - Calling markZoneVisited adds new zone without duplicates
    - visitedZones persists in localStorage after page refresh
    - setZone automatically marks new zone as visited
  </verify>
  <done>visitedZones tracked in gameStore with localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 2: Add visibility calculation to mapUtils</name>
  <files>apps/web/src/components/game/map/mapUtils.ts</files>
  <action>
    Add getZoneVisibility function to mapUtils.ts:

    1. Create function:
       getZoneVisibility(
         zoneId: number,
         visitedZones: number[],
         connections: ConnectionData[]
       ): ZoneVisibility

    2. Logic:
       - If zoneId in visitedZones -> return 'visited'
       - If zoneId adjacent to any visited zone -> return 'adjacent'
       - Otherwise -> return 'hidden'

    3. Adjacent check:
       - Find all connections where from_zone_id or to_zone_id equals any visited zone
       - If zoneId appears as the other end of any such connection -> adjacent

    4. Optimize with memoization hint (caller should useMemo):
       - Create Set from visitedZones for O(1) lookup
       - Pre-compute adjacent zones set

    5. Create getAdjacentZones helper:
       - Given a zone ID and connections, return array of adjacent zone IDs
       - Used for calculating adjacent set
  </action>
  <verify>
    - getZoneVisibility returns 'visited' for zones in visitedZones
    - getZoneVisibility returns 'adjacent' for zones connected to visited
    - getZoneVisibility returns 'hidden' for disconnected/far zones
    - Function handles edge cases (empty visitedZones, isolated zones)
  </verify>
  <done>Visibility calculation works correctly for all zone states</done>
</task>

<task type="auto">
  <name>Task 3: Update MapCanvas and ZoneNode for fog of war</name>
  <files>apps/web/src/components/game/map/MapCanvas.tsx, apps/web/src/components/game/map/ZoneNode.tsx</files>
  <action>
    1. Update ZoneNode.tsx visibility handling:
       - If visibility === 'hidden': return null (don't render)
       - If visibility === 'adjacent':
         - Render mystery marker (? icon)
         - Disabled state (cursor-not-allowed)
         - Muted colors (gray-600/50)
         - No tooltip (or tooltip saying "Unknown area")
       - If visibility === 'visited': full rendering

    2. Update MapCanvas.tsx:
       - Import visitedZones from gameStore
       - Import getZoneVisibility from mapUtils
       - Calculate visibility for each zone using useMemo
       - Pass visibility prop to ZoneNode

    3. Update ConnectionLayer visibility:
       - Only show connections where at least one zone is visible
       - Muted style for connections to adjacent (unknown) zones

    4. Visual styling for adjacent zones:
       - Question mark icon centered
       - Pulsing subtle glow to draw attention
       - Cannot be clicked (no onClick, disabled)
  </action>
  <verify>
    - Zones not visited and not adjacent don't appear
    - Adjacent zones show "?" marker in muted style
    - Visited zones show full styling
    - Connections respect visibility rules
    - Current zone (from gameStore) is always visible
  </verify>
  <done>Fog of war hides unexplored zones, reveals adjacent as mysteries</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/web && npm run build`
2. No TypeScript errors
3. Manual test:
   - Start fresh (clear localStorage)
   - Only starting area visible
   - Adjacent zones show as "?"
   - After traveling to new zone, it becomes fully visible
   - Refresh page - visited state persists
   - Previously visited zones still visible
</verification>

<success_criteria>
- visitedZones persisted in localStorage via gameStore
- Unvisited non-adjacent zones hidden
- Adjacent zones show mystery "?" markers
- Connections only show between visible zones
- Traveling to zone marks it visited automatically
- State persists across page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/13-map-overhaul/13-04-SUMMARY.md`
</output>
