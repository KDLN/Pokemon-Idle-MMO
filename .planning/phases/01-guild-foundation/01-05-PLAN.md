---
phase: 01-guild-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/GuildPanel.tsx
  - apps/web/src/components/CreateGuildModal.tsx
  - apps/web/src/components/GuildList.tsx
  - apps/web/src/components/GuildMembers.tsx
  - apps/web/src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "Player can view guild panel showing their guild or guild search"
    - "Player can create a guild via modal form"
    - "Player can search and join open guilds"
    - "Player can view guild member roster with online status and roles"
    - "Leader/Officer can manage roles via UI buttons"
    - "Leader can disband guild with confirmation modal"
  artifacts:
    - path: "apps/web/src/components/GuildPanel.tsx"
      provides: "Main guild panel component"
      exports: ["GuildPanel"]
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "Guild state and WebSocket handlers"
      contains: "guild:|setGuild"
  key_links:
    - from: "apps/web/src/components/GuildPanel.tsx"
      to: "apps/web/src/stores/gameStore.ts"
      via: "useGameStore hook"
      pattern: "useGameStore"
    - from: "apps/web/src/stores/gameStore.ts"
      to: "WebSocket"
      via: "message handlers"
      pattern: "case 'guild_data'"
---

# Plan 05: Frontend Guild UI

## Objective

Build the frontend components for guild management including the guild panel, create guild modal, guild search/list, and member roster with role management controls.

Purpose: Enable players to interact with the guild system through a user-friendly interface.

Output: Complete guild UI integrated into the main game page.

## Context

**Existing patterns to follow:**
- `apps/web/src/stores/gameStore.ts` - Zustand store with WebSocket message handlers
- `apps/web/src/components/FriendsPanel.tsx` - Social panel pattern (if exists)
- `apps/web/src/components/TradePanel.tsx` - Modal and list patterns
- Tailwind CSS for styling

**Dependencies:**
- 01-03 provides game server handlers (create_guild, join_guild, etc.)
- 01-04 provides role management handlers (promote, demote, kick, etc.)
- Shared types from @pokemon-idle/shared

**Requirements covered:**
- GUILD-01: Create guild UI (name, tag, description form)
- GUILD-03: View list of guilds with search/filter
- GUILD-04: Join open guild button
- GUILD-05: Leave guild button
- GUILD-06: Member roster with online status, role, last active
- ROLE-02/03: Promote/demote buttons for leader
- ROLE-04: Transfer leadership button
- ROLE-05/06: Kick buttons with role-based visibility
- ROLE-07: Disband with confirmation modal

## Tasks

<task type="auto">
  <name>Task 1: Add guild state to Zustand store</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
1. **Add guild imports at top:**

```typescript
import type {
  // ... existing imports ...
  Guild,
  GuildMember,
  GuildRole,
  GuildPreview,
  GuildDataPayload,
  GuildListPayload,
  GuildMemberJoinedPayload,
  GuildMemberLeftPayload,
  GuildMemberKickedPayload,
  GuildRoleChangedPayload,
  GuildDisbandedPayload,
  GuildErrorPayload
} from '@pokemon-idle/shared'
```

2. **Add guild state to the store interface:**

```typescript
interface GameState {
  // ... existing state ...

  // Guild state
  guild: Guild | null
  guildMembers: GuildMember[]
  myGuildRole: GuildRole | null
  guildList: GuildPreview[]
  guildListTotal: number
  guildSearchQuery: string
  guildError: string | null

  // Guild actions
  setGuild: (guild: Guild | null) => void
  setGuildMembers: (members: GuildMember[]) => void
  setMyGuildRole: (role: GuildRole | null) => void
  setGuildList: (guilds: GuildPreview[], total: number) => void
  setGuildSearchQuery: (query: string) => void
  setGuildError: (error: string | null) => void
  clearGuildState: () => void

  // Guild WebSocket actions
  sendCreateGuild: (name: string, tag: string, description?: string) => void
  sendJoinGuild: (guildId: string) => void
  sendLeaveGuild: () => void
  sendSearchGuilds: (query?: string, page?: number) => void
  sendGetGuild: () => void
  sendPromoteMember: (playerId: string) => void
  sendDemoteMember: (playerId: string) => void
  sendKickMember: (playerId: string) => void
  sendTransferLeadership: (playerId: string) => void
  sendDisbandGuild: (confirmation: string) => void
}
```

3. **Add initial guild state:**

```typescript
const initialState = {
  // ... existing initial state ...

  // Guild
  guild: null,
  guildMembers: [],
  myGuildRole: null,
  guildList: [],
  guildListTotal: 0,
  guildSearchQuery: '',
  guildError: null,
}
```

4. **Add guild state setters:**

```typescript
// In the create() function:
setGuild: (guild) => set({ guild }),
setGuildMembers: (guildMembers) => set({ guildMembers }),
setMyGuildRole: (myGuildRole) => set({ myGuildRole }),
setGuildList: (guildList, guildListTotal) => set({ guildList, guildListTotal }),
setGuildSearchQuery: (guildSearchQuery) => set({ guildSearchQuery }),
setGuildError: (guildError) => set({ guildError }),
clearGuildState: () => set({
  guild: null,
  guildMembers: [],
  myGuildRole: null,
  guildError: null
}),
```

5. **Add guild WebSocket send functions:**

```typescript
sendCreateGuild: (name, tag, description) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'create_guild', payload: { name, tag, description } }))
  }
},
sendJoinGuild: (guildId) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'join_guild', payload: { guild_id: guildId } }))
  }
},
sendLeaveGuild: () => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'leave_guild', payload: {} }))
  }
},
sendSearchGuilds: (query, page = 1) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'search_guilds', payload: { query, page, limit: 20 } }))
  }
},
sendGetGuild: () => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'get_guild', payload: {} }))
  }
},
sendPromoteMember: (playerId) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'promote_member', payload: { player_id: playerId } }))
  }
},
sendDemoteMember: (playerId) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'demote_member', payload: { player_id: playerId } }))
  }
},
sendKickMember: (playerId) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'kick_member', payload: { player_id: playerId } }))
  }
},
sendTransferLeadership: (playerId) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'transfer_leadership', payload: { player_id: playerId } }))
  }
},
sendDisbandGuild: (confirmation) => {
  const { ws } = get()
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'disband_guild', payload: { confirmation } }))
  }
},
```

6. **Add guild message handlers in handleMessage:**

Find the WebSocket message handler switch statement and add:

```typescript
case 'guild_data': {
  const data = message.payload as GuildDataPayload
  set({
    guild: data.guild,
    guildMembers: data.members,
    myGuildRole: data.my_role,
    guildError: null
  })
  break
}

case 'guild_list': {
  const data = message.payload as GuildListPayload
  set({
    guildList: data.guilds,
    guildListTotal: data.total
  })
  break
}

case 'guild_member_joined': {
  const data = message.payload as GuildMemberJoinedPayload
  const { guildMembers, guild } = get()
  set({
    guildMembers: [...guildMembers, data.member],
    guild: guild ? { ...guild, member_count: guild.member_count + 1 } : null
  })
  break
}

case 'guild_member_left': {
  const data = message.payload as GuildMemberLeftPayload
  const { guildMembers, guild } = get()
  set({
    guildMembers: guildMembers.filter(m => m.player_id !== data.player_id),
    guild: guild ? { ...guild, member_count: guild.member_count - 1 } : null
  })
  break
}

case 'guild_member_kicked': {
  const data = message.payload as GuildMemberKickedPayload
  const { guildMembers, guild } = get()
  set({
    guildMembers: guildMembers.filter(m => m.player_id !== data.player_id),
    guild: guild ? { ...guild, member_count: guild.member_count - 1 } : null
  })
  break
}

case 'guild_role_changed': {
  const data = message.payload as GuildRoleChangedPayload
  const { guildMembers, myGuildRole } = get()
  const currentPlayerId = get().player?.id
  set({
    guildMembers: guildMembers.map(m =>
      m.player_id === data.player_id ? { ...m, role: data.new_role } : m
    ),
    // Update my role if I was the one changed
    myGuildRole: data.player_id === currentPlayerId ? data.new_role : myGuildRole
  })
  break
}

case 'guild_disbanded': {
  const data = message.payload as GuildDisbandedPayload
  set({
    guild: null,
    guildMembers: [],
    myGuildRole: null,
    guildError: `Guild "${data.guild_name}" has been disbanded`
  })
  break
}

case 'guild_kicked': {
  set({
    guild: null,
    guildMembers: [],
    myGuildRole: null,
    guildError: 'You have been kicked from the guild'
  })
  break
}

case 'guild_left': {
  set({
    guild: null,
    guildMembers: [],
    myGuildRole: null
  })
  break
}

case 'guild_error': {
  const data = message.payload as GuildErrorPayload
  set({ guildError: data.error })
  break
}
```

7. **Request guild data on connect:**

In the WebSocket onopen handler (or after successful connection), add:
```typescript
// Request current guild data
ws.send(JSON.stringify({ type: 'get_guild', payload: {} }))
```
  </action>
  <verify>Review state shape for consistency. Verify message handlers update state correctly. Check WebSocket send functions match server expectations.</verify>
  <done>Zustand store extended with complete guild state management and WebSocket integration.</done>
</task>

<task type="auto">
  <name>Task 2: Create guild panel and modal components</name>
  <files>apps/web/src/components/GuildPanel.tsx, apps/web/src/components/CreateGuildModal.tsx</files>
  <action>
1. **Create `apps/web/src/components/CreateGuildModal.tsx`:**

```tsx
'use client'

import { useState } from 'react'
import { useGameStore } from '@/stores/gameStore'

interface CreateGuildModalProps {
  isOpen: boolean
  onClose: () => void
}

export function CreateGuildModal({ isOpen, onClose }: CreateGuildModalProps) {
  const [name, setName] = useState('')
  const [tag, setTag] = useState('')
  const [description, setDescription] = useState('')
  const [error, setError] = useState('')

  const sendCreateGuild = useGameStore(state => state.sendCreateGuild)

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    // Client-side validation
    if (name.length < 3 || name.length > 30) {
      setError('Guild name must be 3-30 characters')
      return
    }
    if (!/^[a-zA-Z0-9 ]+$/.test(name)) {
      setError('Guild name can only contain letters, numbers, and spaces')
      return
    }
    if (tag.length < 2 || tag.length > 5) {
      setError('Guild tag must be 2-5 characters')
      return
    }
    if (!/^[a-zA-Z0-9]+$/.test(tag)) {
      setError('Guild tag can only contain letters and numbers')
      return
    }

    sendCreateGuild(name.trim(), tag.trim().toUpperCase(), description.trim() || undefined)
    onClose()
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <h2 className="text-xl font-bold text-white mb-4">Create Guild</h2>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-1">Guild Name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="My Awesome Guild"
              className="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
              maxLength={30}
            />
            <p className="text-xs text-gray-500 mt-1">3-30 characters, letters, numbers, spaces only</p>
          </div>

          <div>
            <label className="block text-sm text-gray-400 mb-1">Guild Tag</label>
            <input
              type="text"
              value={tag}
              onChange={(e) => setTag(e.target.value.toUpperCase())}
              placeholder="TAG"
              className="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none uppercase"
              maxLength={5}
            />
            <p className="text-xs text-gray-500 mt-1">2-5 characters, shown as [TAG]</p>
          </div>

          <div>
            <label className="block text-sm text-gray-400 mb-1">Description (optional)</label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Tell players about your guild..."
              className="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none resize-none"
              rows={3}
              maxLength={500}
            />
          </div>

          {error && (
            <p className="text-red-400 text-sm">{error}</p>
          )}

          <div className="flex gap-3 pt-2">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500"
            >
              Create Guild
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

2. **Create `apps/web/src/components/GuildPanel.tsx`:**

```tsx
'use client'

import { useState, useEffect } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { CreateGuildModal } from './CreateGuildModal'
import { GuildList } from './GuildList'
import { GuildMembers } from './GuildMembers'

export function GuildPanel() {
  const [showCreateModal, setShowCreateModal] = useState(false)
  const [showDisbandConfirm, setShowDisbandConfirm] = useState(false)
  const [disbandConfirmation, setDisbandConfirmation] = useState('')

  const guild = useGameStore(state => state.guild)
  const myGuildRole = useGameStore(state => state.myGuildRole)
  const guildError = useGameStore(state => state.guildError)
  const sendLeaveGuild = useGameStore(state => state.sendLeaveGuild)
  const sendDisbandGuild = useGameStore(state => state.sendDisbandGuild)
  const sendSearchGuilds = useGameStore(state => state.sendSearchGuilds)
  const setGuildError = useGameStore(state => state.setGuildError)

  // Load guild list on mount if not in a guild
  useEffect(() => {
    if (!guild) {
      sendSearchGuilds()
    }
  }, [guild, sendSearchGuilds])

  // Clear error after 5 seconds
  useEffect(() => {
    if (guildError) {
      const timer = setTimeout(() => setGuildError(null), 5000)
      return () => clearTimeout(timer)
    }
  }, [guildError, setGuildError])

  const handleLeaveGuild = () => {
    if (confirm('Are you sure you want to leave this guild?')) {
      sendLeaveGuild()
    }
  }

  const handleDisbandGuild = () => {
    if (disbandConfirmation.toLowerCase() === guild?.name.toLowerCase()) {
      sendDisbandGuild(disbandConfirmation)
      setShowDisbandConfirm(false)
      setDisbandConfirmation('')
    }
  }

  // Not in a guild - show guild search/list
  if (!guild) {
    return (
      <div className="bg-gray-800 rounded-lg p-4">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-bold text-white">Guilds</h2>
          <button
            onClick={() => setShowCreateModal(true)}
            className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-500"
          >
            Create Guild
          </button>
        </div>

        {guildError && (
          <div className="mb-4 p-2 bg-red-900/50 border border-red-700 rounded text-red-300 text-sm">
            {guildError}
          </div>
        )}

        <GuildList />

        <CreateGuildModal
          isOpen={showCreateModal}
          onClose={() => setShowCreateModal(false)}
        />
      </div>
    )
  }

  // In a guild - show guild info and members
  return (
    <div className="bg-gray-800 rounded-lg p-4">
      {/* Guild Header */}
      <div className="flex justify-between items-start mb-4">
        <div>
          <h2 className="text-lg font-bold text-white">
            [{guild.tag}] {guild.name}
          </h2>
          <p className="text-sm text-gray-400">
            {guild.member_count}/{guild.max_members} members
          </p>
          {guild.description && (
            <p className="text-sm text-gray-300 mt-1">{guild.description}</p>
          )}
        </div>
        <div className="flex gap-2">
          {myGuildRole === 'leader' ? (
            <button
              onClick={() => setShowDisbandConfirm(true)}
              className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-500"
            >
              Disband
            </button>
          ) : (
            <button
              onClick={handleLeaveGuild}
              className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-500"
            >
              Leave
            </button>
          )}
        </div>
      </div>

      {guildError && (
        <div className="mb-4 p-2 bg-red-900/50 border border-red-700 rounded text-red-300 text-sm">
          {guildError}
        </div>
      )}

      {/* Your Role Badge */}
      <div className="mb-4">
        <span className="text-sm text-gray-400">Your Role: </span>
        <span className={`text-sm font-medium ${
          myGuildRole === 'leader' ? 'text-yellow-400' :
          myGuildRole === 'officer' ? 'text-blue-400' :
          'text-gray-300'
        }`}>
          {myGuildRole?.charAt(0).toUpperCase()}{myGuildRole?.slice(1)}
        </span>
      </div>

      {/* Member List */}
      <GuildMembers />

      {/* Disband Confirmation Modal */}
      {showDisbandConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <h3 className="text-lg font-bold text-red-400 mb-4">Disband Guild</h3>
            <p className="text-gray-300 mb-4">
              This action is permanent and cannot be undone. All members will be removed and all guild data will be deleted.
            </p>
            <p className="text-gray-300 mb-2">
              Type <span className="font-bold text-white">{guild.name}</span> to confirm:
            </p>
            <input
              type="text"
              value={disbandConfirmation}
              onChange={(e) => setDisbandConfirmation(e.target.value)}
              className="w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-red-500 focus:outline-none mb-4"
            />
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowDisbandConfirm(false)
                  setDisbandConfirmation('')
                }}
                className="flex-1 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500"
              >
                Cancel
              </button>
              <button
                onClick={handleDisbandGuild}
                disabled={disbandConfirmation.toLowerCase() !== guild.name.toLowerCase()}
                className="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Disband
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>Verify component imports are correct. Check modal z-index doesn't conflict with other modals. Ensure form validation matches server validation.</verify>
  <done>GuildPanel and CreateGuildModal components created with full functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Create guild list and member components</name>
  <files>apps/web/src/components/GuildList.tsx, apps/web/src/components/GuildMembers.tsx</files>
  <action>
1. **Create `apps/web/src/components/GuildList.tsx`:**

```tsx
'use client'

import { useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import type { GuildPreview } from '@pokemon-idle/shared'

export function GuildList() {
  const [searchQuery, setSearchQuery] = useState('')

  const guildList = useGameStore(state => state.guildList)
  const guildListTotal = useGameStore(state => state.guildListTotal)
  const sendSearchGuilds = useGameStore(state => state.sendSearchGuilds)
  const sendJoinGuild = useGameStore(state => state.sendJoinGuild)

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault()
    sendSearchGuilds(searchQuery)
  }

  const handleJoin = (guild: GuildPreview) => {
    if (guild.join_mode !== 'open') {
      return
    }
    if (guild.member_count >= guild.max_members) {
      return
    }
    sendJoinGuild(guild.id)
  }

  return (
    <div>
      {/* Search Bar */}
      <form onSubmit={handleSearch} className="flex gap-2 mb-4">
        <input
          type="text"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="Search guilds..."
          className="flex-1 bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none text-sm"
        />
        <button
          type="submit"
          className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-500"
        >
          Search
        </button>
      </form>

      {/* Guild List */}
      <div className="space-y-2 max-h-64 overflow-y-auto">
        {guildList.length === 0 ? (
          <p className="text-gray-400 text-sm text-center py-4">No guilds found</p>
        ) : (
          guildList.map((guild) => (
            <div
              key={guild.id}
              className="bg-gray-700 rounded p-3 flex justify-between items-center"
            >
              <div>
                <div className="flex items-center gap-2">
                  <span className="text-white font-medium">[{guild.tag}] {guild.name}</span>
                  {guild.join_mode === 'invite_only' && (
                    <span className="text-xs bg-yellow-600 px-1 rounded">Invite Only</span>
                  )}
                  {guild.join_mode === 'closed' && (
                    <span className="text-xs bg-red-600 px-1 rounded">Closed</span>
                  )}
                </div>
                <p className="text-xs text-gray-400">
                  {guild.member_count}/{guild.max_members} members
                </p>
                {guild.description && (
                  <p className="text-xs text-gray-300 mt-1 line-clamp-1">{guild.description}</p>
                )}
              </div>
              {guild.join_mode === 'open' && guild.member_count < guild.max_members && (
                <button
                  onClick={() => handleJoin(guild)}
                  className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-500"
                >
                  Join
                </button>
              )}
              {guild.member_count >= guild.max_members && (
                <span className="text-xs text-gray-500">Full</span>
              )}
            </div>
          ))
        )}
      </div>

      {/* Total count */}
      {guildListTotal > 0 && (
        <p className="text-xs text-gray-500 mt-2 text-center">
          Showing {guildList.length} of {guildListTotal} guilds
        </p>
      )}
    </div>
  )
}
```

2. **Create `apps/web/src/components/GuildMembers.tsx`:**

```tsx
'use client'

import { useGameStore } from '@/stores/gameStore'
import type { GuildMember, GuildRole } from '@pokemon-idle/shared'

function formatLastOnline(lastOnline: string | null, isOnline: boolean): string {
  if (isOnline) return 'Online'
  if (!lastOnline) return 'Unknown'

  const date = new Date(lastOnline)
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffMins = Math.floor(diffMs / 60000)
  const diffHours = Math.floor(diffMs / 3600000)
  const diffDays = Math.floor(diffMs / 86400000)

  if (diffMins < 1) return 'Just now'
  if (diffMins < 60) return `${diffMins}m ago`
  if (diffHours < 24) return `${diffHours}h ago`
  return `${diffDays}d ago`
}

function RoleBadge({ role }: { role: GuildRole }) {
  const colors = {
    leader: 'bg-yellow-600 text-yellow-100',
    officer: 'bg-blue-600 text-blue-100',
    member: 'bg-gray-600 text-gray-100',
  }

  return (
    <span className={`text-xs px-1.5 py-0.5 rounded ${colors[role]}`}>
      {role.charAt(0).toUpperCase()}{role.slice(1)}
    </span>
  )
}

interface MemberRowProps {
  member: GuildMember
  myRole: GuildRole | null
  myPlayerId: string
}

function MemberRow({ member, myRole, myPlayerId }: MemberRowProps) {
  const sendPromoteMember = useGameStore(state => state.sendPromoteMember)
  const sendDemoteMember = useGameStore(state => state.sendDemoteMember)
  const sendKickMember = useGameStore(state => state.sendKickMember)
  const sendTransferLeadership = useGameStore(state => state.sendTransferLeadership)

  const isMe = member.player_id === myPlayerId
  const canManage = myRole === 'leader' || (myRole === 'officer' && member.role === 'member')
  const canPromote = myRole === 'leader' && member.role === 'member'
  const canDemote = myRole === 'leader' && member.role === 'officer'
  const canKick = canManage && !isMe && member.role !== 'leader'
  const canTransfer = myRole === 'leader' && !isMe

  const handlePromote = () => {
    if (confirm(`Promote ${member.username} to Officer?`)) {
      sendPromoteMember(member.player_id)
    }
  }

  const handleDemote = () => {
    if (confirm(`Demote ${member.username} to Member?`)) {
      sendDemoteMember(member.player_id)
    }
  }

  const handleKick = () => {
    if (confirm(`Kick ${member.username} from the guild?`)) {
      sendKickMember(member.player_id)
    }
  }

  const handleTransfer = () => {
    if (confirm(`Transfer leadership to ${member.username}? You will become an Officer.`)) {
      sendTransferLeadership(member.player_id)
    }
  }

  return (
    <div className="bg-gray-700 rounded p-2 flex justify-between items-center">
      <div className="flex items-center gap-2">
        {/* Online indicator */}
        <div className={`w-2 h-2 rounded-full ${member.is_online ? 'bg-green-500' : 'bg-gray-500'}`} />

        <div>
          <div className="flex items-center gap-2">
            <span className={`text-sm ${isMe ? 'text-yellow-300 font-medium' : 'text-white'}`}>
              {member.username}
              {isMe && ' (you)'}
            </span>
            <RoleBadge role={member.role} />
          </div>
          <p className="text-xs text-gray-400">
            {formatLastOnline(member.last_online, member.is_online || false)}
          </p>
        </div>
      </div>

      {/* Action buttons */}
      {!isMe && (canPromote || canDemote || canKick || canTransfer) && (
        <div className="flex gap-1">
          {canPromote && (
            <button
              onClick={handlePromote}
              title="Promote to Officer"
              className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-500"
            >
              Promote
            </button>
          )}
          {canDemote && (
            <button
              onClick={handleDemote}
              title="Demote to Member"
              className="px-2 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-500"
            >
              Demote
            </button>
          )}
          {canTransfer && (
            <button
              onClick={handleTransfer}
              title="Transfer Leadership"
              className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-500"
            >
              Lead
            </button>
          )}
          {canKick && (
            <button
              onClick={handleKick}
              title="Kick from Guild"
              className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-500"
            >
              Kick
            </button>
          )}
        </div>
      )}
    </div>
  )
}

export function GuildMembers() {
  const guildMembers = useGameStore(state => state.guildMembers)
  const myGuildRole = useGameStore(state => state.myGuildRole)
  const player = useGameStore(state => state.player)

  if (!player) return null

  // Sort: leader first, then officers, then members. Online before offline within each group.
  const sortedMembers = [...guildMembers].sort((a, b) => {
    const roleOrder = { leader: 0, officer: 1, member: 2 }
    const roleCompare = roleOrder[a.role] - roleOrder[b.role]
    if (roleCompare !== 0) return roleCompare

    // Within same role, online first
    if (a.is_online && !b.is_online) return -1
    if (!a.is_online && b.is_online) return 1

    return 0
  })

  return (
    <div>
      <h3 className="text-sm font-medium text-gray-300 mb-2">Members</h3>
      <div className="space-y-1 max-h-64 overflow-y-auto">
        {sortedMembers.map((member) => (
          <MemberRow
            key={member.player_id}
            member={member}
            myRole={myGuildRole}
            myPlayerId={player.id}
          />
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>Check role-based button visibility logic is correct. Verify sorting works as expected. Ensure timestamps format correctly.</verify>
  <done>GuildList and GuildMembers components created with search, join, and role management functionality.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete guild UI including:
- Guild panel showing guild info or guild search
- Create guild modal with validation
- Guild list with search and join buttons
- Member roster with online status, roles, and management buttons
- Disband confirmation modal
- All role management actions (promote, demote, kick, transfer)</what-built>
  <how-to-verify>
1. Start the game server: `cd apps/game-server && npm run dev`
2. Start the web app: `cd apps/web && npm run dev`
3. Open http://localhost:3000 and log in
4. Test guild creation:
   - Click "Create Guild" button
   - Enter name, tag, description
   - Submit and verify guild is created
5. Test guild search:
   - Log in with a second account
   - Search for the created guild
   - Click "Join" button
6. Test member roster:
   - Verify both members appear with correct roles
   - Verify online status shows correctly
7. Test role management (as leader):
   - Promote member to Officer
   - Demote Officer back to Member
   - Kick a member
   - Transfer leadership
8. Test disband:
   - Click Disband button
   - Type guild name to confirm
   - Verify guild is deleted
  </how-to-verify>
  <resume-signal>Type "approved" if UI works correctly, or describe any issues found</resume-signal>
</task>

## Verification

- [ ] gameStore.ts has guild state (guild, guildMembers, myGuildRole, guildList)
- [ ] gameStore.ts has guild WebSocket send functions
- [ ] gameStore.ts handles all guild message types
- [ ] GuildPanel.tsx renders guild info or guild search based on membership
- [ ] CreateGuildModal.tsx validates input and sends create_guild message
- [ ] GuildList.tsx shows searchable list of guilds with join buttons
- [ ] GuildMembers.tsx shows members with online status and role management buttons
- [ ] Role management buttons only visible to users with appropriate permissions
- [ ] Disband confirmation requires typing guild name
- [ ] Frontend builds without errors: `cd apps/web && npm run build`

## Success Criteria

- Player without guild sees guild search with create button
- Player can create guild via modal
- Player can search and join open guilds
- Player in guild sees guild info and member roster
- Online status updates in real-time
- Leader sees promote/demote/kick/transfer buttons for appropriate members
- Officer sees kick button for members only
- Member sees no management buttons
- Leader can disband guild with confirmation
- All actions result in correct server responses and UI updates

## Output

After completion, create `.planning/phases/01-guild-foundation/01-05-SUMMARY.md`
