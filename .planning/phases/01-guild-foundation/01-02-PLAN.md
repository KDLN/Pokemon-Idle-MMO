---
phase: 01-guild-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/types/guild.ts
  - packages/shared/src/types/index.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Guild types are importable from @pokemon-idle/shared"
    - "GuildRole enum matches database enum values"
    - "Message types cover all guild operations"
    - "Types compile without errors"
  artifacts:
    - path: "packages/shared/src/types/guild.ts"
      provides: "Guild type definitions"
      exports: ["Guild", "GuildMember", "GuildRole", "GuildPreview"]
    - path: "packages/shared/src/types/index.ts"
      provides: "Type barrel exports"
      contains: "export * from './guild'"
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/types/index.ts"
      via: "re-export"
      pattern: "export.*from.*types"
---

# Plan 02: Shared Types for Guild System

## Objective

Create TypeScript type definitions for the guild system in the shared package, enabling type-safe development across frontend and game server.

Purpose: Shared types ensure consistency between database schema, game server handlers, and frontend components.

Output: New `guild.ts` types file with all guild-related interfaces and enums exported from `@pokemon-idle/shared`.

## Context

**Existing patterns to follow:**
- `packages/shared/src/types/social.ts` - Social types (Friend, FriendRequest, etc.)
- `packages/shared/src/types/trade.ts` - Trade types (Trade, TradeOffer, etc.)
- `packages/shared/src/types/index.ts` - Barrel exports

**Package structure:**
- Types defined in `packages/shared/src/types/`
- Exported via `packages/shared/src/types/index.ts`
- Re-exported via `packages/shared/src/index.ts`

**Database schema alignment:**
- GuildRole: 'leader' | 'officer' | 'member' (matches guild_role enum)
- Guild fields match guilds table columns
- GuildMember fields match guild_members table columns

## Tasks

<task type="auto">
  <name>Task 1: Create guild types file</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Create new file `packages/shared/src/types/guild.ts` with:

```typescript
// Guild system types

// Role enum matching database guild_role type
export type GuildRole = 'leader' | 'officer' | 'member'

// Join mode options
export type GuildJoinMode = 'open' | 'invite_only' | 'closed'

// Full guild data (for members viewing their own guild)
export interface Guild {
  id: string
  name: string
  tag: string
  description: string | null
  leader_id: string
  member_count: number
  max_members: number
  join_mode: GuildJoinMode
  created_at: string
}

// Guild preview for search/discovery (subset of Guild)
export interface GuildPreview {
  id: string
  name: string
  tag: string
  description: string | null
  member_count: number
  max_members: number
  join_mode: GuildJoinMode
}

// Guild member with player info
export interface GuildMember {
  id: string
  guild_id: string
  player_id: string
  role: GuildRole
  joined_at: string
  // Joined data from players table
  username: string
  last_online: string | null
  is_online?: boolean
}

// Player's guild info (cached in session)
export interface PlayerGuildInfo {
  id: string
  name: string
  tag: string
  role: GuildRole
}

// ================================
// WebSocket Message Payloads
// ================================

// Client -> Server payloads
export interface CreateGuildPayload {
  name: string
  tag: string
  description?: string
}

export interface JoinGuildPayload {
  guild_id: string
}

export interface KickMemberPayload {
  player_id: string
}

export interface PromoteMemberPayload {
  player_id: string
}

export interface DemoteMemberPayload {
  player_id: string
}

export interface TransferLeadershipPayload {
  player_id: string
}

export interface DisbandGuildPayload {
  confirmation: string  // Must match guild name
}

export interface SearchGuildsPayload {
  query?: string
  page?: number
  limit?: number
}

export interface UpdateGuildSettingsPayload {
  description?: string
  join_mode?: GuildJoinMode
}

// Server -> Client payloads
export interface GuildDataPayload {
  guild: Guild
  members: GuildMember[]
  my_role: GuildRole
}

export interface GuildListPayload {
  guilds: GuildPreview[]
  total: number
  page: number
}

export interface GuildMemberJoinedPayload {
  member: GuildMember
}

export interface GuildMemberLeftPayload {
  player_id: string
  username: string
}

export interface GuildMemberKickedPayload {
  player_id: string
  username: string
  kicked_by: string
}

export interface GuildRoleChangedPayload {
  player_id: string
  username: string
  old_role: GuildRole
  new_role: GuildRole
}

export interface GuildDisbandedPayload {
  guild_name: string
}

export interface GuildErrorPayload {
  error: string
}
```

Follow existing patterns:
- Use string for UUIDs (not branded types)
- Use string for timestamps (ISO format)
- Keep interfaces flat (no nested objects except for joined data)
- Use null for optional database fields, undefined for optional message fields
  </action>
  <verify>Check that types align with 022_guilds.sql schema. Verify no circular imports.</verify>
  <done>Guild types file created with all interfaces matching database schema and WebSocket message patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Export guild types from barrel files</name>
  <files>packages/shared/src/types/index.ts, packages/shared/src/index.ts</files>
  <action>
1. **Update `packages/shared/src/types/index.ts`:**

Add export line (maintain alphabetical order with existing exports):

```typescript
// Existing exports...
export * from './battle'
export * from './catching'
export * from './common'
export * from './core'
export * from './guild'  // ADD THIS LINE
export * from './leaderboard'
export * from './progression'
export * from './social'
export * from './trade'
```

2. **Verify `packages/shared/src/index.ts`:**

Should already re-export all types. Confirm it has:
```typescript
export * from './types'
```

If not present, add it.

3. **Build shared package to verify:**
```bash
cd packages/shared && npm run build
```

This compiles TypeScript and verifies no errors.
  </action>
  <verify>Run `npm run build` in packages/shared. Verify build succeeds with no type errors.</verify>
  <done>Guild types exported from @pokemon-idle/shared. Build passes without errors.</done>
</task>

## Verification

- [ ] File exists at `packages/shared/src/types/guild.ts`
- [ ] File exports GuildRole, GuildJoinMode, Guild, GuildPreview, GuildMember, PlayerGuildInfo
- [ ] File exports all WebSocket payload interfaces
- [ ] `packages/shared/src/types/index.ts` includes `export * from './guild'`
- [ ] `npm run build` in packages/shared completes without errors
- [ ] Types can be imported: `import { Guild, GuildRole } from '@pokemon-idle/shared'`

## Success Criteria

- Guild types are available for import in both apps/web and apps/game-server
- Type definitions match the database schema from 022_guilds.sql
- WebSocket message payloads cover all Phase 1 operations:
  - create_guild, join_guild, leave_guild
  - get_guild, get_guild_list, get_guild_members
  - kick_member, promote_member, demote_member
  - transfer_leadership, disband_guild
  - update_guild_settings, search_guilds

## Output

After completion, create `.planning/phases/01-guild-foundation/01-02-SUMMARY.md`
