---
phase: 02-guild-invites
plan: 04
type: execute
wave: 2
depends_on:
  - 02-02
  - 02-03
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/components/guild/GuildPanel.tsx
  - apps/web/src/components/guild/GuildInviteList.tsx
  - apps/web/src/components/guild/GuildInviteButton.tsx
  - apps/web/src/components/guild/GuildJoinModeSettings.tsx
autonomous: false

must_haves:
  truths:
    - "Player can see pending invites in guild panel"
    - "Player can accept or decline invites with button click"
    - "Leader/Officer can send invite via player search"
    - "Leader can change guild join mode in settings"
    - "Invites update in real-time via WebSocket"
  artifacts:
    - path: "apps/web/src/components/guild/GuildInviteList.tsx"
      provides: "Pending invites UI component"
      min_lines: 50
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "State management for invites"
      contains: "guildInvites"
  key_links:
    - from: "GuildInviteList"
      to: "gameStore"
      via: "useGameStore hook"
      pattern: "useGameStore.*guildInvites"
    - from: "gameStore"
      to: "WebSocket"
      via: "message handlers"
      pattern: "guild_invite"
---

# Plan 04: Frontend UI for Guild Invites

## Objective

Implement the frontend components for the guild invite system, allowing players to view, accept, and decline invites, and guild leaders/officers to send invites and manage join mode settings.

Purpose: Provides the user interface for the invite system, integrating with the game store for state management and WebSocket for real-time updates.

Output: New components for invite list, invite button, join mode settings, and updated GuildPanel with invite functionality.

## Context

**Existing patterns to follow:**
- `apps/web/src/components/guild/GuildPanel.tsx` - Guild UI structure
- `apps/web/src/components/guild/GuildMemberList.tsx` - List component pattern
- `apps/web/src/stores/gameStore.ts` - Zustand store with WebSocket message handlers

**Research findings (from 02-RESEARCH.md):**
- WebSocket messages: guild_invite_send, guild_invites_list, guild_invite_received
- Store should hold guildInvites array and handle real-time updates
- Follow existing modal patterns for invite actions

**Dependencies:**
- 02-02 (shared types) - GuildInvite type exists
- 02-03 (game server) - WebSocket handlers exist

**Requirements covered:**
- INVITE-02: Player receives invite notification (UI display)
- INVITE-03: Player can accept or decline invite (buttons)
- INVITE-05: Guild can set join mode (settings UI)

## Tasks

<task type="auto">
  <name>Task 1: Add invite state to gameStore</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
1. **Add invite state to the store interface:**

Find the GameStore interface and add:
```typescript
  // Guild invites
  guildInvites: GuildInvite[]
  guildOutgoingInvites: GuildOutgoingInvite[]
```

2. **Initialize in initial state:**

Find where state is initialized and add:
```typescript
  guildInvites: [],
  guildOutgoingInvites: [],
```

3. **Add WebSocket message handlers:**

Find the WebSocket message handler switch/if-else block and add cases:
```typescript
      case 'guild_invites_list':
        set({ guildInvites: message.payload.invites })
        break

      case 'guild_outgoing_invites':
        set({ guildOutgoingInvites: message.payload.invites })
        break

      case 'guild_invite_received':
        // Add new invite to list
        set(state => ({
          guildInvites: [
            {
              id: message.payload.invite_id,
              guild_id: message.payload.guild_id,
              guild_name: message.payload.guild_name,
              guild_tag: message.payload.guild_tag,
              member_count: message.payload.member_count,
              max_members: message.payload.max_members,
              invited_by: message.payload.invited_by_id,
              invited_by_username: message.payload.invited_by_username,
              created_at: message.payload.created_at,
              expires_at: message.payload.expires_at
            },
            ...state.guildInvites
          ]
        }))
        break

      case 'guild_invite_accepted':
        // Clear invites after joining guild
        set({ guildInvites: [] })
        break

      case 'guild_invite_declined':
        // Remove declined invite from list
        set(state => ({
          guildInvites: state.guildInvites.filter(
            invite => invite.id !== message.payload.invite_id
          )
        }))
        break

      case 'guild_invite_sent':
        // Refresh outgoing invites
        // Could also optimistically add to list
        break

      case 'guild_invite_cancelled':
        // Remove cancelled invite from outgoing list
        set(state => ({
          guildOutgoingInvites: state.guildOutgoingInvites.filter(
            invite => invite.id !== message.payload.invite_id
          )
        }))
        break
```

4. **Add action methods:**

Add these actions to the store:
```typescript
  // Guild invite actions
  sendGuildInvite: (playerId: string) => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'guild_invite_send', payload: { player_id: playerId } }))
    }
  },

  acceptGuildInvite: (inviteId: string) => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'guild_invite_accept', payload: { invite_id: inviteId } }))
    }
  },

  declineGuildInvite: (inviteId: string) => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'guild_invite_decline', payload: { invite_id: inviteId } }))
    }
  },

  cancelGuildInvite: (inviteId: string) => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'guild_invite_cancel', payload: { invite_id: inviteId } }))
    }
  },

  fetchGuildInvites: () => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'get_guild_invites', payload: {} }))
    }
  },

  fetchOutgoingGuildInvites: () => {
    const ws = get().ws
    if (ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'get_guild_outgoing_invites', payload: {} }))
    }
  },
```

5. **Add type imports:**

At the top, import the new types:
```typescript
import type { GuildInvite, GuildOutgoingInvite } from '@pokemon-idle/shared'
```
  </action>
  <verify>Run `npm run build` in apps/web to verify no type errors.</verify>
  <done>Game store updated with invite state, WebSocket handlers, and action methods.</done>
</task>

<task type="auto">
  <name>Task 2: Create GuildInviteList component</name>
  <files>apps/web/src/components/guild/GuildInviteList.tsx</files>
  <action>
Create new file `apps/web/src/components/guild/GuildInviteList.tsx`:

```typescript
'use client'

import { useEffect } from 'react'
import { useGameStore } from '@/stores/gameStore'
import type { GuildInvite } from '@pokemon-idle/shared'

// Calculate time remaining until expiration
function getTimeRemaining(expiresAt: string): string {
  const now = new Date()
  const expires = new Date(expiresAt)
  const diff = expires.getTime() - now.getTime()

  if (diff <= 0) return 'Expired'

  const days = Math.floor(diff / (1000 * 60 * 60 * 24))
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))

  if (days > 0) return `${days}d ${hours}h left`
  if (hours > 0) return `${hours}h left`
  return 'Less than 1h'
}

interface InviteCardProps {
  invite: GuildInvite
  onAccept: (id: string) => void
  onDecline: (id: string) => void
}

function InviteCard({ invite, onAccept, onDecline }: InviteCardProps) {
  return (
    <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
      <div className="flex justify-between items-start mb-2">
        <div>
          <h4 className="font-semibold text-white">
            [{invite.guild_tag}] {invite.guild_name}
          </h4>
          <p className="text-sm text-gray-400">
            {invite.member_count}/{invite.max_members} members
          </p>
        </div>
        <span className="text-xs text-gray-500">
          {getTimeRemaining(invite.expires_at)}
        </span>
      </div>
      <p className="text-sm text-gray-400 mb-3">
        Invited by <span className="text-white">{invite.invited_by_username}</span>
      </p>
      <div className="flex gap-2">
        <button
          onClick={() => onAccept(invite.id)}
          className="flex-1 px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm font-medium rounded transition-colors"
        >
          Accept
        </button>
        <button
          onClick={() => onDecline(invite.id)}
          className="flex-1 px-3 py-1.5 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded transition-colors"
        >
          Decline
        </button>
      </div>
    </div>
  )
}

export function GuildInviteList() {
  const {
    guildInvites,
    fetchGuildInvites,
    acceptGuildInvite,
    declineGuildInvite,
    guild
  } = useGameStore()

  // Fetch invites on mount (only if not in a guild)
  useEffect(() => {
    if (!guild) {
      fetchGuildInvites()
    }
  }, [guild, fetchGuildInvites])

  // Don't show if already in a guild
  if (guild) return null

  // Don't show if no invites
  if (guildInvites.length === 0) return null

  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold text-white">
        Guild Invites ({guildInvites.length})
      </h3>
      <div className="space-y-3">
        {guildInvites.map(invite => (
          <InviteCard
            key={invite.id}
            invite={invite}
            onAccept={acceptGuildInvite}
            onDecline={declineGuildInvite}
          />
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>Check component compiles and follows existing styling patterns.</verify>
  <done>GuildInviteList component created with accept/decline functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Create GuildInviteButton and integrate with GuildPanel</name>
  <files>apps/web/src/components/guild/GuildInviteButton.tsx, apps/web/src/components/guild/GuildPanel.tsx</files>
  <action>
1. **Create GuildInviteButton component:**

Create new file `apps/web/src/components/guild/GuildInviteButton.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { useGameStore } from '@/stores/gameStore'

interface GuildInviteButtonProps {
  targetPlayerId: string
  targetUsername: string
  className?: string
}

export function GuildInviteButton({
  targetPlayerId,
  targetUsername,
  className = ''
}: GuildInviteButtonProps) {
  const { guild, sendGuildInvite } = useGameStore()
  const [sent, setSent] = useState(false)
  const [loading, setLoading] = useState(false)

  // Only show for leader/officer
  if (!guild || !['leader', 'officer'].includes(guild.role)) {
    return null
  }

  const handleInvite = () => {
    setLoading(true)
    sendGuildInvite(targetPlayerId)
    // Optimistic UI - mark as sent
    setTimeout(() => {
      setSent(true)
      setLoading(false)
    }, 500)
  }

  if (sent) {
    return (
      <span className={`text-green-400 text-sm ${className}`}>
        Invite Sent
      </span>
    )
  }

  return (
    <button
      onClick={handleInvite}
      disabled={loading}
      className={`px-3 py-1 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 text-white text-sm font-medium rounded transition-colors ${className}`}
    >
      {loading ? 'Sending...' : 'Invite to Guild'}
    </button>
  )
}
```

2. **Update GuildPanel to include invite list:**

In `apps/web/src/components/guild/GuildPanel.tsx`, add the GuildInviteList:

Find the imports section and add:
```typescript
import { GuildInviteList } from './GuildInviteList'
```

Find where the "no guild" state is rendered (when player is not in a guild) and add the invite list:
```typescript
  // If not in guild, show guild search/list AND pending invites
  if (!guild) {
    return (
      <div className="space-y-6">
        <GuildInviteList />
        {/* ... existing guild search UI ... */}
      </div>
    )
  }
```

The exact placement depends on the existing GuildPanel structure. The GuildInviteList should appear above the guild search/discovery UI when the player is not in a guild.
  </action>
  <verify>Run `npm run build` in apps/web. Check that invite list appears in GuildPanel for players not in a guild.</verify>
  <done>GuildInviteButton created and GuildPanel updated to show pending invites.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Guild invite frontend functionality:
- Zustand store handles invite state and WebSocket messages
- GuildInviteList shows pending invites with accept/decline buttons
- GuildInviteButton allows leader/officer to invite players
- Real-time updates via WebSocket integration
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev` in apps/web
2. Start the game server: `npm run dev` in apps/game-server
3. Test invite flow with two browser windows:

**Window 1 (Guild Leader):**
- Log in as a player in a guild with leader role
- Navigate to guild panel
- Find a player not in a guild (via player search if available)
- Click "Invite to Guild" button
- Verify "Invite Sent" confirmation appears

**Window 2 (Invited Player):**
- Log in as a player not in any guild
- Navigate to guild panel
- Verify invite appears in "Guild Invites" section
- Verify invite shows guild name, tag, member count, inviter name
- Click "Accept" - verify joins guild and sees guild data
- OR click "Decline" - verify invite is removed from list

**Additional checks:**
- Declining invite removes it from list
- Accepting invite joins guild and clears invite list
- Invite shows time remaining until expiration
  </how-to-verify>
  <resume-signal>Type "approved" to confirm invite UI works, or describe any issues found</resume-signal>
</task>

## Verification

- [ ] gameStore has guildInvites and guildOutgoingInvites state
- [ ] gameStore handles guild_invites_list, guild_invite_received, guild_invite_accepted, guild_invite_declined messages
- [ ] gameStore has sendGuildInvite, acceptGuildInvite, declineGuildInvite, fetchGuildInvites actions
- [ ] GuildInviteList component exists and displays pending invites
- [ ] GuildInviteList shows accept/decline buttons
- [ ] GuildInviteButton component exists and sends invites
- [ ] GuildPanel includes GuildInviteList for players not in a guild
- [ ] `npm run build` in apps/web completes without errors
- [ ] Human verification confirms invite flow works end-to-end

## Success Criteria

- Player not in guild sees pending invites in guild panel
- Each invite shows guild name, tag, member count, inviter name, expiration time
- Player can accept invite (joins guild, sees guild data)
- Player can decline invite (removed from list)
- Leader/Officer can send invite to player not in a guild
- Invites update in real-time (new invite appears without refresh)
- After accepting invite, invite list clears

## Output

After completion, create `.planning/phases/02-guild-invites/02-04-SUMMARY.md`
