---
phase: 05-guild-quests
plan: 06
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - apps/web/src/components/game/guild/GuildQuestsModal.tsx
  - apps/web/src/components/game/guild/QuestCard.tsx
  - apps/web/src/components/game/guild/QuestHistoryTab.tsx
  - apps/web/src/components/game/guild/index.ts
  - apps/web/src/components/game/guild/GuildPanel.tsx
  - apps/web/src/lib/confetti.ts
autonomous: true

must_haves:
  truths:
    - "Guild Quests modal accessible from guild panel"
    - "Daily and weekly quests displayed in separate sections"
    - "Quest progress shown with progress bars"
    - "Reroll button visible for leaders/officers"
    - "Quest history viewable with pagination"
    - "Confetti plays on quest completion"
  artifacts:
    - path: "apps/web/src/components/game/guild/GuildQuestsModal.tsx"
      provides: "Main quest modal with tabs"
      contains: "GuildQuestsModal"
    - path: "apps/web/src/components/game/guild/QuestCard.tsx"
      provides: "Individual quest display"
      contains: "QuestCard"
    - path: "apps/web/src/lib/confetti.ts"
      provides: "Confetti utility"
      contains: "fireConfetti"
  key_links:
    - from: "apps/web/src/components/game/guild/GuildPanel.tsx"
      to: "apps/web/src/components/game/guild/GuildQuestsModal.tsx"
      via: "Quests button opens modal"
      pattern: "setQuestsModalOpen"
    - from: "apps/web/src/components/game/guild/QuestCard.tsx"
      to: "apps/web/src/lib/confetti.ts"
      via: "completion celebration"
      pattern: "fireConfetti"
---

<objective>
Create the Guild Quests UI: modal container with daily/weekly sections, quest cards with progress bars and reroll, history tab, and confetti celebration for completions.

Purpose: Provide visual interface for guild quest system with real-time updates and celebrations.

Output: GuildQuestsModal, QuestCard, QuestHistoryTab components, confetti utility, integration with GuildPanel
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@.planning/phases/05-guild-quests/05-05-SUMMARY.md
@apps/web/src/components/game/guild/GuildBankModal.tsx (modal pattern)
@apps/web/src/components/game/guild/BankLogsTab.tsx (pagination pattern)
@apps/web/src/components/game/guild/GuildPanel.tsx (button placement)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confetti utility</name>
  <files>apps/web/src/lib/confetti.ts</files>
  <action>
Create a confetti utility file:

```typescript
import confetti from 'canvas-confetti'

/**
 * Fire celebration confetti
 * Used when guild quests are completed
 */
export function fireConfetti(): void {
  // Fire from both sides
  const duration = 2000
  const end = Date.now() + duration

  const colors = ['#ffd700', '#ffb347', '#ff6961', '#77dd77', '#aec6cf']

  ;(function frame() {
    confetti({
      particleCount: 3,
      angle: 60,
      spread: 55,
      origin: { x: 0, y: 0.7 },
      colors,
    })
    confetti({
      particleCount: 3,
      angle: 120,
      spread: 55,
      origin: { x: 1, y: 0.7 },
      colors,
    })

    if (Date.now() < end) {
      requestAnimationFrame(frame)
    }
  })()
}

/**
 * Fire a burst of confetti at a specific element
 */
export function fireConfettiAtElement(element: HTMLElement): void {
  const rect = element.getBoundingClientRect()
  const x = (rect.left + rect.width / 2) / window.innerWidth
  const y = (rect.top + rect.height / 2) / window.innerHeight

  confetti({
    particleCount: 50,
    spread: 60,
    origin: { x, y },
    colors: ['#ffd700', '#ffb347', '#ff6961', '#77dd77', '#aec6cf'],
  })
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>Confetti utility exists with fireConfetti and fireConfettiAtElement functions.</done>
</task>

<task type="auto">
  <name>Task 2: Create QuestCard component</name>
  <files>apps/web/src/components/game/guild/QuestCard.tsx</files>
  <action>
Create the QuestCard component:

```typescript
'use client'

import { useState, useEffect, useRef } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'
import { fireConfettiAtElement } from '@/lib/confetti'
import type { GuildQuestWithContribution, QuestContribution } from '@pokemon-idle/shared'

interface QuestCardProps {
  quest: GuildQuestWithContribution
  canReroll: boolean
  rerollCost: number
  rerollsRemaining: number
}

export function QuestCard({ quest, canReroll, rerollCost, rerollsRemaining }: QuestCardProps) {
  const [showLeaderboard, setShowLeaderboard] = useState(false)
  const [contributions, setContributions] = useState<QuestContribution[]>([])
  const [loadingDetails, setLoadingDetails] = useState(false)
  const [rerolling, setRerolling] = useState(false)
  const cardRef = useRef<HTMLDivElement>(null)

  const questDetails = useGameStore((state) => state.guildQuestDetails)
  const guildBank = useGameStore((state) => state.guildBank)

  const progressPercent = Math.min(100, (quest.current_progress / quest.target_count) * 100)
  const isComplete = quest.is_completed

  // Listen for completion event to fire confetti
  useEffect(() => {
    const handleCompletion = (e: CustomEvent) => {
      if (e.detail.quest_id === quest.id && cardRef.current) {
        fireConfettiAtElement(cardRef.current)
      }
    }

    window.addEventListener('guild-quest-completed', handleCompletion as EventListener)
    return () => window.removeEventListener('guild-quest-completed', handleCompletion as EventListener)
  }, [quest.id])

  // Update contributions when details load
  useEffect(() => {
    if (questDetails?.id === quest.id) {
      setContributions(questDetails.contributions)
      setLoadingDetails(false)
    }
  }, [questDetails, quest.id])

  const handleToggleLeaderboard = () => {
    if (!showLeaderboard && contributions.length === 0) {
      setLoadingDetails(true)
      gameSocket.getQuestDetails(quest.id)
    }
    setShowLeaderboard(!showLeaderboard)
  }

  const handleReroll = () => {
    if (rerolling || isComplete) return
    setRerolling(true)
    gameSocket.rerollQuest(quest.id)
    // Reset after a delay (will be updated by WebSocket)
    setTimeout(() => setRerolling(false), 2000)
  }

  // Quest type icon
  const getQuestIcon = () => {
    switch (quest.quest_type) {
      case 'catch_pokemon':
        return 'üé£'
      case 'catch_type':
        return 'üîÆ'
      case 'battle':
        return '‚öîÔ∏è'
      case 'evolve':
        return '‚ú®'
      default:
        return 'üìã'
    }
  }

  // Reward display
  const getRewardText = () => {
    const parts: string[] = []
    if (quest.reward_currency) parts.push(`${quest.reward_currency.toLocaleString()} currency`)
    if (quest.reward_guild_points) parts.push(`${quest.reward_guild_points} guild points`)
    if (quest.reward_item_id && quest.reward_item_quantity) {
      parts.push(`${quest.reward_item_quantity}x ${quest.reward_item_id}`)
    }
    return parts.join(' + ')
  }

  const canAffordReroll = guildBank && guildBank.currency.balance >= rerollCost

  return (
    <div
      ref={cardRef}
      className={`p-4 rounded-lg border transition-all ${
        isComplete
          ? 'bg-green-900/30 border-green-700/50 opacity-75'
          : 'bg-slate-700/50 border-slate-600 hover:border-slate-500'
      }`}
    >
      {/* Header */}
      <div className="flex items-start justify-between gap-2 mb-2">
        <div className="flex items-center gap-2">
          <span className="text-xl">{getQuestIcon()}</span>
          <div>
            <h4 className={`font-medium ${isComplete ? 'line-through text-slate-400' : 'text-white'}`}>
              {quest.description}
            </h4>
            {quest.type_filter && (
              <span className="text-xs text-slate-400 capitalize">
                Type: {quest.type_filter}
              </span>
            )}
          </div>
        </div>

        {/* Reroll button (leaders/officers only) */}
        {canReroll && !isComplete && rerollsRemaining > 0 && (
          <button
            onClick={handleReroll}
            disabled={rerolling || !canAffordReroll}
            className={`px-2 py-1 text-xs rounded transition-colors ${
              canAffordReroll
                ? 'bg-yellow-600 hover:bg-yellow-500 text-white'
                : 'bg-slate-600 text-slate-400 cursor-not-allowed'
            }`}
            title={canAffordReroll ? `Reroll (${rerollCost} currency)` : 'Not enough currency'}
          >
            {rerolling ? '...' : 'üîÑ'}
          </button>
        )}
      </div>

      {/* Progress bar */}
      <div className="mb-2">
        <div className="flex justify-between text-xs text-slate-400 mb-1">
          <span>
            {quest.current_progress.toLocaleString()} / {quest.target_count.toLocaleString()}
          </span>
          <span>{progressPercent.toFixed(0)}%</span>
        </div>
        <div className="h-2 bg-slate-600 rounded-full overflow-hidden">
          <div
            className={`h-full transition-all duration-300 ${
              isComplete ? 'bg-green-500' : 'bg-yellow-500'
            }`}
            style={{ width: `${progressPercent}%` }}
          />
        </div>
      </div>

      {/* My contribution */}
      <div className="flex justify-between items-center text-xs text-slate-400 mb-2">
        <span>My contribution: {quest.my_contribution.toLocaleString()}</span>
        <span className="text-yellow-400">{getRewardText()}</span>
      </div>

      {/* Leaderboard toggle */}
      <button
        onClick={handleToggleLeaderboard}
        className="text-xs text-slate-400 hover:text-white transition-colors"
      >
        {showLeaderboard ? '‚ñº Hide contributors' : '‚ñ∂ Show contributors'}
      </button>

      {/* Contribution leaderboard (expandable) */}
      {showLeaderboard && (
        <div className="mt-2 p-2 bg-slate-800 rounded">
          {loadingDetails ? (
            <p className="text-xs text-slate-400">Loading...</p>
          ) : contributions.length === 0 ? (
            <p className="text-xs text-slate-400">No contributions yet</p>
          ) : (
            <div className="space-y-1">
              {contributions.slice(0, 10).map((c, i) => (
                <div key={c.player_id} className="flex justify-between text-xs">
                  <span className={i === 0 ? 'text-yellow-400' : 'text-slate-300'}>
                    {i + 1}. {c.username}
                  </span>
                  <span className="text-slate-400">{c.contribution.toLocaleString()}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Completion badge */}
      {isComplete && (
        <div className="mt-2 text-center">
          <span className="text-green-400 text-sm font-medium">Complete!</span>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>QuestCard component exists with progress bar, leaderboard, reroll, and confetti integration.</done>
</task>

<task type="auto">
  <name>Task 3: Create GuildQuestsModal and integrate</name>
  <files>
    apps/web/src/components/game/guild/GuildQuestsModal.tsx
    apps/web/src/components/game/guild/QuestHistoryTab.tsx
    apps/web/src/components/game/guild/index.ts
    apps/web/src/components/game/guild/GuildPanel.tsx
  </files>
  <action>
**1. Create QuestHistoryTab.tsx:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'

export function QuestHistoryTab() {
  const [page, setPage] = useState(1)
  const limit = 20

  const history = useGameStore((state) => state.guildQuestHistory)

  useEffect(() => {
    gameSocket.getQuestHistory({ page, limit })
  }, [page])

  if (!history) {
    return <div className="p-4 text-slate-400">Loading history...</div>
  }

  const totalPages = Math.ceil(history.total / limit)

  const getQuestIcon = (type: string) => {
    switch (type) {
      case 'catch_pokemon': return 'üé£'
      case 'catch_type': return 'üîÆ'
      case 'battle': return '‚öîÔ∏è'
      case 'evolve': return '‚ú®'
      default: return 'üìã'
    }
  }

  return (
    <div className="p-4 overflow-auto h-full">
      {history.history.length === 0 ? (
        <p className="text-slate-400 text-center py-8">No quest history yet</p>
      ) : (
        <div className="space-y-2">
          {history.history.map((quest) => (
            <div
              key={quest.id}
              className={`p-3 rounded border ${
                quest.was_completed
                  ? 'bg-green-900/20 border-green-700/30'
                  : 'bg-red-900/20 border-red-700/30'
              }`}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span>{getQuestIcon(quest.quest_type)}</span>
                  <span className={`text-sm ${quest.was_completed ? 'text-green-400' : 'text-red-400'}`}>
                    {quest.description}
                  </span>
                </div>
                <span className="text-xs text-slate-400">
                  {new Date(quest.archived_at).toLocaleDateString()}
                </span>
              </div>
              <div className="mt-1 flex justify-between text-xs text-slate-400">
                <span>
                  {quest.final_progress}/{quest.target_count} ({quest.period})
                </span>
                {quest.was_completed && quest.reward_currency && (
                  <span className="text-yellow-400">+{quest.reward_currency} currency</span>
                )}
              </div>
              {quest.top_contributors.length > 0 && (
                <div className="mt-1 text-xs text-slate-500">
                  Top: {quest.top_contributors.map(c => c.username).join(', ')}
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex justify-center gap-2 mt-4">
          <button
            onClick={() => setPage(p => Math.max(1, p - 1))}
            disabled={page === 1}
            className="px-3 py-1 text-sm bg-slate-700 rounded disabled:opacity-50"
          >
            Previous
          </button>
          <span className="px-3 py-1 text-sm text-slate-400">
            {page} / {totalPages}
          </span>
          <button
            onClick={() => setPage(p => Math.min(totalPages, p + 1))}
            disabled={page === totalPages}
            className="px-3 py-1 text-sm bg-slate-700 rounded disabled:opacity-50"
          >
            Next
          </button>
        </div>
      )}
    </div>
  )
}
```

**2. Create GuildQuestsModal.tsx:**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useGameStore } from '@/stores/gameStore'
import { gameSocket } from '@/lib/ws/gameSocket'
import { QuestCard } from './QuestCard'
import { QuestHistoryTab } from './QuestHistoryTab'

type QuestTab = 'active' | 'history'

interface GuildQuestsModalProps {
  isOpen: boolean
  onClose: () => void
}

export function GuildQuestsModal({ isOpen, onClose }: GuildQuestsModalProps) {
  const [selectedTab, setSelectedTab] = useState<QuestTab>('active')
  const [isVisible, setIsVisible] = useState(false)

  const guildQuests = useGameStore((state) => state.guildQuests)
  const guild = useGameStore((state) => state.guild)
  const myGuildRole = useGameStore((state) => state.myGuildRole)

  // Animation and fetch on open
  useEffect(() => {
    if (isOpen) {
      setIsVisible(true)
      gameSocket.getGuildQuests()
    } else {
      const timer = setTimeout(() => setIsVisible(false), 200)
      return () => clearTimeout(timer)
    }
  }, [isOpen])

  // Keyboard handler
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        onClose()
      }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [isOpen, onClose])

  if (!isVisible) return null

  const canReroll = myGuildRole === 'leader' || myGuildRole === 'officer'

  // Format countdown timer
  const formatTimeUntil = (timestamp: string) => {
    const target = new Date(timestamp).getTime()
    const now = Date.now()
    const diff = target - now

    if (diff <= 0) return 'Resetting...'

    const hours = Math.floor(diff / (1000 * 60 * 60))
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))

    if (hours < 6) {
      return `${hours}h ${minutes}m`
    }
    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  }

  return (
    <div
      className={`fixed inset-0 z-50 flex items-center justify-center p-4 transition-all duration-200 ${
        isOpen ? 'bg-black/50' : 'bg-transparent pointer-events-none'
      }`}
      onClick={(e) => e.target === e.currentTarget && onClose()}
    >
      <div
        className={`bg-slate-800 rounded-lg border border-slate-600 shadow-xl w-full max-w-3xl max-h-[85vh] flex flex-col transition-all duration-200 ${
          isOpen ? 'scale-100 opacity-100' : 'scale-95 opacity-0'
        }`}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-700">
          <div>
            <h2 className="text-lg font-semibold text-white">Guild Quests</h2>
            {guild && (
              <p className="text-sm text-slate-400">[{guild.tag}] {guild.name}</p>
            )}
          </div>
          <button
            onClick={onClose}
            className="text-slate-400 hover:text-white transition-colors"
          >
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Tab Navigation */}
        <div className="flex border-b border-slate-700">
          <button
            onClick={() => setSelectedTab('active')}
            className={`px-4 py-2 text-sm font-medium transition-colors ${
              selectedTab === 'active'
                ? 'text-yellow-400 border-b-2 border-yellow-400'
                : 'text-slate-400 hover:text-white'
            }`}
          >
            Active Quests
          </button>
          <button
            onClick={() => setSelectedTab('history')}
            className={`px-4 py-2 text-sm font-medium transition-colors ${
              selectedTab === 'history'
                ? 'text-yellow-400 border-b-2 border-yellow-400'
                : 'text-slate-400 hover:text-white'
            }`}
          >
            History
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-auto">
          {selectedTab === 'history' ? (
            <QuestHistoryTab />
          ) : !guildQuests ? (
            <div className="flex items-center justify-center h-64">
              <p className="text-slate-400">Loading quests...</p>
            </div>
          ) : (
            <div className="p-4 space-y-6">
              {/* Reroll status */}
              {canReroll && (
                <div className="flex gap-4 text-sm text-slate-400">
                  <span>
                    Daily rerolls: {guildQuests.reroll_status.daily_max - guildQuests.reroll_status.daily_used} remaining
                    ({guildQuests.reroll_status.daily_cost} currency each)
                  </span>
                  <span>
                    Weekly rerolls: {guildQuests.reroll_status.weekly_max - guildQuests.reroll_status.weekly_used} remaining
                    ({guildQuests.reroll_status.weekly_cost} currency each)
                  </span>
                </div>
              )}

              {/* Daily Quests */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-medium text-white">Daily Quests</h3>
                  <span className="text-sm text-slate-400">
                    Resets in: {formatTimeUntil(guildQuests.reset_times.daily)}
                  </span>
                </div>
                <div className="grid gap-3">
                  {guildQuests.daily.map((quest) => (
                    <QuestCard
                      key={quest.id}
                      quest={quest}
                      canReroll={canReroll}
                      rerollCost={guildQuests.reroll_status.daily_cost}
                      rerollsRemaining={guildQuests.reroll_status.daily_max - guildQuests.reroll_status.daily_used}
                    />
                  ))}
                </div>
              </div>

              {/* Weekly Quests */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-medium text-white">Weekly Quests</h3>
                  <span className="text-sm text-slate-400">
                    Resets in: {formatTimeUntil(guildQuests.reset_times.weekly)}
                  </span>
                </div>
                <div className="grid gap-3">
                  {guildQuests.weekly.map((quest) => (
                    <QuestCard
                      key={quest.id}
                      quest={quest}
                      canReroll={canReroll}
                      rerollCost={guildQuests.reroll_status.weekly_cost}
                      rerollsRemaining={guildQuests.reroll_status.weekly_max - guildQuests.reroll_status.weekly_used}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
```

**3. Update index.ts to export new components:**

Add to apps/web/src/components/game/guild/index.ts:
```typescript
export { GuildQuestsModal } from './GuildQuestsModal'
export { QuestCard } from './QuestCard'
export { QuestHistoryTab } from './QuestHistoryTab'
```

**4. Add Quests button to GuildPanel.tsx:**

Find the section with the Bank button and add a Quests button nearby:

```typescript
// Add state for modal
const [questsModalOpen, setQuestsModalOpen] = useState(false)

// Add button next to Bank button
<button
  onClick={() => setQuestsModalOpen(true)}
  className="px-3 py-1.5 text-sm bg-purple-600 hover:bg-purple-500 text-white rounded transition-colors"
>
  Quests
</button>

// Add modal at bottom of component (near GuildBankModal)
<GuildQuestsModal
  isOpen={questsModalOpen}
  onClose={() => setQuestsModalOpen(false)}
/>
```

Import the modal:
```typescript
import { GuildQuestsModal } from './GuildQuestsModal'
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>GuildQuestsModal, QuestHistoryTab created and integrated with GuildPanel.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. apps/web/src/lib/confetti.ts exists with fireConfetti functions
2. QuestCard.tsx displays quest with progress bar, leaderboard, reroll
3. QuestHistoryTab.tsx shows paginated history
4. GuildQuestsModal.tsx has active/history tabs, daily/weekly sections
5. GuildPanel.tsx has Quests button that opens modal
6. All components exported from index.ts
7. TypeScript compiles without errors
</verification>

<success_criteria>
- Quests button visible in GuildPanel
- Modal shows daily and weekly quests in separate sections
- Each quest shows progress bar with current/target
- Contribution leaderboard expandable on each quest
- Reroll button visible for leaders/officers (grayed if insufficient funds)
- Reset countdown displayed for each period
- History tab shows completed/failed quests with pagination
- Confetti fires on quest completion
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-06-SUMMARY.md`
</output>
