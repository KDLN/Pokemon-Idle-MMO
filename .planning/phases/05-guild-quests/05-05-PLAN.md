---
phase: 05-guild-quests
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - apps/web/src/stores/gameStore.ts
  - apps/web/src/lib/ws/gameSocket.ts
  - apps/web/package.json
autonomous: true
user_setup:
  - service: npm
    why: "Confetti library installation"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "Zustand store has quest state and actions"
    - "gameSocket has quest WebSocket handlers"
    - "gameSocket has quest send methods"
    - "canvas-confetti package installed"
  artifacts:
    - path: "apps/web/src/stores/gameStore.ts"
      provides: "Quest state and actions"
      contains: "guildQuests"
    - path: "apps/web/src/lib/ws/gameSocket.ts"
      provides: "Quest WebSocket integration"
      contains: "guild_quests_data"
  key_links:
    - from: "apps/web/src/lib/ws/gameSocket.ts"
      to: "apps/web/src/stores/gameStore.ts"
      via: "setGuildQuests"
      pattern: "setGuildQuests.*quests"
---

<objective>
Add frontend state management for guild quests: Zustand store state/actions, gameSocket WebSocket handlers and send methods, and install confetti library for celebrations.

Purpose: Enable frontend to manage quest state and communicate with game server.

Output: Quest state in gameStore, WebSocket integration in gameSocket, confetti package installed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@.planning/phases/05-guild-quests/05-03-SUMMARY.md
@.planning/phases/05-guild-quests/05-04-SUMMARY.md
@apps/web/src/stores/gameStore.ts (existing store patterns)
@apps/web/src/lib/ws/gameSocket.ts (existing WebSocket patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install confetti library</name>
  <files>apps/web/package.json</files>
  <action>
Install canvas-confetti for celebration animations:

```bash
cd apps/web && npm install canvas-confetti
```

Also install types for TypeScript:
```bash
cd apps/web && npm install -D @types/canvas-confetti
```

Verify installation by checking package.json includes:
- "canvas-confetti": "^1.x.x" in dependencies
- "@types/canvas-confetti": "^1.x.x" in devDependencies
  </action>
  <verify>Run `cd apps/web && npm list canvas-confetti` - shows installed version</verify>
  <done>canvas-confetti package installed with types.</done>
</task>

<task type="auto">
  <name>Task 2: Add quest state to Zustand store</name>
  <files>apps/web/src/stores/gameStore.ts</files>
  <action>
Add quest state and actions to the gameStore:

**1. Add state interface (in GameState interface):**
```typescript
// Guild Quests
guildQuests: GuildQuestsState | null
guildQuestDetails: GuildQuestDetailed | null
guildQuestHistory: {
  history: GuildQuestHistory[]
  total: number
  page: number
} | null
```

**2. Add initial state (in create()):**
```typescript
guildQuests: null,
guildQuestDetails: null,
guildQuestHistory: null,
```

**3. Add actions (in actions object):**
```typescript
// Guild Quest Actions
setGuildQuests: (quests: GuildQuestsState | null) =>
  set({ guildQuests: quests }),

setGuildQuestDetails: (details: GuildQuestDetailed | null) =>
  set({ guildQuestDetails: details }),

setGuildQuestHistory: (history: { history: GuildQuestHistory[]; total: number; page: number } | null) =>
  set({ guildQuestHistory: history }),

updateQuestProgress: (questId: string, progress: number, isCompleted: boolean) =>
  set((state) => {
    if (!state.guildQuests) return state

    const updateQuest = (quest: GuildQuestWithContribution) =>
      quest.id === questId
        ? { ...quest, current_progress: progress, is_completed: isCompleted }
        : quest

    return {
      guildQuests: {
        ...state.guildQuests,
        daily: state.guildQuests.daily.map(updateQuest),
        weekly: state.guildQuests.weekly.map(updateQuest),
      },
    }
  }),

updateQuestContribution: (questId: string, playerId: string, amount: number) =>
  set((state) => {
    if (!state.guildQuests) return state

    const updateQuest = (quest: GuildQuestWithContribution) => {
      if (quest.id !== questId) return quest
      // If this is the current player, update my_contribution
      return { ...quest, my_contribution: quest.my_contribution + amount }
    }

    return {
      guildQuests: {
        ...state.guildQuests,
        daily: state.guildQuests.daily.map(updateQuest),
        weekly: state.guildQuests.weekly.map(updateQuest),
      },
    }
  }),

replaceQuest: (oldQuestId: string, newQuest: GuildQuestWithContribution, newRerollStatus: QuestRerollStatus) =>
  set((state) => {
    if (!state.guildQuests) return state

    const replaceInList = (quests: GuildQuestWithContribution[]) =>
      quests.map(q => q.id === oldQuestId ? newQuest : q)

    return {
      guildQuests: {
        ...state.guildQuests,
        daily: replaceInList(state.guildQuests.daily),
        weekly: replaceInList(state.guildQuests.weekly),
        reroll_status: newRerollStatus,
      },
    }
  }),

clearGuildQuests: () =>
  set({ guildQuests: null, guildQuestDetails: null, guildQuestHistory: null }),
```

**4. Add type imports:**
```typescript
import type {
  GuildQuestsState,
  GuildQuestDetailed,
  GuildQuestHistory,
  GuildQuestWithContribution,
  QuestRerollStatus,
} from '@pokemon-idle/shared'
```

**5. Clear quests on guild leave (find clearGuild or similar action):**
Add `guildQuests: null, guildQuestDetails: null, guildQuestHistory: null` to the clear action.
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>Quest state and actions added to Zustand store.</done>
</task>

<task type="auto">
  <name>Task 3: Add quest WebSocket handlers and send methods</name>
  <files>apps/web/src/lib/ws/gameSocket.ts</files>
  <action>
Add WebSocket handlers and send methods for quests:

**1. Add message handlers (in the message switch statement):**

```typescript
// Guild Quest handlers
case 'guild_quests_data':
  useGameStore.getState().setGuildQuests(payload.quests)
  break

case 'guild_quest_details':
  useGameStore.getState().setGuildQuestDetails(payload.quest)
  break

case 'guild_quest_progress':
  {
    const { quest_id, current_progress, is_completed, contributor_id, contribution_amount } = payload
    const store = useGameStore.getState()
    store.updateQuestProgress(quest_id, current_progress, is_completed)

    // Update contribution if it's the current player
    const playerId = store.player?.id
    if (playerId === contributor_id) {
      store.updateQuestContribution(quest_id, contributor_id, contribution_amount)
    }
  }
  break

case 'guild_quest_milestone':
  {
    const { quest_description, milestone, period } = payload
    // Show toast notification for milestone
    const periodLabel = period === 'daily' ? 'Daily' : 'Weekly'
    toast.success(`${periodLabel} Quest ${milestone}%: ${quest_description}`)
  }
  break

case 'guild_quest_completed':
  {
    const { quest_description, period, reward_currency, reward_guild_points } = payload
    const periodLabel = period === 'daily' ? 'Daily' : 'Weekly'
    let rewardText = ''
    if (reward_currency) rewardText += `${reward_currency} currency`
    if (reward_guild_points) {
      if (rewardText) rewardText += ', '
      rewardText += `${reward_guild_points} guild points`
    }
    toast.success(`${periodLabel} Quest Complete: ${quest_description}! Rewards: ${rewardText}`)

    // Trigger confetti (will be handled by QuestCard component listening to completions)
    window.dispatchEvent(new CustomEvent('guild-quest-completed', { detail: payload }))
  }
  break

case 'guild_quest_rerolled':
  {
    const { old_quest_id, new_quest, rerolled_by_username, new_reroll_status } = payload
    useGameStore.getState().replaceQuest(old_quest_id, new_quest, new_reroll_status)
    toast.info(`Quest rerolled by ${rerolled_by_username}`)
  }
  break

case 'guild_quest_history':
  useGameStore.getState().setGuildQuestHistory(payload)
  break

case 'guild_quests_reset':
  {
    const { period, new_quests } = payload
    const store = useGameStore.getState()
    if (!store.guildQuests) break

    const periodLabel = period === 'daily' ? 'Daily' : 'Weekly'
    toast.info(`${periodLabel} quests have reset!`)

    // Replace quests for the reset period
    if (period === 'daily') {
      store.setGuildQuests({
        ...store.guildQuests,
        daily: new_quests,
        reset_times: payload.reset_times,
      })
    } else {
      store.setGuildQuests({
        ...store.guildQuests,
        weekly: new_quests,
        reset_times: payload.reset_times,
      })
    }
  }
  break

case 'guild_quest_error':
  toast.error(payload.error)
  break
```

**2. Add send methods (in the gameSocket object):**

```typescript
// Guild Quest send methods
getGuildQuests() {
  this.send({ type: 'get_guild_quests', payload: {} })
},

getQuestDetails(questId: string) {
  this.send({ type: 'get_quest_details', payload: { quest_id: questId } })
},

rerollQuest(questId: string) {
  this.send({ type: 'reroll_quest', payload: { quest_id: questId } })
},

getQuestHistory(options?: { page?: number; limit?: number }) {
  this.send({ type: 'get_quest_history', payload: options || {} })
},
```

**3. Add type imports:**
```typescript
import type {
  GuildQuestsDataPayload,
  GuildQuestDetailsPayload,
  GuildQuestProgressPayload,
  GuildQuestMilestonePayload,
  GuildQuestCompletedPayload,
  GuildQuestRerolledPayload,
  GuildQuestHistoryPayload,
  GuildQuestsResetPayload,
  GuildQuestErrorPayload,
} from '@pokemon-idle/shared'
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit`</verify>
  <done>Quest WebSocket handlers and send methods added.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. canvas-confetti installed in apps/web
2. gameStore has guildQuests, guildQuestDetails, guildQuestHistory state
3. gameStore has quest actions: set, update, replace, clear
4. gameSocket handles all quest message types
5. gameSocket has send methods: getGuildQuests, getQuestDetails, rerollQuest, getQuestHistory
6. TypeScript compiles without errors
</verification>

<success_criteria>
- canvas-confetti package installed
- Quest state stored in Zustand
- Progress updates modify state correctly
- Reroll replaces quest in state
- Milestone and completion show toast notifications
- Completion dispatches custom event for confetti
- All send methods available on gameSocket
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-05-SUMMARY.md`
</output>
