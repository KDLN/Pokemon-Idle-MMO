---
phase: 05-guild-quests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/types/guild.ts
autonomous: true

must_haves:
  truths:
    - "Quest types are defined for all quest kinds and periods"
    - "WebSocket payloads exist for all quest operations"
    - "Types are exported from @pokemon-idle/shared"
  artifacts:
    - path: "packages/shared/src/types/guild.ts"
      provides: "Quest types and WebSocket payloads"
      contains: "GuildQuest"
  key_links:
    - from: "packages/shared/src/types/guild.ts"
      to: "packages/shared/src/types/index.ts"
      via: "re-export"
      pattern: "export.*from.*guild"
---

<objective>
Define TypeScript types for guild quests including quest data structures, contributions, history, and all WebSocket message payloads for quest operations.

Purpose: Establish type-safe interfaces shared between game server and frontend for quest data and real-time updates.

Output: Quest types added to packages/shared/src/types/guild.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@packages/shared/src/types/guild.ts (existing guild types pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quest data types</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Add the following types to the end of guild.ts (after existing Guild Bank types):

```typescript
// ================================
// Guild Quest Types
// ================================

// Quest type enum matching database
export type QuestType = 'catch_pokemon' | 'catch_type' | 'battle' | 'evolve'

// Quest period
export type QuestPeriod = 'daily' | 'weekly'

// Individual quest data
export interface GuildQuest {
  id: string
  guild_id: string
  quest_type: QuestType
  period: QuestPeriod
  target_count: number
  current_progress: number
  reward_currency: number | null
  reward_guild_points: number | null
  reward_item_id: string | null
  reward_item_quantity: number | null
  type_filter: string | null  // e.g., 'water', 'fire' for catch_type
  description: string
  is_completed: boolean
  completed_at: string | null
  quest_date: string  // ISO date
  created_at: string
}

// Quest with player's contribution
export interface GuildQuestWithContribution extends GuildQuest {
  my_contribution: number
}

// Contribution entry for leaderboard
export interface QuestContribution {
  player_id: string
  username: string
  contribution: number
  rank: number
}

// Quest with full contribution leaderboard
export interface GuildQuestDetailed extends GuildQuestWithContribution {
  contributions: QuestContribution[]
}

// Reroll status
export interface QuestRerollStatus {
  daily_used: number
  daily_max: number
  weekly_used: number
  weekly_max: number
  daily_cost: number
  weekly_cost: number
}

// Reset time info
export interface QuestResetTimes {
  daily: string   // Next daily reset timestamp
  weekly: string  // Next weekly reset timestamp
}

// Full quest state returned by get_guild_quests
export interface GuildQuestsState {
  daily: GuildQuestWithContribution[]
  weekly: GuildQuestWithContribution[]
  reroll_status: QuestRerollStatus
  reset_times: QuestResetTimes
}

// History entry (archived quest)
export interface GuildQuestHistory {
  id: string
  guild_id: string
  quest_type: QuestType
  period: QuestPeriod
  target_count: number
  final_progress: number
  was_completed: boolean
  reward_currency: number | null
  reward_guild_points: number | null
  reward_item_id: string | null
  reward_item_quantity: number | null
  type_filter: string | null
  description: string
  quest_date: string
  archived_at: string
  top_contributors: QuestContribution[]
}
```
  </action>
  <verify>TypeScript compiles: `cd packages/shared && npx tsc --noEmit`</verify>
  <done>Quest data types defined with proper structure matching database schema.</done>
</task>

<task type="auto">
  <name>Task 2: Add quest WebSocket payloads</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Add WebSocket payload types after the quest data types:

```typescript
// ================================
// Guild Quest WebSocket Payloads
// ================================

// Client -> Server payloads

// Get all active quests (triggers lazy generation)
export interface GetGuildQuestsPayload {
  // Empty - requests full quest state
}

// Get quest details with full contribution leaderboard
export interface GetQuestDetailsPayload {
  quest_id: string
}

// Reroll a quest
export interface RerollQuestPayload {
  quest_id: string
}

// Get quest history
export interface GetQuestHistoryPayload {
  page?: number
  limit?: number
}

// Server -> Client payloads

// Full quest state response
export interface GuildQuestsDataPayload {
  quests: GuildQuestsState
}

// Quest details response (with full leaderboard)
export interface GuildQuestDetailsPayload {
  quest: GuildQuestDetailed
}

// Quest progress update broadcast
export interface GuildQuestProgressPayload {
  quest_id: string
  current_progress: number
  target_count: number
  is_completed: boolean
  contributor_id: string
  contributor_username: string
  contribution_amount: number
}

// Quest milestone reached broadcast (25%, 50%, 75%, 100%)
export interface GuildQuestMilestonePayload {
  quest_id: string
  quest_description: string
  period: QuestPeriod
  milestone: 25 | 50 | 75 | 100
  current_progress: number
  target_count: number
}

// Quest completed broadcast (100% milestone with rewards)
export interface GuildQuestCompletedPayload {
  quest_id: string
  quest_description: string
  period: QuestPeriod
  reward_currency: number | null
  reward_guild_points: number | null
  reward_item_id: string | null
  reward_item_quantity: number | null
  top_contributors: QuestContribution[]
}

// Quest rerolled broadcast
export interface GuildQuestRerolledPayload {
  old_quest_id: string
  new_quest: GuildQuestWithContribution
  rerolled_by: string
  rerolled_by_username: string
  new_reroll_status: QuestRerollStatus
}

// Quest history response
export interface GuildQuestHistoryPayload {
  history: GuildQuestHistory[]
  total: number
  page: number
}

// Quests reset notification (new day/week)
export interface GuildQuestsResetPayload {
  period: QuestPeriod
  new_quests: GuildQuestWithContribution[]
  reset_times: QuestResetTimes
}

// Error response
export interface GuildQuestErrorPayload {
  error: string
  code?: string
}
```
  </action>
  <verify>TypeScript compiles: `cd packages/shared && npx tsc --noEmit`</verify>
  <done>WebSocket payload types defined for all quest operations.</done>
</task>

<task type="auto">
  <name>Task 3: Verify exports</name>
  <files>packages/shared/src/types/guild.ts</files>
  <action>
Verify all new types are properly exported:

1. Check that all types in guild.ts use `export` keyword
2. Check packages/shared/src/types/index.ts includes guild.ts re-export
3. Run TypeScript compilation to verify no errors

The index.ts should already have: `export * from './guild'`
If not, add it.

Run full package build to ensure types are consumable:
```bash
cd packages/shared && npm run build
```
  </action>
  <verify>Run `cd packages/shared && npm run build` - exits with code 0</verify>
  <done>All quest types exported and consumable from @pokemon-idle/shared</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. packages/shared/src/types/guild.ts contains all quest types
2. TypeScript compiles without errors
3. Types can be imported: `import { GuildQuest, GuildQuestsState } from '@pokemon-idle/shared'`
4. All WebSocket payloads defined for quest operations
</verification>

<success_criteria>
- QuestType and QuestPeriod type aliases defined
- GuildQuest interface matches database schema
- GuildQuestWithContribution adds player's contribution
- QuestContribution for leaderboard entries
- GuildQuestsState aggregates full quest state
- GuildQuestHistory for archived quests
- All client->server payloads: GetGuildQuestsPayload, GetQuestDetailsPayload, RerollQuestPayload, GetQuestHistoryPayload
- All server->client payloads: progress, milestone, completed, rerolled, history, reset, error
- Types compile and export successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-02-SUMMARY.md`
</output>
