---
phase: 05-guild-quests
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - apps/game-server/src/db.ts
  - apps/game-server/src/hub.ts
autonomous: true

must_haves:
  truths:
    - "Catches in processTicks update guild quest progress"
    - "Battles in processTicks update guild quest progress"
    - "Evolutions in processTicks update guild quest progress"
    - "Quest progress broadcasts to all guild members in real-time"
    - "Milestone notifications broadcast at 25%, 50%, 75%, 100%"
  artifacts:
    - path: "apps/game-server/src/db.ts"
      provides: "Quest database wrapper functions"
      contains: "updateGuildQuestProgress"
    - path: "apps/game-server/src/hub.ts"
      provides: "Activity hooks in processTicks"
      contains: "updateGuildQuestProgress"
  key_links:
    - from: "apps/game-server/src/hub.ts"
      to: "apps/game-server/src/db.ts"
      via: "updateGuildQuestProgress call"
      pattern: "updateGuildQuestProgress.*guild_id.*player_id"
    - from: "apps/game-server/src/hub.ts"
      to: "broadcastToGuild"
      via: "quest progress broadcast"
      pattern: "broadcastToGuild.*guild_quest_progress"
---

<objective>
Add activity tracking hooks to processTicks() that automatically update guild quest progress when members catch Pokemon, battle, or evolve. Implement real-time broadcasts for progress updates and milestone notifications.

Purpose: Enable automatic quest progress tracking from all member activities with real-time visibility.

Output: Activity hooks in hub.ts and database wrapper functions in db.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@.planning/phases/05-guild-quests/05-RESEARCH.md
@.planning/phases/05-guild-quests/05-01-SUMMARY.md
@.planning/phases/05-guild-quests/05-02-SUMMARY.md
@apps/game-server/src/hub.ts (processTicks pattern, broadcastToGuild)
@apps/game-server/src/db.ts (database function patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quest database wrapper functions</name>
  <files>apps/game-server/src/db.ts</files>
  <action>
Add the following functions to db.ts after existing guild bank functions:

```typescript
// ================================
// Guild Quest Functions
// ================================

/**
 * Update quest progress for a specific activity type
 * Returns updated quest(s) with milestone info for broadcasting
 */
export async function updateGuildQuestProgress(
  guildId: string,
  playerId: string,
  questType: 'catch_pokemon' | 'catch_type' | 'battle' | 'evolve',
  amount: number = 1,
  typeFilter?: string  // For catch_type quests (e.g., 'water', 'fire')
): Promise<{
  quest_id: string
  current_progress: number
  target_count: number
  is_completed: boolean
  milestone: 25 | 50 | 75 | 100 | null
  description: string
  period: 'daily' | 'weekly'
}[] | null> {
  const { data, error } = await getSupabase().rpc('update_quest_progress', {
    p_guild_id: guildId,
    p_player_id: playerId,
    p_quest_type: questType,
    p_amount: amount,
    p_type_filter: typeFilter || null
  })

  if (error) {
    console.error('Error updating quest progress:', error)
    return null
  }

  return data
}

/**
 * Record guild activity for difficulty scaling
 */
export async function recordGuildActivity(
  guildId: string,
  activityType: 'catch' | 'battle' | 'evolve',
  amount: number = 1
): Promise<void> {
  const { error } = await getSupabase().rpc('record_guild_activity', {
    p_guild_id: guildId,
    p_activity_type: activityType,
    p_amount: amount
  })

  if (error) {
    console.error('Error recording guild activity:', error)
  }
}

/**
 * Get all active quests for a guild (triggers lazy generation)
 */
export async function getGuildQuests(
  guildId: string,
  playerId: string
): Promise<GuildQuestsState | null> {
  const { data, error } = await getSupabase().rpc('get_guild_quests', {
    p_guild_id: guildId,
    p_player_id: playerId
  })

  if (error) {
    console.error('Error getting guild quests:', error)
    return null
  }

  return data
}

/**
 * Get quest details with full contribution leaderboard
 */
export async function getQuestDetails(
  questId: string,
  playerId: string
): Promise<GuildQuestDetailed | null> {
  const { data, error } = await getSupabase().rpc('get_quest_details', {
    p_quest_id: questId,
    p_player_id: playerId
  })

  if (error) {
    console.error('Error getting quest details:', error)
    return null
  }

  return data
}

/**
 * Reroll a quest (leader/officer only)
 */
export async function rerollQuest(
  guildId: string,
  playerId: string,
  questId: string
): Promise<{
  new_quest: GuildQuestWithContribution
  new_reroll_status: QuestRerollStatus
} | { error: string }> {
  const { data, error } = await getSupabase().rpc('reroll_quest', {
    p_guild_id: guildId,
    p_player_id: playerId,
    p_quest_id: questId
  })

  if (error) {
    console.error('Error rerolling quest:', error)
    return { error: error.message }
  }

  return data
}

/**
 * Get quest history (paginated)
 */
export async function getQuestHistory(
  guildId: string,
  page: number = 1,
  limit: number = 20
): Promise<{
  history: GuildQuestHistory[]
  total: number
  page: number
} | null> {
  const { data, error } = await getSupabase().rpc('get_quest_history', {
    p_guild_id: guildId,
    p_page: page,
    p_limit: limit
  })

  if (error) {
    console.error('Error getting quest history:', error)
    return null
  }

  return data
}
```

Also add the necessary imports at the top of db.ts:
```typescript
import type {
  GuildQuestsState,
  GuildQuestDetailed,
  GuildQuestWithContribution,
  QuestRerollStatus,
  GuildQuestHistory
} from '@pokemon-idle/shared'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>Database wrapper functions exist for all quest operations.</done>
</task>

<task type="auto">
  <name>Task 2: Add activity hooks to processTicks</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Modify the processTicks() method to track guild quest progress. Add hooks at three points:

**1. After successful catch (around line 1260):**

Find the existing code:
```typescript
// Update weekly stats for catch (Issue #54)
await updateWeeklyStats(client.session.player.id, {
  catches: 1,
  pokedex: isNewSpecies ? 1 : 0
})
```

Add AFTER it:
```typescript
// Update guild quest progress for catch
if (client.session.guild?.id) {
  const speciesData = this.speciesMap.get(savedPokemon.species_id)

  // Fire-and-forget: update quest progress and record activity
  this.updateQuestProgress(
    client.session.guild.id,
    client.session.player.id,
    client.session.player.username,
    'catch_pokemon',
    1,
    speciesData?.type1  // Pass primary type for catch_type quests
  )

  // Record for difficulty scaling
  recordGuildActivity(client.session.guild.id, 'catch', 1)
}
```

**2. After battle tick (find battle result handling):**

Find where battle results are processed and add:
```typescript
// Update guild quest progress for battle
if (client.session.guild?.id && result.battle_result) {
  this.updateQuestProgress(
    client.session.guild.id,
    client.session.player.id,
    client.session.player.username,
    'battle',
    1
  )

  recordGuildActivity(client.session.guild.id, 'battle', 1)
}
```

**3. After evolution (find evolution handling):**

Find where evolutions are processed and add:
```typescript
// Update guild quest progress for evolution
if (client.session.guild?.id && result.evolutions && result.evolutions.length > 0) {
  this.updateQuestProgress(
    client.session.guild.id,
    client.session.player.id,
    client.session.player.username,
    'evolve',
    result.evolutions.length
  )

  recordGuildActivity(client.session.guild.id, 'evolve', result.evolutions.length)
}
```

**Add imports at top of hub.ts:**
```typescript
import {
  updateGuildQuestProgress,
  recordGuildActivity,
  // ... existing imports
} from './db'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>Activity hooks exist in processTicks for catches, battles, and evolutions.</done>
</task>

<task type="auto">
  <name>Task 3: Add quest progress broadcast helper</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Add a private helper method to Hub class that handles quest progress updates and broadcasts:

```typescript
/**
 * Update guild quest progress and broadcast results
 * Fire-and-forget pattern - does not block tick processing
 */
private async updateQuestProgress(
  guildId: string,
  playerId: string,
  username: string,
  questType: 'catch_pokemon' | 'catch_type' | 'battle' | 'evolve',
  amount: number,
  typeFilter?: string
): Promise<void> {
  try {
    const updates = await updateGuildQuestProgress(
      guildId,
      playerId,
      questType,
      amount,
      typeFilter
    )

    if (!updates || updates.length === 0) return

    for (const update of updates) {
      // Broadcast progress update
      this.broadcastToGuild(guildId, 'guild_quest_progress', {
        quest_id: update.quest_id,
        current_progress: update.current_progress,
        target_count: update.target_count,
        is_completed: update.is_completed,
        contributor_id: playerId,
        contributor_username: username,
        contribution_amount: amount
      })

      // Broadcast milestone if reached
      if (update.milestone) {
        this.broadcastToGuild(guildId, 'guild_quest_milestone', {
          quest_id: update.quest_id,
          quest_description: update.description,
          period: update.period,
          milestone: update.milestone,
          current_progress: update.current_progress,
          target_count: update.target_count
        })

        // If 100% milestone (completion), broadcast completion with rewards
        if (update.milestone === 100) {
          // Fetch full quest details for reward info
          const questDetails = await getQuestDetails(update.quest_id, playerId)
          if (questDetails) {
            this.broadcastToGuild(guildId, 'guild_quest_completed', {
              quest_id: update.quest_id,
              quest_description: update.description,
              period: update.period,
              reward_currency: questDetails.reward_currency,
              reward_guild_points: questDetails.reward_guild_points,
              reward_item_id: questDetails.reward_item_id,
              reward_item_quantity: questDetails.reward_item_quantity,
              top_contributors: questDetails.contributions.slice(0, 3)
            })
          }
        }
      }
    }
  } catch (error) {
    console.error('Error updating quest progress:', error)
    // Don't throw - fire-and-forget pattern
  }
}
```

Also add import for getQuestDetails if not already imported:
```typescript
import { getQuestDetails } from './db'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>Quest progress broadcast helper exists with milestone detection and completion notifications.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. db.ts contains all quest wrapper functions
2. hub.ts has activity hooks in processTicks after catch/battle/evolve
3. updateQuestProgress helper broadcasts progress and milestones
4. TypeScript compiles without errors
5. Fire-and-forget pattern maintained (no await in main tick flow)
</verification>

<success_criteria>
- Catches update both catch_pokemon and catch_type quest progress
- Battles update battle quest progress
- Evolutions update evolve quest progress
- Guild activity recorded for difficulty scaling
- Progress broadcasts to all guild members via WebSocket
- Milestone broadcasts at 25%, 50%, 75%, 100%
- Completion broadcast includes rewards and top contributors
- Fire-and-forget pattern prevents tick blocking
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-03-SUMMARY.md`
</output>
