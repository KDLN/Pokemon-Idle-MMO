---
phase: 05-guild-quests
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - apps/game-server/src/hub.ts
autonomous: true

must_haves:
  truths:
    - "Players can fetch guild quests via WebSocket"
    - "Players can view quest details with contribution leaderboard"
    - "Leaders/Officers can reroll quests"
    - "Players can view quest history"
  artifacts:
    - path: "apps/game-server/src/hub.ts"
      provides: "Quest WebSocket handlers"
      contains: "get_guild_quests"
  key_links:
    - from: "apps/game-server/src/hub.ts"
      to: "apps/game-server/src/db.ts"
      via: "getGuildQuests call"
      pattern: "getGuildQuests.*guild_id"
---

<objective>
Add WebSocket message handlers for quest operations: fetching quests, viewing details, rerolling, and viewing history. Follow existing fire-and-forget handler pattern from guild bank.

Purpose: Enable frontend to interact with quest system via WebSocket protocol.

Output: Quest handlers in hub.ts message switch statement
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@.planning/phases/05-guild-quests/05-01-SUMMARY.md
@.planning/phases/05-guild-quests/05-02-SUMMARY.md
@apps/game-server/src/hub.ts (message handler patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quest fetch and details handlers</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Add the following handlers to the message switch statement in handleMessage(), following the fire-and-forget pattern used by guild bank handlers:

```typescript
// ================================
// Guild Quest Handlers
// ================================

case 'get_guild_quests':
  this.handleGetGuildQuests(client)
  break

case 'get_quest_details':
  this.handleGetQuestDetails(client, payload as GetQuestDetailsPayload)
  break
```

Add the handler methods to the Hub class:

```typescript
/**
 * Handle get_guild_quests - fetch all active quests (triggers lazy generation)
 */
private async handleGetGuildQuests(client: GameClient): Promise<void> {
  if (!client.session?.guild) {
    this.send(client, 'guild_quest_error', { error: 'Not in a guild' })
    return
  }

  const quests = await getGuildQuests(
    client.session.guild.id,
    client.session.player.id
  )

  if (!quests) {
    this.send(client, 'guild_quest_error', { error: 'Failed to fetch quests' })
    return
  }

  this.send(client, 'guild_quests_data', { quests })
}

/**
 * Handle get_quest_details - fetch quest with full contribution leaderboard
 */
private async handleGetQuestDetails(
  client: GameClient,
  payload: GetQuestDetailsPayload
): Promise<void> {
  if (!client.session?.guild) {
    this.send(client, 'guild_quest_error', { error: 'Not in a guild' })
    return
  }

  if (!payload.quest_id) {
    this.send(client, 'guild_quest_error', { error: 'Quest ID required' })
    return
  }

  const quest = await getQuestDetails(
    payload.quest_id,
    client.session.player.id
  )

  if (!quest) {
    this.send(client, 'guild_quest_error', { error: 'Quest not found' })
    return
  }

  this.send(client, 'guild_quest_details', { quest })
}
```

Add the necessary type imports at the top of hub.ts:
```typescript
import type { GetQuestDetailsPayload } from '@pokemon-idle/shared'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>Quest fetch and details handlers exist.</done>
</task>

<task type="auto">
  <name>Task 2: Add reroll handler</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Add the reroll handler to the message switch statement:

```typescript
case 'reroll_quest':
  this.handleRerollQuest(client, payload as RerollQuestPayload)
  break
```

Add the handler method:

```typescript
/**
 * Handle reroll_quest - reroll a quest (leader/officer only)
 */
private async handleRerollQuest(
  client: GameClient,
  payload: RerollQuestPayload
): Promise<void> {
  if (!client.session?.guild) {
    this.send(client, 'guild_quest_error', { error: 'Not in a guild' })
    return
  }

  // Permission check: must be leader or officer
  if (client.session.guild.role === 'member') {
    this.send(client, 'guild_quest_error', {
      error: 'Only leaders and officers can reroll quests'
    })
    return
  }

  if (!payload.quest_id) {
    this.send(client, 'guild_quest_error', { error: 'Quest ID required' })
    return
  }

  const result = await rerollQuest(
    client.session.guild.id,
    client.session.player.id,
    payload.quest_id
  )

  if ('error' in result) {
    this.send(client, 'guild_quest_error', { error: result.error })
    return
  }

  // Broadcast reroll to all guild members
  this.broadcastToGuild(client.session.guild.id, 'guild_quest_rerolled', {
    old_quest_id: payload.quest_id,
    new_quest: result.new_quest,
    rerolled_by: client.session.player.id,
    rerolled_by_username: client.session.player.username,
    new_reroll_status: result.new_reroll_status
  })
}
```

Add the type import:
```typescript
import type { RerollQuestPayload } from '@pokemon-idle/shared'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>Reroll handler exists with permission check and broadcast.</done>
</task>

<task type="auto">
  <name>Task 3: Add history handler</name>
  <files>apps/game-server/src/hub.ts</files>
  <action>
Add the history handler to the message switch statement:

```typescript
case 'get_quest_history':
  this.handleGetQuestHistory(client, payload as GetQuestHistoryPayload)
  break
```

Add the handler method:

```typescript
/**
 * Handle get_quest_history - fetch paginated quest history
 */
private async handleGetQuestHistory(
  client: GameClient,
  payload: GetQuestHistoryPayload
): Promise<void> {
  if (!client.session?.guild) {
    this.send(client, 'guild_quest_error', { error: 'Not in a guild' })
    return
  }

  const page = payload.page || 1
  const limit = Math.min(payload.limit || 20, 50)  // Max 50 per page

  const result = await getQuestHistory(
    client.session.guild.id,
    page,
    limit
  )

  if (!result) {
    this.send(client, 'guild_quest_error', { error: 'Failed to fetch history' })
    return
  }

  this.send(client, 'guild_quest_history', result)
}
```

Add the type import:
```typescript
import type { GetQuestHistoryPayload } from '@pokemon-idle/shared'
```

**Also ensure all db.ts function imports are present:**
```typescript
import {
  getGuildQuests,
  getQuestDetails,
  rerollQuest,
  getQuestHistory,
  // ... existing imports
} from './db'
```
  </action>
  <verify>TypeScript compiles: `cd apps/game-server && npx tsc --noEmit`</verify>
  <done>History handler exists with pagination.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. hub.ts has 4 new case statements: get_guild_quests, get_quest_details, reroll_quest, get_quest_history
2. Each handler follows fire-and-forget pattern
3. Permission checks in place for reroll (leader/officer only)
4. Reroll broadcasts to all guild members
5. TypeScript compiles without errors
</verification>

<success_criteria>
- get_guild_quests returns full quest state with lazy generation
- get_quest_details returns quest with contribution leaderboard
- reroll_quest enforces leader/officer permission and broadcasts
- get_quest_history returns paginated history
- All handlers follow existing error response pattern
- Fire-and-forget pattern maintained in message switch
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-04-SUMMARY.md`
</output>
