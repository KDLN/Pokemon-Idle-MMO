---
phase: 05-guild-quests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/027_guild_quests.sql
autonomous: true

must_haves:
  truths:
    - "Guild has daily quests stored in database that reset at midnight UTC"
    - "Guild has weekly quests stored in database that reset Monday midnight UTC"
    - "Quest progress is tracked per-guild with individual contributions"
    - "Lazy quest generation creates quests on first access after reset"
    - "Quest completion triggers reward deposit to guild bank"
  artifacts:
    - path: "supabase/migrations/027_guild_quests.sql"
      provides: "Quest schema, functions, triggers"
      contains: "guild_quests"
  key_links:
    - from: "generate_daily_quests"
      to: "guild_quests"
      via: "INSERT with ON CONFLICT"
      pattern: "INSERT INTO guild_quests"
    - from: "update_quest_progress"
      to: "guild_bank_currency"
      via: "reward deposit on completion"
      pattern: "deposit_currency"
---

<objective>
Create the complete database schema for guild quests including tables for quests, progress tracking, individual contributions, reroll tracking, and quest history. Implement SECURITY DEFINER functions for lazy quest generation, progress updates, rerolls, and reward distribution.

Purpose: Establish the data foundation for guild quests with proper atomic operations, daily/weekly reset mechanics, and automatic reward distribution.

Output: Migration file 027_guild_quests.sql ready to apply via Supabase Dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-guild-quests/05-CONTEXT.md
@.planning/phases/05-guild-quests/05-RESEARCH.md
@supabase/migrations/026_guild_bank.sql (daily reset pattern, SECURITY DEFINER patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quest tables and enum types</name>
  <files>supabase/migrations/027_guild_quests.sql</files>
  <action>
Create PostgreSQL migration with the following tables and types:

**Enum types:**
- `quest_type` ENUM: 'catch_pokemon', 'catch_type', 'battle', 'evolve'
- `quest_period` ENUM: 'daily', 'weekly'

**Tables:**

1. `guild_quests` - Active quests for each guild
   - id: UUID PRIMARY KEY
   - guild_id: UUID REFERENCES guilds(id) ON DELETE CASCADE
   - quest_type: quest_type NOT NULL
   - period: quest_period NOT NULL
   - target_count: INT NOT NULL (goal amount)
   - current_progress: INT NOT NULL DEFAULT 0
   - reward_currency: INT (nullable, reward amount)
   - reward_guild_points: INT (nullable)
   - reward_item_id: VARCHAR(50) (nullable)
   - reward_item_quantity: INT (nullable)
   - type_filter: VARCHAR(20) (nullable - for catch_type quests, e.g., 'water', 'fire')
   - description: TEXT NOT NULL (human-readable)
   - is_completed: BOOLEAN DEFAULT FALSE
   - completed_at: TIMESTAMPTZ (nullable)
   - quest_date: DATE NOT NULL (for dailies: current date, for weeklies: week start)
   - created_at: TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(guild_id, quest_type, period, quest_date, type_filter) - prevent duplicates

2. `guild_quest_contributions` - Individual member contributions
   - id: UUID PRIMARY KEY
   - quest_id: UUID REFERENCES guild_quests(id) ON DELETE CASCADE
   - player_id: UUID REFERENCES players(id) ON DELETE CASCADE
   - contribution: INT NOT NULL DEFAULT 0
   - last_contributed_at: TIMESTAMPTZ
   - UNIQUE(quest_id, player_id)

3. `guild_quest_rerolls` - Track daily reroll usage
   - guild_id: UUID REFERENCES guilds(id) ON DELETE CASCADE
   - period: quest_period NOT NULL (daily or weekly)
   - rerolls_used: INT DEFAULT 0
   - reset_date: DATE NOT NULL
   - PRIMARY KEY(guild_id, period, reset_date)

4. `guild_quest_history` - Completed quest archive
   - id: UUID PRIMARY KEY
   - guild_id: UUID REFERENCES guilds(id) ON DELETE CASCADE
   - quest_type: quest_type NOT NULL
   - period: quest_period NOT NULL
   - target_count: INT NOT NULL
   - final_progress: INT NOT NULL
   - was_completed: BOOLEAN NOT NULL
   - reward_currency: INT
   - reward_guild_points: INT
   - reward_item_id: VARCHAR(50)
   - reward_item_quantity: INT
   - type_filter: VARCHAR(20)
   - description: TEXT NOT NULL
   - quest_date: DATE NOT NULL
   - archived_at: TIMESTAMPTZ DEFAULT NOW()
   - top_contributors: JSONB (array of {player_id, username, contribution})

5. `guild_activity_stats` - 7-day rolling activity for difficulty scaling
   - guild_id: UUID REFERENCES guilds(id) ON DELETE CASCADE
   - stat_date: DATE NOT NULL
   - total_catches: INT DEFAULT 0
   - total_battles: INT DEFAULT 0
   - total_evolves: INT DEFAULT 0
   - PRIMARY KEY(guild_id, stat_date)

**Indexes:**
- guild_quests(guild_id, quest_date)
- guild_quests(guild_id, period, is_completed)
- guild_quest_contributions(quest_id)
- guild_quest_history(guild_id, archived_at DESC)
- guild_activity_stats(guild_id, stat_date DESC)

**RLS policies:**
- Block all direct mutations on all tables (force use of functions)
- Allow authenticated SELECT on guild_quests, contributions, history for guild members
  </action>
  <verify>Migration file created with all 5 tables, 2 enums, proper indexes and RLS policies.</verify>
  <done>Quest tables exist with proper constraints, indexes, and RLS blocking direct mutations.</done>
</task>

<task type="auto">
  <name>Task 2: Create quest generation and progress functions</name>
  <files>supabase/migrations/027_guild_quests.sql</files>
  <action>
Add SECURITY DEFINER functions to the migration:

**Helper functions:**

1. `get_guild_average_activity(p_guild_id UUID)` RETURNS TABLE
   - Calculate 7-day rolling average of catches, battles, evolves
   - Used for difficulty scaling (target 80% completion rate)
   - Formula: avg_catches * 1.25 for daily, avg_catches * 7 * 1.25 for weekly

2. `calculate_quest_target(p_quest_type quest_type, p_period quest_period, p_avg_activity INT)` RETURNS INT
   - Base targets: catch_pokemon=20, catch_type=10, battle=15, evolve=3
   - Scale by activity (minimum 50% of base, maximum 200%)
   - Weekly = daily * 5 (not 7, to account for varying activity)

3. `calculate_quest_reward(p_quest_type quest_type, p_period quest_period, p_target INT)` RETURNS TABLE
   - Returns reward_currency, reward_guild_points, reward_item_id, reward_item_quantity
   - Base rewards: currency = target * 10, guild_points = target / 2
   - Type-specific quests give 1.5x rewards
   - Weekly = daily rewards * 5
   - 20% chance of bonus item reward (pokeball, potion)

**Core functions:**

4. `generate_daily_quests(p_guild_id UUID)` RETURNS VOID
   - Check if today's quests exist; if yes, return early
   - Archive yesterday's incomplete quests to history
   - Calculate quest count: 3 + (member_count / 10)
   - Use advisory lock to prevent race conditions: pg_advisory_xact_lock(hashtext(p_guild_id::text || 'daily'))
   - Generate diverse quest types (at least one of each type if 4+ quests)
   - For catch_type: randomly pick from ['fire', 'water', 'grass', 'electric', 'normal', 'flying', 'bug', 'poison']
   - Insert quests with ON CONFLICT DO NOTHING

5. `generate_weekly_quests(p_guild_id UUID)` RETURNS VOID
   - Similar to daily but uses date_trunc('week', NOW() AT TIME ZONE 'UTC')
   - Fixed 3 quests per guild
   - Archive last week's incomplete quests
   - Include at least one catch, one battle, one evolve or catch_type

6. `get_guild_quests(p_guild_id UUID)` RETURNS JSON
   - Lazy generation: call generate_daily_quests and generate_weekly_quests
   - Return all active quests with contributions for current player
   - Include reroll counts remaining
   - Format: { daily: Quest[], weekly: Quest[], daily_rerolls_remaining: number, weekly_rerolls_remaining: number, reset_times: { daily: timestamp, weekly: timestamp } }

7. `update_quest_progress(p_guild_id UUID, p_player_id UUID, p_quest_type quest_type, p_amount INT, p_type_filter VARCHAR DEFAULT NULL)` RETURNS TABLE
   - Find matching active quest(s) - could match both catch_pokemon and catch_type
   - Use FOR UPDATE on quest row
   - Increment current_progress by p_amount
   - Upsert contribution record
   - If progress >= target and not completed:
     - Set is_completed = true, completed_at = NOW()
     - Call distribute_quest_rewards
   - Return updated quest(s) for broadcast: quest_id, new_progress, is_completed, milestone (25/50/75/100 or null)

8. `distribute_quest_rewards(p_quest_id UUID)` RETURNS VOID
   - Get quest details
   - Deposit currency to guild bank via bank_deposit_currency (reuse existing)
   - If item reward, deposit item via bank_deposit_item
   - Calculate individual bonuses: proportional to contribution %
   - Insert into player currency (direct, not guild bank): contribution% * (reward_currency * 0.1)
   - Minimum 1 currency for any contribution
  </action>
  <verify>Functions compile without error. Test with: SELECT get_guild_quests('test-guild-id');</verify>
  <done>Quest generation and progress tracking functions exist with lazy generation, atomic updates, and reward distribution.</done>
</task>

<task type="auto">
  <name>Task 3: Create reroll and history functions</name>
  <files>supabase/migrations/027_guild_quests.sql</files>
  <action>
Add remaining SECURITY DEFINER functions:

**Reroll functions:**

1. `reroll_quest(p_guild_id UUID, p_player_id UUID, p_quest_id UUID)` RETURNS JSON
   - Permission check: player must be leader or officer
   - Get quest period
   - Check reroll limit: 2 for daily, 1 for weekly
   - Check guild bank has enough currency: 500 for daily, 2000 for weekly
   - Use FOR UPDATE on quest row
   - Deduct currency from guild bank
   - Increment rerolls_used
   - Delete old quest
   - Generate replacement (different type than deleted)
   - Log the reroll action
   - Return new quest

2. `get_reroll_status(p_guild_id UUID)` RETURNS JSON
   - Return current reroll counts for today/this week
   - Format: { daily_used: N, daily_max: 2, weekly_used: N, weekly_max: 1, daily_cost: 500, weekly_cost: 2000 }

**History functions:**

3. `archive_expired_quests()` RETURNS INT
   - Move incomplete quests past their reset time to history
   - Called by generate functions, no cron needed
   - Return count archived

4. `get_quest_history(p_guild_id UUID, p_page INT DEFAULT 1, p_limit INT DEFAULT 20)` RETURNS JSON
   - Paginated history of completed and expired quests
   - Include top 3 contributors per quest
   - Format: { history: [...], total: N, page: N }

**Activity tracking function:**

5. `record_guild_activity(p_guild_id UUID, p_activity_type VARCHAR, p_amount INT DEFAULT 1)` RETURNS VOID
   - Upsert into guild_activity_stats for today
   - p_activity_type: 'catch', 'battle', 'evolve'
   - Used for difficulty scaling calculation

**Trigger for auto-archive:**

6. Create trigger on quest access that calls archive_expired_quests
   - Actually, handle this in generate functions to avoid complexity
  </action>
  <verify>Functions compile. Test reroll with: SELECT reroll_quest('guild-id', 'player-id', 'quest-id');</verify>
  <done>Reroll system with currency cost, history pagination, and activity recording functions exist.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Migration file exists at supabase/migrations/027_guild_quests.sql
2. File contains 5 tables, 2 enums, proper indexes
3. File contains 10+ SECURITY DEFINER functions
4. RLS policies block direct table mutations
5. Quest generation uses lazy pattern with advisory locks
6. Reward distribution integrates with existing guild bank functions
7. Migration can be applied via Supabase Dashboard SQL Editor
</verification>

<success_criteria>
- Guild quests table stores active quests with type, period, target, progress, rewards
- Contributions tracked per player per quest
- Lazy quest generation on first access after reset
- Daily quests reset at midnight UTC, weekly at Monday midnight UTC
- Quest count scales with guild size (3 + members/10 for daily, 3 fixed for weekly)
- Difficulty scales with 7-day rolling activity average
- Rewards deposit to guild bank on completion
- Individual bonuses proportional to contribution
- Reroll system with currency cost and daily limits
- Quest history archived with top contributors
</success_criteria>

<output>
After completion, create `.planning/phases/05-guild-quests/05-01-SUMMARY.md`
</output>
