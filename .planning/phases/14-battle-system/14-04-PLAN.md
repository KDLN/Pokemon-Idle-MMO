---
phase: 14-battle-system
plan: 04
type: execute
wave: 3
depends_on: ["14-03"]
files_modified:
  - apps/web/src/components/game/EncounterDisplay.tsx
  - apps/web/src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "HP bars animate smoothly as damage is dealt"
    - "Attack animation shows sprite lunge toward defender"
    - "Catch shakes have suspenseful pauses between them"
    - "Each turn animation completes within 800ms budget"
  artifacts:
    - path: "apps/web/src/components/game/EncounterDisplay.tsx"
      provides: "Updated battle display for server-driven animation"
      exports: ["EncounterDisplay"]
    - path: "apps/web/src/app/globals.css"
      provides: "Compressed animation timings for 800ms budget"
      contains: "hp-drain"
  key_links:
    - from: "apps/web/src/components/game/EncounterDisplay.tsx"
      to: "apps/web/src/hooks/useBattleAnimation.ts"
      via: "useBattleAnimation hook"
      pattern: "useBattleAnimation"
---

<objective>
Update visual animations to work with server-driven battles and fit within 800ms per-turn budget.

Purpose: Create satisfying battle feedback with smooth HP drain, attack lunges, and suspenseful catch shakes while staying within timing requirements.

Output: EncounterDisplay uses new animation hook API, CSS animations compressed to 800ms budget, HP bar transitions smoothly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-battle-system/14-CONTEXT.md
@.planning/phases/14-battle-system/14-03-SUMMARY.md
@apps/web/src/components/game/EncounterDisplay.tsx
@apps/web/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compress CSS animation timings for 800ms budget</name>
  <files>apps/web/src/app/globals.css</files>
  <action>
Update animation durations in globals.css to fit within 800ms per-turn budget. Also enhance HP bar transitions and add critical HP pulsing.

Find and update these animations:

1. Update attack-lunge animation to be faster:
```css
@keyframes attack-lunge {
  0% { transform: translateX(0); }
  40% { transform: translateX(30px); }
  100% { transform: translateX(0); }
}

.animate-attack-lunge {
  animation: attack-lunge 0.25s ease-out;  /* Reduced from 0.3s */
}
```

2. Update attack-lunge-wild to match:
```css
.animate-attack-lunge-wild {
  animation: attack-lunge-wild 0.25s ease-out;  /* Reduced from 0.3s */
}
```

3. Add smooth HP transition with color thresholds (add near hp-drain keyframes):
```css
/* HP bar smooth transition */
.hp-bar-fill {
  transition: width 0.4s ease-out, background-color 0.3s ease-out;
}

/* HP bar color thresholds */
.hp-bar-fill.hp-high {
  background: linear-gradient(to right, #4ade80, #22c55e);
}

.hp-bar-fill.hp-medium {
  background: linear-gradient(to right, #facc15, #eab308);
}

.hp-bar-fill.hp-low {
  background: linear-gradient(to right, #f87171, #ef4444);
}

/* Critical HP pulse animation */
@keyframes hp-critical-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.hp-bar-fill.hp-critical {
  animation: hp-critical-pulse 0.5s ease-in-out infinite;
  background: linear-gradient(to right, #dc2626, #b91c1c);
}
```

4. Update damage-flash animation to be faster:
```css
.animate-damage-flash {
  animation: damage-flash 0.15s ease-out 3;  /* Reduced from 0.2s */
}
```

5. Update pokeball-wobble for suspenseful pauses:
```css
@keyframes pokeball-wobble {
  0%, 100% { transform: rotate(0deg) scale(0.7); }
  25% { transform: rotate(-25deg) scale(0.7); }
  75% { transform: rotate(25deg) scale(0.7); }
}

.animate-pokeball-wobble {
  animation: pokeball-wobble 0.6s ease-in-out;  /* Reduced from 0.7s */
}
```

6. Add variable shake timing for suspense (new):
```css
/* Suspenseful shake delays - longer pauses for more tension */
.catch-shake-1 { animation-delay: 0s; }
.catch-shake-2 { animation-delay: 0.7s; }  /* Extra pause before second shake */
.catch-shake-3 { animation-delay: 1.5s; }  /* Longest pause before final shake */
```

7. Update attack-slash timing:
```css
.animate-attack-slash {
  animation: attack-slash 0.3s ease-out;  /* Reduced from 0.4s */
}
```

8. Add screen-shake for critical hits (if not exists):
```css
@keyframes screen-shake-critical {
  0%, 100% { transform: translate(0, 0); }
  10% { transform: translate(-4px, -3px); }
  20% { transform: translate(4px, 3px); }
  30% { transform: translate(-4px, 2px); }
  40% { transform: translate(4px, -2px); }
  50% { transform: translate(-3px, 3px); }
  60% { transform: translate(3px, -3px); }
  70% { transform: translate(-2px, 2px); }
  80% { transform: translate(2px, -2px); }
  90% { transform: translate(-1px, 1px); }
}

.animate-screen-shake-critical {
  animation: screen-shake-critical 0.4s ease-out;
}
```
  </action>
  <verify>Run `npm run dev` in apps/web and verify no CSS errors in browser console</verify>
  <done>Animation durations compressed to fit 800ms budget, HP transitions smooth with color thresholds</done>
</task>

<task type="auto">
  <name>Task 2: Update EncounterDisplay for server-driven animation</name>
  <files>apps/web/src/components/game/EncounterDisplay.tsx</files>
  <action>
Update EncounterDisplay to use the new server-driven useBattleAnimation hook.

Key changes:
1. Remove currentEncounter prop dependency - use activeBattle from hook
2. Use new hook API with wildPokemon and leadPokemon from return
3. Add HP bar color classes based on percentage
4. Add critical hit screen shake
5. Handle waiting states visually

Update the component:

```typescript
'use client'

import { useGameStore } from '@/stores/gameStore'
import { getPokemonSpriteUrl } from '@/types/game'
import { getSpeciesData, cn, getTypeColor } from '@/lib/ui'
import { useBattleAnimation } from '@/hooks/useBattleAnimation'
import { ClassicBattleArena } from '@/components/game/ClassicBattleHud'

// Pokeball component (keep existing)
function Pokeball({ className }: { className?: string }) {
  // ... keep existing implementation
}

// CatchStars component (keep existing)
function CatchStars() {
  // ... keep existing implementation
}

// Helper to get HP bar color class
function getHPColorClass(percent: number): string {
  if (percent <= 20) return 'hp-critical'
  if (percent <= 50) return 'hp-low'
  if (percent <= 75) return 'hp-medium'
  return 'hp-high'
}

export function EncounterDisplay() {
  const currentZone = useGameStore((state) => state.currentZone)
  const clearActiveBattle = useGameStore((state) => state.clearActiveBattle)

  // Use the server-driven battle animation hook
  const battle = useBattleAnimation(clearActiveBattle)

  const isRoute = currentZone?.zone_type === 'route'

  // Idle state when no active battle
  if (battle.phase === 'idle' || !battle.wildPokemon) {
    return (
      <div className="relative rounded-2xl overflow-hidden h-[200px] sm:h-[240px]">
        {/* Background */}
        <div className="absolute inset-0 bg-gradient-to-br from-[#1a1a2e] to-[#0f0f1a]" />

        {/* ... keep existing idle content ... */}

        {isRoute ? (
          <>
            {/* Pokeball waiting indicator */}
            <div className="relative flex flex-col items-center justify-center h-full p-4">
              <div className="relative w-16 h-16 mb-3">
                <div className="absolute inset-0 rounded-full bg-gradient-to-b from-[#EE1515]/20 to-transparent animate-pulse" />
                <Pokeball className="w-full h-full opacity-60" />
              </div>
              <div className="font-pixel text-xs text-white tracking-wider mb-1">
                EXPLORING
              </div>
              <div className="text-[#a0a0c0] text-sm">{currentZone?.name}</div>
              <div className="flex gap-1.5 mt-3">
                {[0, 1, 2].map((i) => (
                  <div
                    key={i}
                    className="w-2 h-2 rounded-full bg-green-400/60 animate-bounce"
                    style={{ animationDelay: `${i * 0.2}s` }}
                  />
                ))}
              </div>
            </div>
          </>
        ) : (
          <>
            {/* Town resting state - keep existing */}
          </>
        )}

        <div className="absolute inset-0 rounded-2xl border-2 border-[#2a2a4a] pointer-events-none" />
      </div>
    )
  }

  // Battle scene
  const wild = battle.wildPokemon
  const lead = battle.leadPokemon
  const wildSpeciesData = getSpeciesData(wild.species_id)
  const leadSpeciesData = lead ? getSpeciesData(lead.species_id) : null
  const speciesName = wild.species?.name || wildSpeciesData.name
  const isShiny = wild.is_shiny || false
  const currentTurn = battle.currentTurn
  const catchSuccess = battle.catchSuccess

  // HP color classes
  const playerHPClass = getHPColorClass(battle.playerHPPercent)
  const wildHPClass = getHPColorClass(battle.wildHPPercent)

  // Build message text
  let messageText = battle.messageText || ''
  if (battle.phase === 'waiting_for_turn') {
    messageText = 'Waiting...'
  } else if (battle.phase === 'waiting_for_catch') {
    messageText = 'Throwing ball...'
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      {/* Backdrop */}
      <div
        className={cn(
          'absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity duration-500',
          battle.phase === 'fade_out' ? 'opacity-0' : 'opacity-100'
        )}
      />

      {/* Battle Arena Container */}
      <div
        className={cn(
          'relative w-full max-w-xl transition-all duration-500',
          battle.phase === 'fade_out' ? 'opacity-0 scale-90' : 'opacity-100 scale-100',
          battle.phase === 'turn_active' && currentTurn?.effectiveness === 'super' && 'animate-screen-shake',
          battle.phase === 'turn_active' && currentTurn?.is_critical && 'animate-screen-shake-critical'
        )}
      >
        {/* Shiny banner */}
        {isShiny && (
          <div className="absolute top-0 left-0 right-0 z-30 bg-gradient-to-r from-yellow-500 via-yellow-400 to-yellow-500 py-2 rounded-t-lg animate-shimmer">
            <div className="flex items-center justify-center gap-2">
              <span className="text-black text-lg">✦</span>
              <span className="font-pixel text-sm text-black tracking-widest">SHINY POKEMON!</span>
              <span className="text-black text-lg">✦</span>
            </div>
          </div>
        )}

        {/* Classic Battle Arena */}
        <ClassicBattleArena
          playerPokemon={{
            name: leadSpeciesData?.name || lead?.name || 'Unknown',
            level: lead?.level || 1,
            currentHp: Math.round((battle.playerHPPercent / 100) * (lead?.max_hp || 100)),
            maxHp: lead?.max_hp || 100,
            sprite: lead ? getPokemonSpriteUrl(lead.species_id, lead.is_shiny, 'back') : '',
            expPercent: 45,
            hpColorClass: playerHPClass,
          }}
          enemyPokemon={{
            name: speciesName,
            level: wild.level,
            currentHp: Math.round((battle.wildHPPercent / 100) * wild.max_hp),
            maxHp: wild.max_hp,
            sprite: getPokemonSpriteUrl(wild.species_id, isShiny),
            hpColorClass: wildHPClass,
          }}
          messageText={messageText}
          showAttackAnimation={
            battle.phase === 'turn_active' && currentTurn
              ? currentTurn.attacker === 'player' ? 'player' : 'enemy'
              : null
          }
          showDamageFlash={
            battle.phase === 'turn_active'
              ? battle.damageTarget === 'player' ? 'player' : 'enemy'
              : null
          }
          showFaint={
            battle.phase === 'battle_end' && battle.wildHP <= 0 ? 'enemy' :
            battle.phase === 'battle_end' && battle.playerHP <= 0 ? 'player' :
            null
          }
          showAttackSlash={
            battle.phase === 'turn_active' && currentTurn
              ? battle.damageTarget === 'player' ? 'player' : 'enemy'
              : null
          }
          showHpDrain={
            battle.phase === 'turn_active'
              ? battle.damageTarget === 'player' ? 'player' : 'enemy'
              : null
          }
        >
          {/* Move type badge in message box */}
          {currentTurn && battle.isInBattle && (
            <div className="classic-move-info">
              <span className="classic-move-name">{currentTurn.move_name}</span>
              <span
                className="classic-move-type"
                style={{ backgroundColor: getTypeColor(currentTurn.move_type) }}
              >
                {currentTurn.move_type}
              </span>
              {currentTurn.is_critical && (
                <span className="text-[#f8c830] font-pixel text-[8px]">CRITICAL HIT!</span>
              )}
            </div>
          )}
        </ClassicBattleArena>

        {/* Overlays */}
        <div className="absolute inset-0 pointer-events-none">
          {/* Pokeball catch animation */}
          {battle.isInCatch && (
            <div className="absolute top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
              <div
                className={cn(
                  battle.phase === 'catch_throw' && 'animate-pokeball-throw',
                  battle.phase === 'catch_shake' && 'animate-pokeball-wobble',
                  battle.phase === 'catch_result' && catchSuccess && 'animate-catch-burst',
                  battle.phase === 'catch_result' && !catchSuccess && 'animate-break-free'
                )}
              >
                <Pokeball />
              </div>
              {battle.phase === 'catch_result' && catchSuccess && <CatchStars />}
            </div>
          )}

          {/* Shake counter during catch */}
          {battle.phase === 'catch_shake' && (
            <div className="absolute top-[55%] left-1/2 -translate-x-1/2 flex gap-2">
              {[1, 2, 3].map((n) => (
                <div
                  key={n}
                  className={cn(
                    'w-3 h-3 rounded-full border-2',
                    n <= battle.currentShake
                      ? 'bg-yellow-400 border-yellow-500'
                      : 'bg-gray-600 border-gray-500'
                  )}
                />
              ))}
            </div>
          )}

          {/* Damage numbers */}
          {battle.showDamageNumber && (
            <div
              className={cn(
                'classic-damage-popup animate-damage-pop',
                battle.isCritical && 'critical'
              )}
              style={{
                top: battle.damageTarget === 'wild' ? '25%' : '55%',
                left: battle.damageTarget === 'wild' ? '70%' : '30%',
              }}
            >
              -{battle.damageAmount}
            </div>
          )}

          {/* Battle result overlay */}
          {battle.phase === 'battle_end' && (
            <div className="absolute top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-30">
              {battle.wildHP <= 0 && battle.canCatch && (
                <div className="px-8 py-4 rounded bg-[#3B4CCA] border-4 border-[#2A3A99] animate-pop-in">
                  <span className="font-pixel text-xl text-white tracking-wider">
                    VICTORY!
                  </span>
                </div>
              )}
              {battle.playerHP <= 0 && (
                <div className="px-8 py-4 rounded bg-[#C03028] border-4 border-[#7D1F1A] animate-pop-in">
                  <span className="font-pixel text-xl text-white tracking-wider">
                    BLACKOUT!
                  </span>
                </div>
              )}
            </div>
          )}

          {/* Catch result overlay */}
          {battle.phase === 'catch_result' && (
            <div className="absolute top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-30">
              {catchSuccess ? (
                <div className="px-8 py-4 rounded bg-[#78C850] border-4 border-[#4E8234] animate-pop-in">
                  <span className="font-pixel text-xl text-white tracking-wider">
                    GOTCHA!
                  </span>
                  {battle.isNewPokedexEntry && (
                    <div className="text-center mt-2 font-pixel text-sm text-yellow-300">
                      Registered to Pokedex!
                    </div>
                  )}
                </div>
              ) : (
                <div className="px-8 py-4 rounded bg-[#F8D030] border-4 border-[#A1871F] animate-pop-in">
                  <span className="font-pixel text-xl text-[#282828] tracking-wider">
                    BROKE FREE!
                  </span>
                </div>
              )}
            </div>
          )}

          {/* Summary overlay (reconnect after timeout) */}
          {battle.phase === 'summary' && (
            <div className="absolute top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-30">
              <div className="px-8 py-4 rounded bg-[#1a1a2e] border-4 border-[#2a2a4a] animate-pop-in max-w-xs text-center">
                <span className="font-pixel text-lg text-white tracking-wide">
                  {battle.messageText}
                </span>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
```

Note: The ClassicBattleArena component may need updates to accept hpColorClass props. If so, add them to the prop interface and apply to HP bar elements.
  </action>
  <verify>
1. Run `cd apps/web && npx tsc --noEmit`
2. Verify EncounterDisplay uses useBattleAnimation with onComplete callback
3. Verify HP color classes are applied
4. Verify critical shake animation is applied
  </verify>
  <done>EncounterDisplay updated for server-driven animation with smooth HP transitions and compressed timings</done>
</task>

</tasks>

<verification>
1. `cd apps/web && npx tsc --noEmit` - Web app compiles
2. CSS animation durations are under 800ms for turn phases
3. HP bar has smooth transition-all duration-400
4. HP bar colors change at thresholds: >50% green, 20-50% yellow, <20% red with pulse
5. Critical hits trigger screen shake
6. Catch sequence shows 3 shake indicators
</verification>

<success_criteria>
- HP bars animate smoothly over 400ms (not instant jumps)
- Attack lunge animation is 250ms (fast, snappy)
- Turn animation total under 800ms (500ms turn_active + buffer)
- Critical hits have distinct screen shake
- Low HP (<20%) shows pulsing red bar
- Catch shakes show visual indicator dots
- New Pokedex entry message displays on first catch
</success_criteria>

<output>
After completion, create `.planning/phases/14-battle-system/14-04-SUMMARY.md`
</output>
