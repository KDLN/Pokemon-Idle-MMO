---
phase: 11-ui-polish
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/web/src/components/game/guild/BankPokemonTab.tsx
  - apps/web/src/components/game/guild/BankLogsTab.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Guild Bank Pokemon display shows sprite image and name (not numeric ID)"
    - "Pokemon can be sorted by date, level, name, species, or grade"
    - "Transaction logs show relative timestamps (2 hours ago) with hover for absolute time"
    - "Transaction logs are filterable by type and player"
  artifacts:
    - path: "apps/web/src/components/game/guild/BankPokemonTab.tsx"
      provides: "Pokemon display with sprites and sorting"
      contains: "getPokemonSpriteUrl"
    - path: "apps/web/src/components/game/guild/BankLogsTab.tsx"
      provides: "Human-readable timestamps"
      contains: "formatRelativeTime"
  key_links:
    - from: "BankPokemonTab.tsx"
      to: "getPokemonSpriteUrl utility"
      via: "import from types/game"
      pattern: "getPokemonSpriteUrl"
    - from: "BankLogsTab.tsx"
      to: "formatRelativeTime utility"
      via: "import from lib/ui"
      pattern: "formatRelativeTime"
---

<objective>
Enhance Guild Bank displays with sprites, sorting, and human-readable timestamps.

Purpose: Make Guild Bank more user-friendly by showing Pokemon visually with sprites and names, adding flexible sorting, and displaying transaction times in relative format.

Output: BankPokemonTab with sprites and sorting, BankLogsTab with relative timestamps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-polish/11-CONTEXT.md
@.planning/phases/11-ui-polish/11-RESEARCH.md
@apps/web/src/components/game/guild/BankPokemonTab.tsx
@apps/web/src/components/game/guild/BankLogsTab.tsx
@apps/web/src/types/game.ts (getPokemonSpriteUrl)
@apps/web/src/lib/ui/index.ts (formatRelativeTime, getSpeciesData)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pokemon sprites and sorting to BankPokemonTab</name>
  <files>apps/web/src/components/game/guild/BankPokemonTab.tsx</files>
  <action>
1. Add imports at top:
```typescript
import { getPokemonSpriteUrl } from '@/types/game'
import { getSpeciesData } from '@/lib/ui'
```

2. Add sorting state and options after existing useState declarations:
```typescript
type SortOption = 'date' | 'level' | 'name' | 'species' | 'grade' | 'ivs'
const [sortBy, setSortBy] = useState<SortOption>('date')
const [sortAsc, setSortAsc] = useState(false)
```

3. Update filteredBankPokemon useMemo to include sorting:
```typescript
const filteredBankPokemon = useMemo(() => {
  if (!guildBank) return []

  let filtered = guildBank.pokemon.filter((p) => {
    if (searchQuery && !p.species_name.toLowerCase().includes(searchQuery.toLowerCase())) {
      return false
    }
    return true
  })

  // Sort the filtered results
  filtered = [...filtered].sort((a, b) => {
    let comparison = 0
    switch (sortBy) {
      case 'date':
        comparison = new Date(b.deposited_at).getTime() - new Date(a.deposited_at).getTime()
        break
      case 'level':
        comparison = b.level - a.level
        break
      case 'name':
        const nameA = (a.nickname || a.species_name).toLowerCase()
        const nameB = (b.nickname || b.species_name).toLowerCase()
        comparison = nameA.localeCompare(nameB)
        break
      case 'species':
        comparison = a.species_name.localeCompare(b.species_name)
        break
      case 'grade':
        comparison = b.point_cost - a.point_cost
        break
      case 'ivs':
        const ivsA = (a.iv_hp || 0) + (a.iv_attack || 0) + (a.iv_defense || 0) + (a.iv_sp_attack || 0) + (a.iv_sp_defense || 0) + (a.iv_speed || 0)
        const ivsB = (b.iv_hp || 0) + (b.iv_attack || 0) + (b.iv_defense || 0) + (b.iv_sp_attack || 0) + (b.iv_sp_defense || 0) + (b.iv_speed || 0)
        comparison = ivsB - ivsA
        break
    }
    return sortAsc ? -comparison : comparison
  })

  return filtered
}, [guildBank, searchQuery, sortBy, sortAsc])
```

4. Add sort controls in the header section (after search input, before view mode toggle):
```tsx
{/* Sort Controls */}
<div className="flex items-center gap-2">
  <select
    value={sortBy}
    onChange={(e) => setSortBy(e.target.value as SortOption)}
    className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white"
  >
    <option value="date">Date</option>
    <option value="level">Level</option>
    <option value="name">Name</option>
    <option value="species">Species</option>
    <option value="grade">Grade</option>
    <option value="ivs">IVs</option>
  </select>
  <button
    onClick={() => setSortAsc(!sortAsc)}
    className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm text-white"
    title={sortAsc ? 'Ascending' : 'Descending'}
  >
    {sortAsc ? '\u2191' : '\u2193'}
  </button>
</div>
```

5. Update grid view to show sprites (~line 163-187):
```tsx
{viewMode === 'grid' && (
  <div className="grid grid-cols-4 gap-2">
    {filteredBankPokemon.map((pokemon) => (
      <button
        key={pokemon.id}
        onClick={() => setSelectedPokemon(pokemon)}
        className={`p-2 rounded-lg text-center transition-colors relative ${
          selectedPokemon?.id === pokemon.id
            ? 'bg-yellow-500/20 border-2 border-yellow-400'
            : 'bg-slate-700 hover:bg-slate-600 border-2 border-transparent'
        }`}
      >
        {pokemon.is_shiny && (
          <span className="absolute top-1 right-1 text-yellow-400 text-xs">*</span>
        )}
        <img
          src={getPokemonSpriteUrl(pokemon.species_id, pokemon.is_shiny)}
          alt={pokemon.nickname || pokemon.species_name}
          className="w-10 h-10 mx-auto pixelated"
        />
        <div className="text-xs text-white truncate">
          {pokemon.nickname || pokemon.species_name}
        </div>
        <div className="text-xs text-slate-400">Lv.{pokemon.level}</div>
        <div className={`text-xs ${getPointColor(pokemon.point_cost)}`}>
          {pokemon.point_cost}pt
        </div>
      </button>
    ))}
  </div>
)}
```

6. Update list view to show sprites (~line 190-218):
```tsx
{viewMode === 'list' && (
  <div className="space-y-1">
    {filteredBankPokemon.map((pokemon) => (
      <button
        key={pokemon.id}
        onClick={() => setSelectedPokemon(pokemon)}
        className={`w-full p-2 rounded flex items-center justify-between ${
          selectedPokemon?.id === pokemon.id
            ? 'bg-yellow-500/20 border border-yellow-400'
            : 'bg-slate-700 hover:bg-slate-600 border border-transparent'
        }`}
      >
        <div className="flex items-center gap-2">
          <img
            src={getPokemonSpriteUrl(pokemon.species_id, pokemon.is_shiny)}
            alt={pokemon.nickname || pokemon.species_name}
            className="w-8 h-8 pixelated"
          />
          {pokemon.is_shiny && <span className="text-yellow-400">*</span>}
          <span className="text-white">{pokemon.nickname || pokemon.species_name}</span>
          <span className="text-slate-400 text-sm">Lv.{pokemon.level}</span>
        </div>
        <div className="flex items-center gap-2">
          <span className={`text-sm ${getPointColor(pokemon.point_cost)}`}>
            {pokemon.point_cost}pt
          </span>
          <span className="text-xs text-slate-500">
            by {pokemon.deposited_by_username || 'Unknown'}
          </span>
        </div>
      </button>
    ))}
  </div>
)}
```

7. Update card view similarly to include sprites (~line 220-250):
```tsx
{viewMode === 'card' && (
  <div className="grid grid-cols-2 gap-3">
    {filteredBankPokemon.map((pokemon) => (
      <button
        key={pokemon.id}
        onClick={() => setSelectedPokemon(pokemon)}
        className={`p-3 rounded-lg text-left transition-colors ${
          selectedPokemon?.id === pokemon.id
            ? 'bg-yellow-500/20 border-2 border-yellow-400'
            : 'bg-slate-700 hover:bg-slate-600 border-2 border-transparent'
        }`}
      >
        <div className="flex items-center gap-2 mb-2">
          <img
            src={getPokemonSpriteUrl(pokemon.species_id, pokemon.is_shiny)}
            alt={pokemon.nickname || pokemon.species_name}
            className="w-10 h-10 pixelated"
          />
          <div className="flex-1 min-w-0">
            <span className="font-medium text-white truncate block">
              {pokemon.is_shiny && <span className="text-yellow-400 mr-1">*</span>}
              {pokemon.nickname || pokemon.species_name}
            </span>
            <span className="text-sm text-slate-400">Level {pokemon.level}</span>
          </div>
          <span className={`text-sm font-bold ${getPointColor(pokemon.point_cost)}`}>
            {pokemon.point_cost}pt
          </span>
        </div>
        <div className="text-xs text-slate-500">
          Deposited by {pokemon.deposited_by_username || 'Unknown'}
        </div>
        <div className="text-xs text-slate-500">
          {new Date(pokemon.deposited_at).toLocaleDateString()}
        </div>
      </button>
    ))}
  </div>
)}
```
  </action>
  <verify>Run `npm run lint` in apps/web. Visually verify sprites load correctly with `npm run dev`</verify>
  <done>BankPokemonTab shows Pokemon sprites, names, and supports sorting by 6 different criteria</done>
</task>

<task type="auto">
  <name>Task 2: Add relative timestamps to BankLogsTab</name>
  <files>apps/web/src/components/game/guild/BankLogsTab.tsx</files>
  <action>
1. Add import for formatRelativeTime:
```typescript
import { formatRelativeTime } from '@/lib/ui'
```

2. Update the timestamp display in the log entries (~line 142):

Change from:
```tsx
<div className="text-xs text-slate-500">
  {new Date(log.created_at).toLocaleString()}
</div>
```

To:
```tsx
<div
  className="text-xs text-slate-500 cursor-help"
  title={new Date(log.created_at).toLocaleString()}
>
  {formatRelativeTime(new Date(log.created_at))}
</div>
```

This provides:
- Relative time display ("2 hours ago", "3d ago")
- Hover tooltip shows full date/time
- cursor-help indicates hoverable element

3. Improve the formatDetails function to be more human-readable (~line 57):

The existing implementation is already good, but ensure it handles edge cases:
```typescript
const formatDetails = (log: typeof logs[0]) => {
  const { details, category } = log
  if (category === 'currency' && details.amount !== undefined) {
    return `${details.amount.toLocaleString()} currency`
  }
  if (category === 'item' && details.item_name) {
    const quantity = details.quantity || 1
    return quantity > 1 ? `${quantity}x ${details.item_name}` : details.item_name
  }
  if (category === 'pokemon' && details.pokemon_name) {
    return `${details.pokemon_name} Lv.${details.pokemon_level || '?'}`
  }
  // Fallback: show raw details in readable format
  return Object.entries(details)
    .map(([key, value]) => `${key}: ${value}`)
    .join(', ')
}
```

4. Add visual differentiation for action types with icons (enhance existing display):

Update the log entry rendering to use colored icons:
```tsx
{logs.map((log) => (
  <div
    key={log.id}
    className="bg-slate-700/50 rounded-lg p-3 flex items-center justify-between"
  >
    <div className="flex items-center gap-3">
      <span className={`w-6 h-6 rounded flex items-center justify-center text-xs ${
        log.action === 'deposit' ? 'bg-green-500/20 text-green-400' :
        log.action === 'withdraw' ? 'bg-orange-500/20 text-orange-400' :
        log.action === 'request_created' ? 'bg-blue-500/20 text-blue-400' :
        log.action === 'request_fulfilled' ? 'bg-purple-500/20 text-purple-400' :
        'bg-slate-600 text-slate-300'
      }`}>
        {log.action === 'deposit' ? '\u2B07' :
         log.action === 'withdraw' ? '\u2B06' :
         log.action === 'request_created' ? '\u2753' :
         log.action === 'request_fulfilled' ? '\u2714' :
         log.action === 'request_expired' ? '\u23F0' :
         log.action === 'request_cancelled' ? '\u2716' :
         CATEGORY_ICONS[log.category]}
      </span>
      <div>
        <div className="flex items-center gap-2">
          <span className="text-white font-medium">{log.player_username}</span>
          <span className={ACTION_COLORS[log.action]}>
            {ACTION_LABELS[log.action]}
          </span>
        </div>
        <div className="text-sm text-slate-400">
          {formatDetails(log)}
          {log.balance_after !== null && (
            <span className="text-slate-500 ml-2">
              (Balance: {log.balance_after.toLocaleString()})
            </span>
          )}
        </div>
      </div>
    </div>
    <div
      className="text-xs text-slate-500 cursor-help flex-shrink-0"
      title={new Date(log.created_at).toLocaleString()}
    >
      {formatRelativeTime(new Date(log.created_at))}
    </div>
  </div>
))}
```
  </action>
  <verify>Run `npm run lint` in apps/web. Test hover behavior shows absolute timestamp</verify>
  <done>BankLogsTab shows relative timestamps with hover tooltips, action-specific icons with colors</done>
</task>

</tasks>

<verification>
- [ ] BankPokemonTab imports getPokemonSpriteUrl and getSpeciesData
- [ ] Pokemon sprites display in grid, list, and card views
- [ ] Sort dropdown with 6 options (date, level, name, species, grade, IVs)
- [ ] Sort direction toggle button works
- [ ] BankLogsTab imports formatRelativeTime
- [ ] Timestamps show relative format ("2 hours ago")
- [ ] Hover on timestamp shows full date/time
- [ ] Action icons are color-coded (green deposit, orange withdraw, etc.)
- [ ] `npm run lint` passes in apps/web
</verification>

<success_criteria>
- Guild Bank Pokemon display shows sprites with names (not numeric IDs)
- 6 sorting options work correctly with ascending/descending toggle
- Transaction logs show relative timestamps with hover tooltips
- Action types have distinct colored icons
- No lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-polish/11-04-SUMMARY.md`
</output>
