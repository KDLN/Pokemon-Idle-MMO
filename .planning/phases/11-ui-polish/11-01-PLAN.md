---
phase: 11-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/032_zone_directions.sql
  - packages/shared/src/types/core.ts
  - apps/game-server/src/db.ts
  - apps/game-server/src/types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Zone connections have direction data in database"
    - "Connected zones returned by getConnectedZones include direction field"
    - "Zone interface includes optional direction property"
  artifacts:
    - path: "supabase/migrations/032_zone_directions.sql"
      provides: "Direction column and backfill data"
      contains: "ALTER TABLE zone_connections"
    - path: "packages/shared/src/types/core.ts"
      provides: "Updated Zone interface"
      contains: "direction?"
    - path: "apps/game-server/src/db.ts"
      provides: "Updated getConnectedZones query"
      contains: "direction"
  key_links:
    - from: "apps/game-server/src/db.ts"
      to: "zone_connections.direction"
      via: "Supabase select query"
      pattern: "select.*direction"
---

<objective>
Add direction data to zone connections for navigation ordering.

Purpose: Enable frontend to sort travel buttons by compass direction (N/E/S/W), making navigation intuitive based on geographic context.

Output: Migration file, updated types, updated database query returning direction with connected zones.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-ui-polish/11-CONTEXT.md
@.planning/phases/11-ui-polish/11-RESEARCH.md
@supabase/migrations/001_initial_schema.sql (zone_connections table structure)
@packages/shared/src/types/core.ts (Zone interface)
@apps/game-server/src/db.ts (getConnectedZones function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for direction column</name>
  <files>supabase/migrations/032_zone_directions.sql</files>
  <action>
Create migration file that:

1. Adds direction column to zone_connections:
```sql
ALTER TABLE zone_connections
ADD COLUMN direction TEXT;
```

2. Backfills existing connections with directions based on Kanto geography:
- Pallet Town (1) <-> Route 1 (2): N/S
- Route 1 (2) <-> Viridian City (3): N/S
- Viridian City (3) <-> Route 2 (4): N/S
- Viridian City (3) <-> Route 22 (5): W/E
- Route 2 (4) <-> Viridian Forest (6): N/S
- Viridian Forest (6) <-> Pewter City (7): N/S (Route 2 North)
- Pewter City (7) <-> Route 3 (8): E/W
- Route 3 (8) <-> Mt. Moon (9): E/W
- Mt. Moon (9) <-> Route 4 (10): E/W
- Route 4 (10) <-> Cerulean City (11): E/W
- Route 22 (5) <-> Pokemon League (12): W/E

Use UPDATE statements for each connection pair. Directions are from the perspective of the `from_zone_id`.

Note: Some zones may have been added in later migrations (check zone IDs in seed_data and subsequent migrations). If uncertain about a zone ID, omit that update - missing directions won't break the feature (falls back to no arrow).
  </action>
  <verify>Run `cat supabase/migrations/032_zone_directions.sql` to verify SQL syntax is valid</verify>
  <done>Migration file exists with ALTER TABLE and UPDATE statements for known zone connections</done>
</task>

<task type="auto">
  <name>Task 2: Update Zone interface and database query</name>
  <files>packages/shared/src/types/core.ts, apps/game-server/src/db.ts, apps/game-server/src/types.ts</files>
  <action>
1. In `packages/shared/src/types/core.ts`, add direction to Zone interface:
```typescript
export interface Zone {
  id: number
  name: string
  zone_type: 'town' | 'route'
  base_encounter_rate: number
  min_level: number
  max_level: number
  direction?: string  // N, S, E, W, NE, SE, SW, NW - from zone_connections
}
```

2. In `apps/game-server/src/types.ts`, if Zone is re-exported or defined there, update similarly.

3. In `apps/game-server/src/db.ts`, modify `getConnectedZones` to include direction:

Current implementation fetches to_zone_id then fetches zones. Change to:
```typescript
export async function getConnectedZones(zoneId: number): Promise<Zone[]> {
  const { data, error } = await supabase
    .from('zone_connections')
    .select('to_zone_id, direction')
    .eq('from_zone_id', zoneId)

  if (error || !data) return []

  const zoneIds = data.map(c => c.to_zone_id)
  const { data: zones } = await supabase
    .from('zones')
    .select('*')
    .in('id', zoneIds)

  // Merge direction into zone objects
  return (zones || []).map(zone => {
    const connection = data.find(c => c.to_zone_id === zone.id)
    return {
      ...zone,
      direction: connection?.direction || undefined
    }
  })
}
```

This approach:
- Fetches both to_zone_id and direction from zone_connections
- Then fetches zone details
- Merges direction into the zone objects before returning
  </action>
  <verify>Run `npm run build` in apps/game-server to verify TypeScript compiles without errors</verify>
  <done>Zone interface has direction field, getConnectedZones returns zones with direction populated</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/032_zone_directions.sql
- [ ] Zone interface in packages/shared/src/types/core.ts includes `direction?: string`
- [ ] getConnectedZones in apps/game-server/src/db.ts selects and returns direction
- [ ] Game server builds successfully (`cd apps/game-server && npm run build`)
</verification>

<success_criteria>
- Migration file creates direction column and backfills Kanto zone connections
- Zone type includes optional direction field
- Database query returns direction with connected zones
- No TypeScript errors in game-server build
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-polish/11-01-SUMMARY.md`
</output>
