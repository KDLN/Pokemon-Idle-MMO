---
phase: 11-ui-polish
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/web/src/components/game/BoostCard.tsx
  - apps/web/src/components/game/GameShell.tsx
  - apps/web/src/components/game/BoostExpiredToast.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Active boosts display in Boosts panel with name and countdown timer"
    - "Timer shows MM:SS format and updates every second"
    - "Timer turns red and pulses when under 1 minute remaining"
    - "Effect description expands on click"
    - "Empty state shows prompt message when no boosts active"
    - "Toast notification appears when boost expires"
  artifacts:
    - path: "apps/web/src/components/game/BoostCard.tsx"
      provides: "Active boost card component"
      contains: "formatCountdown"
    - path: "apps/web/src/components/game/BoostExpiredToast.tsx"
      provides: "Boost expiry notification"
      contains: "expired"
    - path: "apps/web/src/components/game/GameShell.tsx"
      provides: "Integration with guildActiveBuffs"
      contains: "BoostCard"
  key_links:
    - from: "GameShell.tsx PartyColumn"
      to: "guildActiveBuffs store"
      via: "useGameStore selector"
      pattern: "guildActiveBuffs"
    - from: "BoostCard.tsx"
      to: "ends_at timestamp"
      via: "useEffect interval"
      pattern: "setInterval"
---

<objective>
Create active boosts display with countdown timers.

Purpose: Show players their active guild boosts with real-time countdown timers, urgency indicators, and expiry notifications.

Output: BoostCard component, BoostExpiredToast component, integration in GameShell's Boosts panel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-polish/11-CONTEXT.md
@.planning/phases/11-ui-polish/11-RESEARCH.md
@apps/web/src/components/game/GameShell.tsx
@apps/web/src/components/game/LevelUpToast.tsx (toast pattern reference)
@apps/web/src/stores/gameStore.ts (guildActiveBuffs state)
@packages/shared/src/types/guild.ts (GuildBuff, ActiveGuildBuffs types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BoostCard component</name>
  <files>apps/web/src/components/game/BoostCard.tsx</files>
  <action>
Create new file `apps/web/src/components/game/BoostCard.tsx`:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { cn } from '@/lib/ui/cn'
import type { GuildBuff } from '@pokemon-idle/shared'

// Buff type display names and descriptions
const BUFF_DISPLAY: Record<string, { name: string; description: string; icon: string }> = {
  xp_bonus: {
    name: 'XP Boost',
    description: 'Increases experience points gained from battles',
    icon: '\u2B50'  // star
  },
  catch_rate: {
    name: 'Catch Rate Boost',
    description: 'Increases the chance of catching wild Pokemon',
    icon: '\uD83C\uDFAF'  // target
  },
  encounter_rate: {
    name: 'Encounter Boost',
    description: 'Increases the rate of wild Pokemon encounters',
    icon: '\uD83D\uDC3E'  // paw prints
  }
}

interface BoostCardProps {
  buff: GuildBuff
  onExpire?: () => void
}

function formatCountdown(endTime: Date): { text: string; isUrgent: boolean } {
  const remainingMs = endTime.getTime() - Date.now()
  if (remainingMs <= 0) return { text: '0:00', isUrgent: true }

  const totalSeconds = Math.floor(remainingMs / 1000)
  const hours = Math.floor(totalSeconds / 3600)
  const minutes = Math.floor((totalSeconds % 3600) / 60)
  const seconds = totalSeconds % 60

  const isUrgent = remainingMs < 60000 // Under 1 minute

  if (hours > 0) {
    return {
      text: `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
      isUrgent
    }
  }

  return {
    text: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    isUrgent
  }
}

export function BoostCard({ buff, onExpire }: BoostCardProps) {
  const [countdown, setCountdown] = useState(() => formatCountdown(new Date(buff.ends_at)))
  const [isExpanded, setIsExpanded] = useState(false)
  const [hasExpired, setHasExpired] = useState(false)

  const display = BUFF_DISPLAY[buff.buff_type] || {
    name: buff.buff_type,
    description: 'Guild boost active',
    icon: '\u26A1'  // lightning
  }

  const multiplierPercent = Math.round((buff.multiplier - 1) * 100)

  useEffect(() => {
    const update = () => {
      const endTime = new Date(buff.ends_at)
      const remaining = endTime.getTime() - Date.now()

      if (remaining <= 0 && !hasExpired) {
        setHasExpired(true)
        onExpire?.()
        return
      }

      setCountdown(formatCountdown(endTime))
    }

    update()
    const interval = setInterval(update, 1000)
    return () => clearInterval(interval)
  }, [buff.ends_at, onExpire, hasExpired])

  if (hasExpired) return null

  return (
    <div
      className={cn(
        "p-3 rounded-xl border transition-all duration-300",
        countdown.isUrgent
          ? "border-red-500/50 bg-red-500/10"
          : "border-[#2a2a4a] bg-[#1a1a2e]/80"
      )}
    >
      <div className="flex items-center justify-between gap-2">
        <div className="flex items-center gap-2 min-w-0">
          <span className="text-lg flex-shrink-0">{display.icon}</span>
          <div className="min-w-0">
            <span className="text-white font-medium text-sm truncate block">
              {display.name}
            </span>
            <span className="text-xs text-green-400">+{multiplierPercent}%</span>
          </div>
        </div>
        <span
          className={cn(
            "font-mono text-sm flex-shrink-0",
            countdown.isUrgent ? "text-red-400 animate-pulse" : "text-[#FFDE00]"
          )}
        >
          {countdown.text}
        </span>
      </div>

      {isExpanded && (
        <p className="text-xs text-[#a0a0c0] mt-2 pt-2 border-t border-[#2a2a4a]">
          {display.description}
          {buff.purchased_by_username && (
            <span className="block mt-1 text-[#606080]">
              Purchased by {buff.purchased_by_username}
            </span>
          )}
        </p>
      )}

      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="text-xs text-[#606080] hover:text-[#a0a0c0] mt-2 transition-colors"
      >
        {isExpanded ? 'Hide details' : 'Show details'}
      </button>
    </div>
  )
}
```

Key implementation details:
- Timer updates every second via useEffect interval
- Cleanup on unmount prevents memory leaks
- `isUrgent` triggers red styling and pulse animation when under 1 minute
- Expandable description section
- Shows multiplier as percentage (+10%)
- Handles both HH:MM:SS and MM:SS formats based on remaining time
  </action>
  <verify>Run `npm run lint` in apps/web to check for TypeScript/ESLint errors</verify>
  <done>BoostCard.tsx exists with countdown timer, urgency state, expandable description</done>
</task>

<task type="auto">
  <name>Task 2: Create BoostExpiredToast and integrate boosts in GameShell</name>
  <files>apps/web/src/components/game/BoostExpiredToast.tsx, apps/web/src/components/game/GameShell.tsx</files>
  <action>
1. Create `apps/web/src/components/game/BoostExpiredToast.tsx`:

```typescript
'use client'

import { useEffect } from 'react'
import { useGameStore } from '@/stores/gameStore'
import type { GuildBuffType } from '@pokemon-idle/shared'

const BUFF_NAMES: Record<GuildBuffType, string> = {
  xp_bonus: 'XP Boost',
  catch_rate: 'Catch Rate Boost',
  encounter_rate: 'Encounter Boost'
}

export function BoostExpiredToast() {
  const expiredBoosts = useGameStore((state) => state.expiredBoosts)
  const clearExpiredBoosts = useGameStore((state) => state.clearExpiredBoosts)

  useEffect(() => {
    if (expiredBoosts.length > 0) {
      const timer = setTimeout(() => {
        clearExpiredBoosts()
      }, 4000)

      return () => clearTimeout(timer)
    }
  }, [expiredBoosts, clearExpiredBoosts])

  if (expiredBoosts.length === 0) return null

  return (
    <div className="fixed top-16 sm:top-20 right-3 sm:right-4 z-50 flex flex-col gap-2 sm:w-72">
      {expiredBoosts.map((buffType, index) => (
        <div
          key={`${buffType}-${index}`}
          className="relative overflow-hidden rounded-xl animate-slide-in"
          style={{ animationDelay: `${index * 0.1}s` }}
        >
          {/* Background with red gradient */}
          <div className="absolute inset-0 bg-gradient-to-r from-red-500/80 via-red-600/80 to-red-500/80" />

          {/* Dark inner panel */}
          <div className="relative m-0.5 rounded-[10px] bg-gradient-to-br from-[#1a1a2e] to-[#0f0f1a] px-4 py-3">
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 rounded-full bg-red-500/20 border border-red-500/30 flex items-center justify-center flex-shrink-0">
                <span className="text-red-400">\u23F0</span>
              </div>
              <div className="flex-1 min-w-0">
                <div className="font-pixel text-xs text-red-400 tracking-wider">
                  BOOST EXPIRED
                </div>
                <div className="text-white text-sm truncate">
                  {BUFF_NAMES[buffType] || buffType}
                </div>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  )
}
```

2. Add to gameStore.ts - add these to the store interface and implementation:

In the store interface section (~line 96), add:
```typescript
// Expired boosts for toast notification
expiredBoosts: GuildBuffType[]
addExpiredBoost: (buffType: GuildBuffType) => void
clearExpiredBoosts: () => void
```

In the store implementation section (~line 500), add:
```typescript
expiredBoosts: [] as GuildBuffType[],
```

In the actions section, add:
```typescript
addExpiredBoost: (buffType) => set((state) => ({
  expiredBoosts: [...state.expiredBoosts, buffType]
})),
clearExpiredBoosts: () => set({ expiredBoosts: [] }),
```

3. Update GameShell.tsx PartyColumn buffs section:

Add imports at top:
```typescript
import { BoostCard } from './BoostCard'
import { BoostExpiredToast } from './BoostExpiredToast'
import type { GuildBuffType } from '@pokemon-idle/shared'
```

In PartyColumn component, add store access:
```typescript
const guildActiveBuffs = useGameStore((state) => state.guildActiveBuffs)
const addExpiredBoost = useGameStore((state) => state.addExpiredBoost)
const clearExpiredBuff = useGameStore((state) => state.clearExpiredBuff)
```

Replace the buffs-section content (keeping the header):
```tsx
<div className="buffs-section">
  <div className="buffs-header">
    <span>\u26A1</span>
    <span className="buffs-title">Boosts</span>
  </div>
  <div className="buffs-list">
    {guildActiveBuffs && (
      <>
        {guildActiveBuffs.xp_bonus && (
          <BoostCard
            key="xp_bonus"
            buff={guildActiveBuffs.xp_bonus}
            onExpire={() => {
              addExpiredBoost('xp_bonus')
              clearExpiredBuff('xp_bonus')
            }}
          />
        )}
        {guildActiveBuffs.catch_rate && (
          <BoostCard
            key="catch_rate"
            buff={guildActiveBuffs.catch_rate}
            onExpire={() => {
              addExpiredBoost('catch_rate')
              clearExpiredBuff('catch_rate')
            }}
          />
        )}
        {guildActiveBuffs.encounter_rate && (
          <BoostCard
            key="encounter_rate"
            buff={guildActiveBuffs.encounter_rate}
            onExpire={() => {
              addExpiredBoost('encounter_rate')
              clearExpiredBuff('encounter_rate')
            }}
          />
        )}
      </>
    )}
    {(!guildActiveBuffs || (!guildActiveBuffs.xp_bonus && !guildActiveBuffs.catch_rate && !guildActiveBuffs.encounter_rate)) && (
      <div className="text-xs text-[#606080] text-center py-4">
        Use a boost from your guild shop to enhance your training!
      </div>
    )}
  </div>
</div>
```

4. Add BoostExpiredToast to GameShell render (near LevelUpToast):
```tsx
<BoostExpiredToast />
```

5. Remove AVAILABLE_BUFFS constant and old PowerUp/Boost interface (no longer needed).
  </action>
  <verify>Run `npm run lint` and `npm run build` in apps/web to verify no errors</verify>
  <done>BoostExpiredToast exists, GameShell shows active boosts from store with live timers and expiry toasts</done>
</task>

</tasks>

<verification>
- [ ] BoostCard.tsx exists with countdown timer implementation
- [ ] BoostExpiredToast.tsx exists following LevelUpToast pattern
- [ ] gameStore.ts has expiredBoosts state and actions
- [ ] GameShell.tsx imports and renders BoostCard components
- [ ] Empty state message shows when no boosts active
- [ ] Timer updates every second (verify in browser)
- [ ] `npm run build` passes in apps/web
</verification>

<success_criteria>
- Active boosts display with countdown timers in Boosts panel
- Timers show MM:SS format (or HH:MM:SS for longer durations)
- Timer turns red and pulses when under 1 minute
- Effect description expands on click
- Empty state shows "Use a boost from your guild shop..." message
- Toast notification appears when boost expires
- No build or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-polish/11-03-SUMMARY.md`
</output>
