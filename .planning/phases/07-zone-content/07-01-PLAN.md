---
phase: 07-zone-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/030_cerulean_city.sql
autonomous: true

must_haves:
  truths:
    - "Player can navigate from Route 4 to Cerulean City"
    - "Player can navigate from Cerulean City to Route 24"
    - "Player can navigate from Route 24 to Route 25"
    - "Player can encounter Bellsprout, Oddish, Abra, Slowpoke, Venonat, Pidgey on Routes 24-25"
    - "Player can battle Misty after obtaining Boulder Badge"
    - "Defeating Misty awards Cascade Badge"
  artifacts:
    - path: "supabase/migrations/030_cerulean_city.sql"
      provides: "Zone data, connections, encounters, gym leader"
      min_lines: 80
      contains: "Cerulean City"
  key_links:
    - from: "zones table"
      to: "zone_connections table"
      via: "bidirectional from/to zone IDs"
      pattern: "zone_id = 12.*zone_id = 13"
    - from: "zones table"
      to: "encounter_tables"
      via: "zone_id foreign key"
      pattern: "zone_id, species_id, encounter_rate"
    - from: "gym_leaders table"
      to: "Cerulean City zone"
      via: "zone_id = 12"
      pattern: "misty.*zone_id.*12"
---

<objective>
Create SQL migration to add Cerulean City, Misty's Gym, Route 24 (Nugget Bridge), and Route 25 (Bill's House area) to expand the game world.

Purpose: Provide new exploration content beyond Mt. Moon, enabling Gen 1 progression toward Cerulean City as the second major town.

Output: Single migration file (030_cerulean_city.sql) adding 3 zones, 6 bidirectional connections, 2 encounter tables, and 1 gym leader with team.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-zone-content/07-RESEARCH.md

# Pattern references (read these before implementing)
@supabase/migrations/016_route_3.sql
@supabase/migrations/020_week6_leaderboards_route4.sql
@supabase/migrations/005_gym_leaders.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create zone migration with all content</name>
  <files>supabase/migrations/030_cerulean_city.sql</files>
  <action>
Create migration file following established patterns from 016_route_3.sql and 020_week6_leaderboards_route4.sql.

Structure the migration in these sections:

**1. ZONES (3 zones):**
- ID 12: Cerulean City (town, encounter_rate 0.0000, levels 1-1)
- ID 13: Route 24 (route, encounter_rate 0.0333, levels 16-20)
- ID 14: Route 25 (route, encounter_rate 0.0333, levels 16-20)
- Use `ON CONFLICT (id) DO NOTHING` for idempotency
- Call `setval('zones_id_seq', GREATEST(14, (SELECT MAX(id) FROM zones)), true)`

**2. ZONE CONNECTIONS (6 rows, bidirectional):**
- Route 4 (11) <-> Cerulean City (12)
- Cerulean City (12) <-> Route 24 (13)
- Route 24 (13) <-> Route 25 (14)
- Use `ON CONFLICT DO NOTHING`

**3. MISTY'S GYM:**
Insert into gym_leaders:
- id: 'misty'
- name: 'Misty'
- title: 'The Tomboyish Mermaid'
- badge_id: 'cascade'
- badge_name: 'Cascade Badge'
- specialty_type: 'Water'
- zone_id: 12
- dialog_intro: 'Hi, you''re a new face. Let me tell you, my policy is an all-out offensive with Water-type Pokemon!'
- dialog_win: 'Wow! You''re too much, all right! You can have the Cascade Badge to show that you beat me.'
- dialog_lose: 'That was too close! You''ll need stronger Pokemon to beat me!'
- reward_money: 2100
- reward_badge_points: 100
- required_badges: '{boulder}'

Insert into gym_leader_pokemon:
- Slot 1: Staryu (species_id 120), level 18
- Slot 2: Starmie (species_id 121), level 21
- Use `ON CONFLICT ... DO UPDATE` pattern from 005_gym_leaders.sql

**4. ENCOUNTER TABLES:**
Route 24 (zone_id 13) - rates MUST sum to 1.0:
- Bellsprout (69): 0.20
- Oddish (43): 0.20
- Venonat (48): 0.20
- Slowpoke (79): 0.15
- Pidgey (16): 0.15
- Abra (63): 0.10 (rare)

Route 25 (zone_id 14) - same distribution as Route 24:
- Bellsprout (69): 0.20
- Oddish (43): 0.20
- Venonat (48): 0.20
- Slowpoke (79): 0.15
- Pidgey (16): 0.15
- Abra (63): 0.10 (rare)

Use `ON CONFLICT DO NOTHING`

**5. VERIFICATION QUERIES (commented):**
Add commented SELECT queries at the end to verify:
- Zones exist with correct properties
- Zone connections are bidirectional
- Encounter rates sum to 1.0 for each zone
- Misty exists with correct zone_id and required_badges
  </action>
  <verify>
Verify migration syntax is valid:
- All SQL statements end with semicolons
- String escaping uses '' for apostrophes
- All referenced species_id values exist (16, 43, 48, 63, 69, 79, 120, 121)
- Encounter rates sum to exactly 1.0 for both Route 24 and Route 25
- Zone IDs are sequential (12, 13, 14)
  </verify>
  <done>
Migration file exists at supabase/migrations/030_cerulean_city.sql with:
- 3 zones (Cerulean City, Route 24, Route 25)
- 6 zone connections (bidirectional)
- 1 gym leader (Misty) with required_badges = '{boulder}'
- 2 gym leader Pokemon (Staryu Lv18, Starmie Lv21)
- 12 encounter table rows (6 per route, summing to 1.0 each)
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate migration content</name>
  <files>supabase/migrations/030_cerulean_city.sql</files>
  <action>
Read the created migration and verify:

1. **Encounter rate validation:**
   - Route 24: 0.20 + 0.20 + 0.20 + 0.15 + 0.15 + 0.10 = 1.00
   - Route 25: 0.20 + 0.20 + 0.20 + 0.15 + 0.15 + 0.10 = 1.00

2. **Zone connection validation:**
   - Count should be 6 rows (3 bidirectional pairs)
   - (11,12), (12,11), (12,13), (13,12), (13,14), (14,13)

3. **Gym leader validation:**
   - Misty has required_badges = '{boulder}' (requires Boulder Badge)
   - zone_id = 12 (Cerulean City)

4. **Species ID validation:**
   All these species exist in 015_evolution_data.sql:
   - 16 (Pidgey), 43 (Oddish), 48 (Venonat), 63 (Abra)
   - 69 (Bellsprout), 79 (Slowpoke), 120 (Staryu), 121 (Starmie)

If any issues found, fix them in the migration file.
  </action>
  <verify>
All validation checks pass:
- Encounter rates sum to 1.0
- Bidirectional connections present
- Misty requires Boulder Badge
- All species IDs are valid Gen 1 Pokemon
  </verify>
  <done>
Migration validated - no errors, ready for deployment to Supabase.
  </done>
</task>

</tasks>

<verification>
**Migration verification checklist:**
- [ ] File exists: supabase/migrations/030_cerulean_city.sql
- [ ] Contains 3 zone INSERT statements (IDs 12, 13, 14)
- [ ] Contains setval for zones_id_seq
- [ ] Contains 6 zone_connections INSERT rows
- [ ] Contains gym_leaders INSERT for Misty with zone_id=12
- [ ] Contains gym_leader_pokemon INSERT for Staryu and Starmie
- [ ] Contains 12 encounter_tables INSERT rows (6 per route)
- [ ] Route 24 encounter rates sum to 1.0
- [ ] Route 25 encounter rates sum to 1.0
- [ ] All encounter species are valid (16, 43, 48, 63, 69, 79)
- [ ] Misty has required_badges = '{boulder}'
</verification>

<success_criteria>
Phase 7 requirements satisfied:
- ZONE-01: Cerulean City zone exists (town, connected to Route 4 and Route 24)
- ZONE-02: Misty's Gym exists in Cerulean City (Water-type, Cascade Badge, requires Boulder Badge)
- ZONE-03: Route 24 zone exists (Nugget Bridge, north of Cerulean)
- ZONE-04: Route 25 zone exists (Bill's House area, east of Route 24)
- ZONE-05: Routes 24-25 encounter tables include all required Pokemon
</success_criteria>

<output>
After completion, create `.planning/phases/07-zone-content/07-01-SUMMARY.md`
</output>
